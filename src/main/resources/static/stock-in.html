<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 智能入库</title>
    <link rel="stylesheet" href="/css/tailwind.css" />
    <script>
      // 若本地文件未找到则提示
      (function(){
        var testEl = document.createElement('div');
        testEl.className='hidden';
        document.head.appendChild(testEl);
        var style = window.getComputedStyle(testEl);
        if(!style){console.warn('Tailwind 检测失败');}
      })();
    </script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex">
<!-- 注入统一导航（侧边栏 + 顶部） -->
<div id="common-nav" data-active="stock-in"></div>

<main class="flex-1 flex flex-col pt-16">
    <!-- 可滚动内容区 -->
    <div class="main-content">
        <!-- 页面标题与操作按钮 -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h2 class="text-[clamp(1.25rem,2vw,1.75rem)] font-bold">智能入库</h2>
                <p class="text-gray-500">管理药品采购与入库操作</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline" id="import-data">
                    <i class="fa fa-upload"></i> 批量导入
                </button>
                <button class="btn btn-primary" id="new-stock">
                    <i class="fa fa-plus"></i> 新建入库单
                </button>
            </div>
        </div>

        <!-- 智能建议区 -->
        <div class="card p-4 mb-6 smart-suggestion">
            <div class="flex items-center gap-2 mb-2">
                <i class="fa fa-lightbulb-o text-blue-500"></i>
                <h3 class="font-medium">操作提示</h3>
            </div>
            <div class="flex flex-wrap gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="badge badge-success">提示</span>
                    <span>请确保所有药品信息准确无误，特别是批准文号和有效期</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge badge-warning">注意</span>
                    <span>药品批号格式：B+年月日+三位随机数，如B241215001</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge badge-success">建议</span>
                    <span>入库前请仔细核对药品信息与实物是否一致</span>
                </div>
            </div>
        </div>

        <!-- 入库流程指示器 -->
        <div class="card p-4 mb-6">
            <div class="flex items-center justify-between max-w-3xl mx-auto">
                <div class="flex flex-col items-center gap-2">
                    <div class="step-indicator completed">
                        <i class="fa fa-check"></i>
                    </div>
                    <span class="text-sm">创建入库单</span>
                </div>
                <div class="h-1 w-16 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <div class="step-indicator active">
                        2
                    </div>
                    <span class="text-sm">添加药品</span>
                </div>
                <div class="h-1 w-16 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <div class="step-indicator">
                        3
                    </div>
                    <span class="text-sm">确认信息</span>
                </div>
                <div class="h-1 w-16 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <div class="step-indicator">
                        4
                    </div>
                    <span class="text-sm">完成入库</span>
                </div>
            </div>
        </div>

        <!-- 入库单信息 -->
        <div class="card p-6 mb-6">
            <h3 class="font-bold mb-4">入库单信息</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">机构名称</label>
                    <div class="flex gap-2">
                      <input type="text" class="input flex-1" id="org-name" list="org-name-options" value="淮安仁智堂大药房有限公司" placeholder="请输入机构名称">
                      <button type="button" class="btn btn-outline text-xs" id="toggle-org-edit"><i class="fa fa-pencil"></i> 编辑</button>
                    </div>
                    <datalist id="org-name-options">
                      <option value="淮安仁智堂大药房有限公司"></option>
                      <option value="淮安仁智堂大药房分店"></option>
                    </datalist>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">随货单号</label>
                    <input type="text" class="input" placeholder="请输入随货单号">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">入库日期</label>
                    <input type="date" class="input" id="stock-date" value="">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">供应商</label>
                    <input type="text" class="input" placeholder="请输入供应商名称">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">货位</label>
                    <div class="flex gap-2">
                      <input type="text" class="input flex-1" id="location-input" list="location-options" placeholder="可输入或选择货位">
                      <button type="button" class="btn btn-outline text-xs" id="reset-location"><i class="fa fa-undo"></i> 重置</button>
                    </div>
                    <datalist id="location-options">
                      <option value="A区-01架"></option>
                      <option value="A区-02架"></option>
                      <option value="B区-01架"></option>
                      <option value="B区-02架"></option>
                    </datalist>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <input type="text" class="input" placeholder="请输入备注信息">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button class="btn btn-outline">重置</button>
                <button class="btn btn-primary">
                    <i class="fa fa-save"></i> 保存
                </button>
            </div>
        </div>

        <!-- 操作按钮组 -->
        <div class="card p-4 mb-6">
            <div class="flex flex-wrap gap-2">
                <button class="btn btn-success" id="complete-stock">
                    <i class="fa fa-check-circle"></i> 完成入库
                </button>
                <button class="btn btn-warning" id="quick-add">
                    <i class="fa fa-bolt"></i> 快速添加
                </button>
                <button class="btn btn-info" id="add-medicine">
                    <i class="fa fa-plus"></i> 添加药品
                </button>
            </div>
        </div>

        <!-- 药品入库列表 -->
        <div class="card">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold">药品入库明细</h3>
                <div class="flex items-center gap-3">
                    <div class="text-sm text-gray-500">共 <span id="item-count">0</span> 条记录</div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">药品名称</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">规格</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生产厂家</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">批号</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">有效期</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">进货价</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">零售价</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">利润</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="medicine-table-body">
                    <tr>
                        <td colspan="11" class="text-center py-8 text-gray-500">
                            <i class="fa fa-inbox text-3xl mb-2"></i>
                            <p>暂无入库药品数据</p>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot class="bg-gray-50 font-medium">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-right">总计:</td>
                        <td class="px-6 py-4" id="total-quantity">0</td>
                        <td class="px-6 py-4" id="total-cost">¥0.00</td>
                        <td class="px-6 py-4" id="total-price">¥0.00</td>
                        <td class="px-6 py-4" id="total-profit">¥0.00</td>
                        <td class="px-6 py-4"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- 添加药品模态框 -->
<div id="medicine-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">添加药品到入库单</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <div class="p-6">
            <!-- 两种添加方式 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- 方式一：搜索添加 -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium mb-4 text-primary">方式一：搜索添加药品</h4>

                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">搜索药品</label>
                            <div class="relative">
                                <input type="text" id="medicine-search" placeholder="输入药品名称、通用名或批准文号" class="input pl-10">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div id="search-suggestions" class="hidden mt-2 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-10">
                                <!-- 智能搜索建议将在这里显示 -->
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品分类</label>
                            <select id="medicine-category" class="input">
                                <option value="">全部分类</option>
                                <option value="1">处方药</option>
                                <option value="2">非处方药</option>
                                <option value="3">中药饮片</option>
                                <option value="4">医疗器械</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary w-full" onclick="searchMedicine()">
                        <i class="fa fa-search"></i> 搜索药品
                    </button>

                    <!-- 搜索结果 -->
                    <div id="search-results" class="hidden mt-4">
                        <h4 class="font-medium mb-3">搜索结果</h4>
                        <div class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                            <table class="min-w-full">
                                <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">药品名称</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">通用名</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">规格</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">生产厂家</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">当前库存</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                                </thead>
                                <tbody id="search-results-body">
                                <!-- ��索结果将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 方式二：手动添加 -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium mb-4 text-primary">方式二：手动添加药品</h4>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品名称</label>
                            <input type="text" id="manual-name" class="input" placeholder="输入药品名称">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">规格</label>
                                <input type="text" id="manual-spec" class="input" placeholder="如：0.25g*24粒">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">单位</label>
                                <input type="text" id="manual-unit" class="input" placeholder="如：盒">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="manual-manufacturer" class="input" placeholder="输入生产厂家">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">批准文号</label>
                            <input type="text" id="manual-approval" class="input" placeholder="国药准字H20058763">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">条形码</label>
                            <input type="text" id="manual-barcode" class="input" placeholder="扫描或输入条形码">
                        </div>
                        <button class="btn btn-outline w-full" onclick="manualAddMedicine()">
                            <i class="fa fa-plus"></i> 手动添加药品
                        </button>
                    </div>
                </div>
            </div>

            <!-- 药品详细信息表单 - 始终显示 -->
            <div class="mt-6 border-t pt-6">
                <h4 class="font-medium mb-4">药品入库信息</h4>

                <div id="medicine-detail-prompt" class="text-center py-8 text-gray-500 border border-dashed border-gray-300 rounded-lg">
                    <i class="fa fa-info-circle text-3xl mb-3 text-blue-500"></i>
                    <p class="text-lg mb-2">请先选择或添加药品</p>
                    <p class="text-sm">通过上方搜索或手动添加药品后，此处将显示详细信息表单</p>
                </div>

                <div id="medicine-detail-fields" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>商品名称</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的商品名称，通常是品牌名称</span>
                                </span>
                            </label>
                            <input type="text" id="detail-name" class="input" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>通用名</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的化学名称，国际通用名称</span>
                                </span>
                            </label>
                            <input type="text" id="detail-generic" class="input" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>规格</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的规格，如含量、包装数量等</span>
                                </span>
                            </label>
                            <input type="text" id="detail-spec" class="input" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>单位</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的计量单位，如盒、瓶、支等</span>
                                </span>
                            </label>
                            <input type="text" id="detail-unit" class="input" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>批准文号</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">国家药品监督管理局批准的文号</span>
                                </span>
                            </label>
                            <input type="text" id="detail-approval" class="input" placeholder="国药准字H20058763">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>生产厂家</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的生产企业名称</span>
                                </span>
                            </label>
                            <input type="text" id="detail-manufacturer" class="input" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>批号</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的生产批次编号，用于追溯</span>
                                </span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="detail-batch" class="input" placeholder="请输入药品批号">
                                <button class="btn btn-outline whitespace-nowrap text-sm" onclick="generateBatchNumber()">自动生成</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>生产日期</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的生产日期，用于计算有效期</span>
                                </span>
                            </label>
                            <input type="date" id="detail-prod-date" class="input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>有效期至</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的有效期限，过期药品不得销售</span>
                                </span>
                            </label>
                            <input type="date" id="detail-expiry-date" class="input">
                            <div class="text-xs text-gray-500 mt-1">有效期提醒: <span id="expiry-alert"></span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>进货价格</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的进货单价，不含税</span>
                                </span>
                            </label>
                            <div class="price-input-container">
                                <input type="number" id="detail-cost" class="input price-input" min="0" step="0.01" placeholder="0.00" value="10.00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>零售价格</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">药品的销售��价，含税</span>
                                </span>
                            </label>
                            <div class="price-input-container">
                                <input type="number" id="detail-price" class="input price-input" min="0" step="0.01" placeholder="0.00" value="15.00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>本次入库数量</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">本次计划入库的药品数量</span>
                                </span>
                            </label>
                            <input type="number" id="detail-quantity" class="input" min="1" value="10">
                            <div class="text-xs text-gray-500 mt-1">安全库存: <span id="safety-stock">10</span> | 当前库存: <span id="current-stock">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                <span>条形码</span>
                                <span class="info-tooltip ml-1">
                                    <i class="fa fa-info-circle text-blue-500 cursor-pointer"></i>
                                    <span class="tooltip-text">用于库存唯一识别与扫码快速录入</span>
                                </span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="detail-barcode" class="input" placeholder="扫描或输入条形码">
                                <button class="btn btn-outline whitespace-nowrap text-sm" onclick="simulateBarcodeScan()">模拟扫描</button>
                            </div>
                        </div>
                    </div>

                    <!-- 利润计算区域 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-sm text-gray-500 mb-1">单件利润</div>
                            <div class="text-xl font-bold" id="unit-profit">¥5.00</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-500 mb-1">总利润</div>
                            <div class="text-xl font-bold" id="total-profit-preview">¥50.00</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-500 mb-1">利润率</div>
                            <div class="text-xl font-bold" id="profit-rate">50%</div>
                        </div>
                    </div>

                    <!-- 药品分类和存储条件 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品分类</label>
                            <select id="detail-category" class="input">
                                <option value="1">处方药</option>
                                <option value="2">非处方药</option>
                                <option value="3">中药饮片</option>
                                <option value="4">医疗器械</option>
                                <option value="5">保健食品</option>
                                <option value="6">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">存储条件</label>
                            <select id="detail-storage" class="input">
                                <option value="常温">常温</option>
                                <option value="阴凉">阴凉</option>
                                <option value="冷藏">冷藏(2-8℃)</option>
                                <option value="冷冻">冷冻(-18℃以下)</option>
                                <option value="避光">避光</option>
                            </select>
                        </div>
                    </div>

                    <!-- 其他信息 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">药品说明</label>
                        <textarea id="detail-description" class="input" rows="2" placeholder="可输入药品的特殊说明、注意事项等"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
            <button onclick="closeModal()" class="btn btn-outline">取消</button>
            <button onclick="addMedicineToList()" class="btn btn-primary" id="add-to-list-btn" disabled>
                <i class="fa fa-plus"></i> 添加到入库单
            </button>
        </div>
    </div>
</div>

<!-- 快速添加模态框 -->
<div id="quick-add-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">快速添加药品</h3>
            <button onclick="closeQuickAddModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <p class="text-sm text-gray-600 mb-4">请扫描药品条形码或手动输入</p>
            <div class="relative">
                <input type="text" id="barcode-input" class="input" placeholder="扫描或输入条形码">
                <button class="btn btn-primary mt-4 w-full" onclick="processBarcode()">
                    <i class="fa fa-barcode"></i> 确认添加
                </button>
            </div>
            <div class="mt-4 text-center">
                <button class="text-primary text-sm" onclick="openCamera()">
                    <i class="fa fa-camera"></i> 打开摄像头扫描
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批量导入模态框 -->
<div id="import-modal" class="modal-overlay">
    <div class="modal-content max-w-2xl">
        <div class="p-6">
            <div class="mb-6">
                <h4 class="font-medium mb-3">导入步骤</h4>
                <div class="text-sm text-gray-700">
                    <p>1. 下载 Excel 模板文件</p>
                    <p>2. 按照模板格式填写药品信息</p>
                    <p>3. 上传填写好的 Excel 文件</p>
                    <p>4. 系统将自动验证并导入数据</p>
                </div>
            </div>

            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-4">
                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
                <p class="text-lg font-medium mb-2">拖放文件到这里</p>
                <p class="text-sm text-gray-500 mb-4">支持 .xlsx, .xls 格式，最大 10MB</p>
                <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls">
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    <i class="fa fa-folder-open"></i> 选择文件
                </button>
            </div>

            <div id="file-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fa fa-file-excel-o text-green-600 text-xl"></i>
                        <div>
                            <p class="font-medium" id="file-name">文件名.xlsx</p>
                            <p class="text-sm text-gray-500" id="file-size">0 KB</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700" onclick="removeFile()">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="flex gap-3">
                <button class="btn btn-outline flex-1" onclick="downloadTemplate()">
                    <i class="fa fa-download"></i> 下载模板
                </button>
                <button class="btn btn-primary flex-1" id="import-btn" disabled onclick="importExcel()">
                    <i class="fa fa-upload"></i> 开始导入
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 注入统一导航脚本 -->
<script src="js/common-nav.js"></script>

<script>
    // 全局变量
    const API_BASE_URL = 'http://localhost:8080/api';
    let selectedMedicine = null;
    let medicineList = [];
    let currentIndex = 1;
    let selectedFile = null;
    let inventoryData = JSON.parse(localStorage.getItem('pharmacy-inventory')) || {};

    // 新增: 获取租户头部
    function getTenantHeaders(base){
        const tenant = localStorage.getItem('selectedTenant') || '';
        if(tenant){
            return { ...base, 'X-Shop-Id': tenant };
        }
        return base;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('=== 智能入库页面初始化开始 ===');

        const isAPIHealthy = await checkAPIHealth();
        if (!isAPIHealthy) {
            console.log('运行在离线模式，使用本地存储');
        }

        initDateTime();
        initEvents();
        await loadMedicineData();
        initSmartSearch();
        initPriceCalculation();
        initExpiryAlert();
        initFileUpload();

        console.log('=== 智能入库页面初始化完成 ===');
    });

    // API健康检查
    async function checkAPIHealth() {
        try {
            const response = await fetch(`${API_BASE_URL}/medicines/health`);
            if (response.ok) {
                const result = await response.json();
                console.log('后端API连接正常:', result);
                return true;
            }
        } catch (error) {
            console.warn('后端API连接失败，将使用本地存储模式:', error);
        }
        return false;
    }

    // 日期时间
    function initDateTime() {
        // 设置入库日期为今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('stock-date').value = today;
    }

    // 文件上传初始化
    function initFileUpload() {
        const fileInput = document.getElementById('file-input');
        const dropZone = fileInput.parentElement;

        // 拖放事件
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-blue-50');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
    }

    // 处理文件选择
    function handleFileSelect(file) {
        if (!file.name.match(/\.(xlsx|xls)$/)) {
            alert('请选择Excel文件 (.xlsx 或 .xls 格式)');
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            alert('文件大小不能超过10MB');
            return;
        }

        selectedFile = file;

        const fileInfo = document.getElementById('file-info');
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = (file.size / 1024).toFixed(1) + ' KB';
        fileInfo.classList.remove('hidden');

        document.getElementById('import-btn').disabled = false;
    }

    // 移除文件
    function removeFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        document.getElementById('file-info').classList.add('hidden');
        document.getElementById('import-btn').disabled = true;
    }

    // 下载模板
    function downloadTemplate() {
        alert('模板下载功能将在后续版本中实现');
    }

    // 导入Excel
    function importExcel() {
        if (!selectedFile) {
            alert('请先选择要导入的文件');
            return;
        }

        const importBtn = document.getElementById('import-btn');
        const originalText = importBtn.innerHTML;

        // 显示加载状态
        importBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 导入中...';
        importBtn.disabled = true;

        // 模拟导入过程
        setTimeout(() => {
            // 模拟导入成功
            importBtn.innerHTML = '<i class="fa fa-check"></i> 导入成功';
            importBtn.classList.remove('btn-primary');
            importBtn.classList.add('btn-success');

            // 模拟添加一些数据
            simulateImportData();

            setTimeout(() => {
                closeImportModal();
                importBtn.innerHTML = originalText;
                importBtn.classList.remove('btn-success');
                importBtn.classList.add('btn-primary');
                importBtn.disabled = false;
                removeFile();
            }, 1500);
        }, 2000);
    }

    // 模拟导入数据
    function simulateImportData() {
        const mockImportData = [
            {
                id: 'import-1',
                name: '维生素C片',
                genericName: '维生素C',
                spec: '100mg*60片',
                unit: '瓶',
                approvalNo: '国药准字H20013062',
                manufacturer: '浙江医药',
                batch: 'B241215001',
                expiryDate: '2026-12-15',
                cost: 8.00,
                price: 15.00,
                quantity: 50
            },
            {
                id: 'import-2',
                name: '板蓝根颗粒',
                genericName: '板蓝根',
                spec: '10g*20袋',
                unit: '盒',
                approvalNo: '国药准字Z44020045',
                manufacturer: '白云山',
                batch: 'B241215002',
                expiryDate: '2025-06-30',
                cost: 12.00,
                price: 25.00,
                quantity: 30
            }
        ];

        mockImportData.forEach(item => {
            addMedicineToTable(item);
        });
    }

    // 智能搜索初始化
    function initSmartSearch() {
        const searchInput = document.getElementById('medicine-search');
        const suggestionsContainer = document.getElementById('search-suggestions');

        searchInput.addEventListener('input', function() {
            const keyword = this.value.trim();
            if (keyword.length < 2) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            // 模拟智能搜索建议
            const suggestions = medicineList.filter(medicine =>
                medicine.name.includes(keyword) ||
                medicine.genericName.includes(keyword) ||
                medicine.approvalNo.includes(keyword)
            ).slice(0, 5);

            if (suggestions.length > 0) {
                suggestionsContainer.innerHTML = suggestions.map(medicine => `
                    <div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectSuggestion('${medicine.id}')">
                        <div class="font-medium">${medicine.name}</div>
                        <div class="text-xs text-gray-500">${medicine.genericName} - ${medicine.manufacturer}</div>
                    </div>
                `).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        });

        // 点击其他地方关闭建议
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
        });
    }

    // 价格计算初始化
    function initPriceCalculation() {
        const costInput = document.getElementById('detail-cost');
        const priceInput = document.getElementById('detail-price');
        const quantityInput = document.getElementById('detail-quantity');

        const updateProfit = () => {
            const cost = parseFloat(costInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;

            const unitProfit = price - cost;
            const totalProfit = unitProfit * quantity;
            const profitRate = cost > 0 ? ((unitProfit / cost) * 100).toFixed(2) : 0;

            const unitProfitElement = document.getElementById('unit-profit');
            const totalProfitElement = document.getElementById('total-profit-preview');
            const profitRateElement = document.getElementById('profit-rate');

            unitProfitElement.textContent = `¥${unitProfit.toFixed(2)}`;
            unitProfitElement.className = unitProfit >= 0 ? 'profit-positive' : 'profit-negative';

            totalProfitElement.textContent = `¥${totalProfit.toFixed(2)}`;
            totalProfitElement.className = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';

            profitRateElement.textContent = `${profitRate}%`;
            profitRateElement.className = profitRate >= 0 ? 'profit-positive' : 'profit-negative';
        };

        costInput.addEventListener('input', updateProfit);
        priceInput.addEventListener('input', updateProfit);
        quantityInput.addEventListener('input', updateProfit);
    }

    // 有效期提醒初始化
    function initExpiryAlert() {
        const expiryDateInput = document.getElementById('detail-expiry-date');

        expiryDateInput.addEventListener('change', function() {
            const expiryDate = new Date(this.value);
            const today = new Date();
            const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));

            const alertElement = document.getElementById('expiry-alert');

            if (daysUntilExpiry < 0) {
                alertElement.textContent = '药品已过期！';
                alertElement.className = 'text-red-600 font-medium';
            } else if (daysUntilExpiry < 90) {
                alertElement.textContent = `即将过期（${daysUntilExpiry}天）`;
                alertElement.className = 'text-red-600 font-medium';
            } else if (daysUntilExpiry < 180) {
                alertElement.textContent = `有效期较短（${daysUntilExpiry}天）`;
                alertElement.className = 'text-yellow-600 font-medium';
            } else {
                alertElement.textContent = `有效期正常（${daysUntilExpiry}天）`;
                alertElement.className = 'text-green-600 font-medium';
            }
        });
    }

    // 选择搜索建议
    function selectSuggestion(medicineId) {
        document.getElementById('search-suggestions').classList.add('hidden');
        selectMedicine(medicineId);
    }

    // 事件绑定
    function initEvents() {
        // 添加药品按钮
        const addMedicineBtn = document.getElementById('add-medicine');
        if (addMedicineBtn) {
            addMedicineBtn.addEventListener('click', openModal);
        }

        // 批量导入按钮
        const importDataBtn = document.getElementById('import-data');
        if (importDataBtn) {
            importDataBtn.addEventListener('click', openImportModal);
        }

        // 新建入库单按钮
        const newStockBtn = document.getElementById('new-stock');
        if (newStockBtn) {
            newStockBtn.addEventListener('click', newStock);
        }

        // 操作按钮
        const completeStockBtn = document.getElementById('complete-stock');
        if (completeStockBtn) {
            completeStockBtn.addEventListener('click', completeStock);
        }

        const quickAddBtn = document.getElementById('quick-add');
        if (quickAddBtn) {
            quickAddBtn.addEventListener('click', openQuickAddModal);
        }
    }

    // 打开模态框
    function openModal() {
        const modal = document.getElementById('medicine-modal');
        modal.classList.add('show');

        document.getElementById('search-results').classList.add('hidden');
        document.getElementById('medicine-detail-prompt').classList.remove('hidden');
        document.getElementById('medicine-detail-fields').classList.add('hidden');
        document.getElementById('add-to-list-btn').disabled = true;

        // 清空表单
        document.getElementById('medicine-search').value = '';
        document.getElementById('medicine-category').value = '';
        document.getElementById('manual-name').value = '';
        document.getElementById('manual-spec').value = '';
        document.getElementById('manual-unit').value = '';
        document.getElementById('manual-manufacturer').value = '';
        document.getElementById('manual-approval').value = '';

        // 设置默认日期
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('detail-prod-date').value = today;

        // 设置有效期（默认一年后）
        const nextYear = new Date();
        nextYear.setFullYear(nextYear.getFullYear() + 1);
        document.getElementById('detail-expiry-date').value = nextYear.toISOString().split('T')[0];
    }

    // 关闭模态框
    function closeModal() {
        document.getElementById('medicine-modal').classList.remove('show');
    }

    // 打开导入模态框
    function openImportModal() {
        document.getElementById('import-modal').classList.add('show');
    }

    // 关闭导入模态框
    function closeImportModal() {
        document.getElementById('import-modal').classList.remove('show');
    }

    // 打开快速添加模态框
    function openQuickAddModal() {
        document.getElementById('quick-add-modal').classList.add('show');
    }

    // 关闭快速添加模态框
    function closeQuickAddModal() {
        document.getElementById('quick-add-modal').classList.remove('show');
    }

    // 新建入库单
    function newStock() {
        if (confirm('确定要新建入库单吗？当前未保存的数据将会丢失。')) {
            // 重置表格
            document.getElementById('medicine-table-body').innerHTML = `
                <tr>
                    <td colspan="11" class="text-center py-8 text-gray-500">
                        <i class="fa fa-inbox text-3xl mb-2"></i>
                        <p>暂无入库药品数据</p>
                    </td>
                </tr>
            `;
            currentIndex = 1;
            updateTotals();

            // 重置表单
            document.querySelectorAll('.input').forEach(input => {
                if (input.type !== 'date') {
                    input.value = '';
                }
            });

            // 设置今天日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stock-date').value = today;

            alert('已创建新的入库单');
        }
    }

    // 处理条形码
    function processBarcode() {
        const barcode = document.getElementById('barcode-input').value;
        if (!barcode) {
            alert('请���入条形码');
            return;
        }

        // 模拟根据条形码查找药品
        const medicine = medicineList.find(med => med.barcode === barcode);
        if (medicine) {
            closeQuickAddModal();
            openModal();
            selectMedicine(medicine.id);
        } else {
            alert('未找到匹配的药品，请检查条形码是否正确');
        }
    }

    // 打开摄像头（模拟）
    function openCamera() {
        alert('摄像头功能需要浏览器权限，此处为模拟功能');
    }

    // 手动添加药品
    async function manualAddMedicine() {
        const name = document.getElementById('manual-name').value.trim();
        const spec = document.getElementById('manual-spec').value.trim();
        const unit = document.getElementById('manual-unit').value.trim();
        const manufacturer = document.getElementById('manual-manufacturer').value.trim();
        const approvalNo = document.getElementById('manual-approval').value.trim();
        const barcode = document.getElementById('manual-barcode').value.trim();

        if (!name || !spec || !unit || !manufacturer || !approvalNo) {
            alert('请填写所有必填字段');
            return;
        }

        // 验证批准文号格式（可选，但建议）
        if (!approvalNo.startsWith('国药准字')) {
            if (!confirm('批准文号格式建议以"国药准字"开头，是否继续？')) {
                return;
            }
        }

        try {
            // 构建新药品数据
            const newMedicine = {
                medicineId: 'M' + Date.now(),
                tradeName: name,
                genericName: name,
                spec: spec,
                unit: unit,
                approvalNo: approvalNo,
                categoryId: 2,
                manufacturer: manufacturer,
                retailPrice: 15.00,
                purchasePrice: 10.00,
                stockQuantity: 0,
                isRx: 0,
                description: '',
                barcode: barcode
            };

            const response = await fetch(`${API_BASE_URL}/medicines`, {
                method: 'POST',
                headers: getTenantHeaders({'Content-Type': 'application/json'}),
                body: JSON.stringify(newMedicine)
            });

            if (response.ok) {
                const createdMedicine = await response.json();
                console.log('药品创建成功:', createdMedicine);

                // 使用创建的药品数据
                selectedMedicine = {
                    medicineId: createdMedicine.medicineId,
                    id: createdMedicine.medicineId,
                    name: createdMedicine.tradeName || createdMedicine.genericName,
                    genericName: createdMedicine.genericName,
                    spec: createdMedicine.spec,
                    unit: createdMedicine.unit,
                    approvalNo: createdMedicine.approvalNo,
                    manufacturer: createdMedicine.manufacturer,
                    stock: createdMedicine.stockQuantity || 0,
                    safetyStock: createdMedicine.minThreshold || 10,
                    cost: createdMedicine.purchasePrice || 10.00,
                    price: createdMedicine.retailPrice || 15.00,
                    category: createdMedicine.categoryId ? createdMedicine.categoryId.toString() : '2',
                    storage: createdMedicine.storageCondition || '常温',
                    description: createdMedicine.description || '',
                    isRx: createdMedicine.isRx || 0
                };

                fillMedicineForm(selectedMedicine);
            } else {
                throw new Error('创建药品失败');
            }
        } catch (error) {
            console.error('创建药品失败:', error);
            alert('创建药品失败，使用本地模式: ' + error.message);

            // 回退到本地创建
            selectedMedicine = {
                medicineId: 'manual-' + Date.now(),
                id: 'manual-' + Date.now(),
                name: name,
                genericName: name,
                spec: spec,
                unit: unit,
                approvalNo: approvalNo, // 使用用户输入的批准文号
                manufacturer: manufacturer,
                stock: 0,
                safetyStock: 10,
                cost: 10.00,
                price: 15.00,
                category: '2',
                storage: '常温',
                isRx: 0
            };

            fillMedicineForm(selectedMedicine);
        }
    }

    // 填充表单的公共函数
    function fillMedicineForm(medicine) {
        document.getElementById('detail-name').value = medicine.name;
        document.getElementById('detail-generic').value = medicine.genericName;
        document.getElementById('detail-spec').value = medicine.spec;
        document.getElementById('detail-unit').value = medicine.unit;
        document.getElementById('detail-approval').value = medicine.approvalNo;
        document.getElementById('detail-manufacturer').value = medicine.manufacturer;
        document.getElementById('safety-stock').textContent = medicine.safetyStock || 10;
        document.getElementById('current-stock').textContent = medicine.stock || 0;
        document.getElementById('detail-category').value = medicine.category || '2';
        document.getElementById('detail-storage').value = medicine.storage || '常温';
        document.getElementById('detail-description').value = medicine.description || '';

        // 设置默认价格 - 确保有默认值
        const defaultCost = medicine.cost || 10.00; // 默认进货价10元
        const defaultPrice = medicine.price || 15.00; // 默认零售价15元

        document.getElementById('detail-cost').value = defaultCost;
        document.getElementById('detail-price').value = defaultPrice;

        // 显示详情表单
        document.getElementById('medicine-detail-prompt').classList.add('hidden');
        document.getElementById('medicine-detail-fields').classList.remove('hidden');
        document.getElementById('add-to-list-btn').disabled = false;

        // 自动生成批号
        generateBatchNumber();

        // 立即更新利润计算
        updateProfitCalculation();

        // 滚动到详情表单
        document.getElementById('medicine-detail-fields').scrollIntoView({ behavior: 'smooth' });
    }

    // 立即更新利润计算的函数
    function updateProfitCalculation() {
        const costInput = document.getElementById('detail-cost');
        const priceInput = document.getElementById('detail-price');
        const quantityInput = document.getElementById('detail-quantity');

        const cost = parseFloat(costInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 1;

        const unitProfit = price - cost;
        const totalProfit = unitProfit * quantity;
        const profitRate = cost > 0 ? ((unitProfit / cost) * 100).toFixed(2) : 0;

        const unitProfitElement = document.getElementById('unit-profit');
        const totalProfitElement = document.getElementById('total-profit-preview');
        const profitRateElement = document.getElementById('profit-rate');

        unitProfitElement.textContent = `¥${unitProfit.toFixed(2)}`;
        unitProfitElement.className = unitProfit >= 0 ? 'profit-positive' : 'profit-negative';

        totalProfitElement.textContent = `¥${totalProfit.toFixed(2)}`;
        totalProfitElement.className = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';

        profitRateElement.textContent = `${profitRate}%`;
        profitRateElement.className = profitRate >= 0 ? 'profit-positive' : 'profit-negative';
    }

    // 搜索药品
    async function searchMedicine() {
        const keyword = document.getElementById('medicine-search').value.trim();
        const category = document.getElementById('medicine-category').value;

        if (!keyword) {
            alert('请输入搜索关键词');
            return;
        }

        try {
            // 构建查询参数
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (category) params.append('category', category);
            params.append('page', '1');
            params.append('size', '100');

            const response = await fetch(`${API_BASE_URL}/medicines/search?${params}`, {
                headers: getTenantHeaders({})
            });

            if (response.ok) {
                const result = await response.json();
                console.log('搜索成功:', result);

                if (result.code === 200) {
                    // 将后端数据格式转换为前端格式 - 根据数据库结构调整
                    const formattedResults = result.data.map(medicine => ({
                        medicineId: medicine.medicineId, // 使用数据库中的字段名
                        id: medicine.medicineId, // 同时保留id字段用于兼容
                        name: medicine.tradeName || medicine.genericName, // 商品名或通用名
                        genericName: medicine.genericName,
                        spec: medicine.spec,
                        unit: medicine.unit,
                        approvalNo: medicine.approvalNo,
                        manufacturer: medicine.manufacturer,
                        stock: medicine.stockQuantity || 0,
                        safetyStock: medicine.minThreshold || 10,
                        cost: medicine.purchasePrice || 10.00,
                        price: medicine.retailPrice || 15.00,
                        category: medicine.categoryId ? medicine.categoryId.toString() : '2',
                        storage: medicine.storageCondition || '常温',
                        description: medicine.description || '',
                        isRx: medicine.isRx || 0
                    }));

                    renderSearchResults(formattedResults);
                } else {
                    throw new Error(result.message);
                }
            } else {
                throw new Error('搜索请求失败');
            }
        } catch (error) {
            console.error('搜索药品失败:', error);
            alert('搜索药品失败: ' + error.message);

            // 回���到本地搜索
            let results = medicineList.filter(medicine =>
                medicine.name.includes(keyword) ||
                medicine.genericName.includes(keyword) ||
                medicine.approvalNo.includes(keyword)
            );

            if (category) {
                results = results.filter(medicine => medicine.category === category);
            }

            renderSearchResults(results);
        }
    }

    // 渲染搜索结果
    function renderSearchResults(results) {
        const container = document.getElementById('search-results-body');
        const resultsSection = document.getElementById('search-results');

        if (results.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-gray-500">
                        <i class="fa fa-search text-xl mb-2"></i>
                        <p>未找到相关药品</p>
                    </td>
                </tr>
            `;
        } else {
            container.innerHTML = results.map(medicine => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">${medicine.name}</td>
                    <td class="px-4 py-2">${medicine.genericName}</td>
                    <td class="px-4 py-2">${medicine.spec}</td>
                    <td class="px-4 py-2">${medicine.manufacturer}</td>
                    <td class="px-4 py-2">
                        <span class="badge ${medicine.stock > 10 ? 'badge-success' : medicine.stock > 5 ? 'badge-warning' : 'badge-error'}">
                            ${medicine.stock}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <button class="btn btn-primary text-sm px-3 py-1" onclick="selectMedicine('${medicine.id}')">
                            选择
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        resultsSection.classList.remove('hidden');
    }

    // 选择药品
    function selectMedicine(medicineId) {
        selectedMedicine = medicineList.find(med => med.id === medicineId);

        if (selectedMedicine) {
            fillMedicineForm(selectedMedicine);
        }
    }

    // 生成批号
    function generateBatchNumber() {
        const now = new Date();
        const year = now.getFullYear().toString().substr(-2);
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

        document.getElementById('detail-batch').value = `B${year}${month}${day}${random}`;
    }

    // 添��药品到列表
    function addMedicineToList() {
        if (!selectedMedicine) return;

        const batch = document.getElementById('detail-batch').value;
        const prodDate = document.getElementById('detail-prod-date').value;
        const expiryDate = document.getElementById('detail-expiry-date').value;
        const cost = parseFloat(document.getElementById('detail-cost').value) || 0;
        const price = parseFloat(document.getElementById('detail-price').value) || 0;
        const quantity = parseInt(document.getElementById('detail-quantity').value) || 0;
        const approvalNo = document.getElementById('detail-approval').value.trim();
        const category = document.getElementById('detail-category').value;
        const storage = document.getElementById('detail-storage').value;
        const description = document.getElementById('detail-description').value;

        if (!quantity || quantity <= 0) {
            alert('请输入有效的入库数量');
            return;
        }

        if (!batch) {
            alert('请输入药品批号');
            return;
        }

        if (!approvalNo) {
            alert('请输入批准文号');
            return;
        }

        if (cost <= 0) {
            alert('请输入有效的进货价格');
            return;
        }

        // 计算利润
        const unitProfit = (price || 0) - cost;
        const totalProfit = unitProfit * quantity;

        // 创建药品数据对象
        const medicineData = {
            ...selectedMedicine,
            batch,
            prodDate,
            expiryDate,
            approvalNo: approvalNo, // 使用用户输入的批准文号
            cost: cost, // 进货价格
            price: price, // 零售价格
            quantity,
            category,
            storage,
            description,
            unitProfit,
            totalProfit
        };

        addMedicineToTable(medicineData);

        // 关闭模态框
        closeModal();

        // 重置选择
        selectedMedicine = null;
    }

    // 添加药品到表格
    function addMedicineToTable(medicineData) {
        const tableBody = document.getElementById('medicine-table-body');

        // 如果当前是空状态，先清空
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = '';
        }

        const newRow = document.createElement('tr');
        newRow.className = 'hover:bg-gray-50 transition-colors';
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${currentIndex}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-medium">${medicineData.name}</div>
                <div class="text-xs text-gray-500">${medicineData.genericName}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${medicineData.spec}</td>
            <td class="px-6 py-4 whitespace-nowrap">${medicineData.manufacturer}</td>
            <td class="px-6 py-4 whitespace-nowrap">${medicineData.batch}</td>
            <td class="px-6 py-4 whitespace-nowrap">${medicineData.expiryDate}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="font-medium">${medicineData.quantity}</span>
                <span class="text-xs text-gray-500 ml-1">${medicineData.unit}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">¥${medicineData.cost.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap">¥${medicineData.price.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap ${medicineData.unitProfit >= 0 ? 'profit-positive' : 'profit-negative'}">
                ¥${medicineData.totalProfit.toFixed(2)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="text-blue-600 hover:underline mr-3" onclick="editMedicine(this)">编辑</button>
                <button class="text-red-600 hover:underline" onclick="removeMedicine(this)">删除</button>
            </td>
        `;

        // 存储完整数据到行元素
        newRow._medicineData = medicineData;

        tableBody.appendChild(newRow);
        currentIndex++;

        // 更新计数和总计
        updateTotals();
    }

    // 更新总计
    function updateTotals() {
        const rows = document.querySelectorAll('#medicine-table-body tr');
        let totalQuantity = 0;
        let totalCost = 0;
        let totalPrice = 0;
        let totalProfit = 0;

        rows.forEach(row => {
            if (row.cells.length > 1 && row._medicineData) { // 确保不是空状态行且有数据
                const data = row._medicineData;
                totalQuantity += data.quantity;
                totalCost += data.cost * data.quantity;
                totalPrice += data.price * data.quantity;
                totalProfit += data.totalProfit;
            }
        });

        document.getElementById('item-count').textContent = rows.length;
        document.getElementById('total-quantity').textContent = totalQuantity;
        document.getElementById('total-cost').textContent = `¥${totalCost.toFixed(2)}`;
        document.getElementById('total-price').textContent = `¥${totalPrice.toFixed(2)}`;
        document.getElementById('total-profit').textContent = `¥${totalProfit.toFixed(2)}`;
    }

    // 编辑药品
    function editMedicine(button) {
        const row = button.closest('tr');
        const medicineData = row._medicineData;

        if (medicineData) {
            // 设置选中的药品
            selectedMedicine = medicineData;

            // 打开模态框
            openModal();

            // 填充表单
            document.getElementById('detail-name').value = medicineData.name;
            document.getElementById('detail-generic').value = medicineData.genericName;
            document.getElementById('detail-spec').value = medicineData.spec;
            document.getElementById('detail-unit').value = medicineData.unit;
            document.getElementById('detail-approval').value = medicineData.approvalNo;
            document.getElementById('detail-manufacturer').value = medicineData.manufacturer;
            document.getElementById('detail-batch').value = medicineData.batch;
            document.getElementById('detail-prod-date').value = medicineData.prodDate;
            document.getElementById('detail-expiry-date').value = medicineData.expiryDate;
            document.getElementById('detail-cost').value = medicineData.cost;
            document.getElementById('detail-price').value = medicineData.price;
            document.getElementById('detail-quantity').value = medicineData.quantity;
            document.getElementById('detail-category').value = medicineData.category;
            document.getElementById('detail-storage').value = medicineData.storage;
            document.getElementById('detail-description').value = medicineData.description || '';
            document.getElementById('detail-barcode').value = medicineData.barcode || ''; // 填充条形码

            // 显示详情表单
            document.getElementById('medicine-detail-prompt').classList.add('hidden');
            document.getElementById('medicine-detail-fields').classList.remove('hidden');
            document.getElementById('add-to-list-btn').disabled = false;

            // 更新利润计算
            updateProfitCalculation();

            // 移除原行
            row.remove();
            updateTotals();
        }
    }

    // 删除药品
    function removeMedicine(button) {
        const row = button.closest('tr');
        if (confirm('确定要删除这个药品吗？')) {
            row.remove();

            // 更新序号
            const rows = document.querySelectorAll('#medicine-table-body tr');
            rows.forEach((row, index) => {
                if (row.cells.length > 1) { // 确保不是空状态行
                    row.cells[0].textContent = index + 1;
                }
            });

            currentIndex = rows.length + 1;

            // 更新总计
            updateTotals();

            // 如果表格为空，显示空状态
            if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1)) {
                const tableBody = document.getElementById('medicine-table-body');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-8 text-gray-500">
                            <i class="fa fa-inbox text-3xl mb-2"></i>
                            <p>暂无入库药品数据</p>
                        </td>
                    </tr>
                `;
            }
 }
    }

    // 完成入库
    async function completeStock() {
        const itemCount = document.getElementById('item-count').textContent;
        if (itemCount === '0') {
            alert('请先添加药品到入库单');
            return;
        }

        if (confirm('确定要完成入库操作吗？完成后将无法修改。')) {
            const completeBtn = document.getElementById('complete-stock');
            const originalText = completeBtn.innerHTML;
            completeBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 入库中...';
            completeBtn.disabled = true;

            try {
                // 获取所有入库药品数据
                const rows = document.querySelectorAll('#medicine-table-body tr');
                const stockItems = [];
                rows.forEach(row => {
                    if (row.cells.length > 1 && row._medicineData) {
                        stockItems.push(row._medicineData);
                    }
                });
                if(stockItems.length===0){ throw new Error('没有可提交的入库明细'); }

                // 首先获取或创建默认供应商
                let supplierId = 1; // 默认供应商ID
                try {
                    const tenantHeader = localStorage.getItem('selectedTenant') || '';
                    const suppliersResponse = await fetch(`${API_BASE_URL}/suppliers`, {
                        headers: tenantHeader? {'X-Shop-Id': tenantHeader}:{}
                    });
                    if (suppliersResponse.ok) {
                        const suppliers = await suppliersResponse.json();
                        if (Array.isArray(suppliers) && suppliers.length > 0) {
                            supplierId = suppliers[0].supplierId;
                            console.log('使用供应商ID:', supplierId);
                        }
                    }
                } catch (supplierError) {
                    console.warn('供应商处理失败，使用默认ID:', supplierError);
                }

                // 构建后端需要的入库单数据格式 (日期统一 YYYY-MM-DD 避免 LocalDate 解析失败)
                const stockInData = {
                    stockInDate: new Date().toISOString(),
                    remark: document.querySelector('input[placeholder="请输入备注信息"]').value || '智能入库',
                    status: 1,
                    items: stockItems.map(item => {
                        const medId = item.medicineId || item.id;
                        if(!medId){ console.warn('条目缺少 medicineId, 已跳过', item); return null; }
                        const prodDateRaw = item.prodDate ? new Date(item.prodDate) : new Date();
                        const expiryRaw = item.expiryDate ? new Date(item.expiryDate) : new Date(Date.now()+365*24*60*60*1000);
                        const toDate = d => isNaN(d.getTime())? new Date().toISOString().slice(0,10): d.toISOString().slice(0,10);
                        const unitPriceVal = (item.cost!=null? item.cost : (item.unitPrice!=null? item.unitPrice : 0));
                        const mapped = {
                            medicine: { medicineId: medId },
                            quantity: item.quantity || 0,
                            unitPrice: Number(unitPriceVal),
                            batchNumber: item.batch || 'DEFAULT_BATCH',
                            productionDate: toDate(prodDateRaw),
                            expiryDate: toDate(expiryRaw)
                        };
                        console.log('处理后的入库项:', mapped);
                        return mapped;
                    }).filter(Boolean),
                    supplier: { supplierId }
                };

                console.log('发送入库数据:', stockInData);
                const tenant = localStorage.getItem('selectedTenant') || '';
                const headers = {
                    'Content-Type': 'application/json'
                };
                if(tenant){ headers['X-Shop-Id'] = tenant; }
                const response = await fetch(`${API_BASE_URL}/stock-ins`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(stockInData)
                });

                if (!response.ok) {
                    let errorText;
                    try { errorText = await response.text(); } catch(_) { errorText = response.status + ' 错误'; }
                    console.error('入库失败:', errorText);
                    // 如果后端返回 400 提示药品不存在
                    if(response.status===400){
                        throw new Error('入库失败(400): '+ errorText);
                    }
                    throw new Error(`入库失败: ${errorText}`);
                }

                alert('入库操作已完成！库存已同步更新。');

                // 重置页面
                document.getElementById('medicine-table-body').innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-8 text-gray-500">
                            <i class="fa fa-inbox text-3xl mb-2"></i>
                            <p>暂无入库药品数据</p>
                        </td>
                    </tr>
                `;
                currentIndex = 1;
                updateTotals();
            } catch (error) {
                console.error('入库错误:', error);
                alert('入库操作失败: ' + error.message);
            } finally {
                completeBtn.innerHTML = originalText;
                completeBtn.disabled = false;
            }
        }
    }

    // 修改初始化函数，从后端加载药品数据
    async function loadMedicineData() {
        try {
            const response = await fetch(`${API_BASE_URL}/medicines?page=0&size=1000`, {
                headers: getTenantHeaders({})
            });
            if (response.ok) {
                const result = await response.json();
                console.log('从后端加载药品数据成功 (租户隔离):', result);
                medicineList = (result.content || []).map(medicine => ({
                    medicineId: medicine.medicineId,
                    id: medicine.medicineId,
                    name: medicine.tradeName || medicine.genericName,
                    genericName: medicine.genericName,
                    spec: medicine.spec,
                    unit: medicine.unit,
                    approvalNo: medicine.approvalNo,
                    manufacturer: medicine.manufacturer,
                    stock: medicine.stockQuantity || 0,
                    safetyStock: medicine.minThreshold || 10,
                    cost: medicine.purchasePrice || 10.00,
                    price: medicine.retailPrice || 15.00,
                    category: medicine.categoryId ? medicine.categoryId.toString() : '2',
                    storage: medicine.storageCondition || '常温',
                    description: medicine.description || '',
                    isRx: medicine.isRx || 0,
                    barcode: medicine.barcode || ''
                }));
            } else {
                throw new Error('Failed to load medicine data');
            }
        } catch (error) {
            console.error('从后端加载药品数据失败，使用空数组:', error);
            medicineList = [];
        }
    }
</script>
</body>
</html>

