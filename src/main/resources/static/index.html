<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 登录</title>
    <link rel="stylesheet" href="/css/tailwind.css" />
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css" />

    <!-- 高级感配色配置 (安全包装，避免 tailwind 未定义时报错) -->
    <script>
        window.tailwind = window.tailwind || {}; // 防止 CDN 加载失败导致 ReferenceError
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#3b82f6',
                        neutral: { 50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',800:'#1e293b',900:'#0f172a' }
                    },
                    fontFamily: { sans: ['Inter','system-ui','sans-serif'] },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0,0,0,0.05), 0 10px 20px -2px rgba(0,0,0,0.03)',
                        'hover': '0 10px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04)'
                    }
                }
            }
        };
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-luxury {
                @apply bg-white rounded-2xl shadow-soft border border-neutral-200 overflow-hidden transition-all duration-500 hover:shadow-hover;
            }
            .input-lux {
                @apply w-full px-5 py-3.5 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 placeholder:text-neutral-400 focus:border-primary focus:ring-1 focus:ring-primary/30 outline-none transition-all duration-300;
            }
            .btn-lux {
                @apply w-full py-3.5 bg-primary text-white rounded-xl font-medium transition-all duration-300 hover:bg-primary/95 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-primary/20;
            }
            .link-elegant {
                @apply text-neutral-600 hover:text-primary transition-colors duration-300 relative after:absolute after:bottom-0 after:left-0 after:h-[1px] after:w-0 after:bg-primary after:transition-all hover:after:w-full;
            }
            .divider-fine {
                @apply h-[1px] bg-neutral-200 my-8;
            }
            .bg-pattern {
                background-image:
                    radial-gradient(circle at 25% 25%, rgba(30, 58, 138, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(30, 58, 138, 0.05) 0%, transparent 50%);
                background-size: 100px 100px;
            }
        }
    </style>
</head>

<body class="font-sans text-neutral-800 min-h-screen">
<!-- 主容器 - 左右分栏布局 -->
<div class="flex flex-col lg:flex-row min-h-screen">
    <!-- 左侧背景区域 -->
    <div class="lg:w-3/5 bg-gradient-to-br from-primary to-primary/80 relative overflow-hidden hidden lg:block">
        <!-- 装饰图形 -->
        <div class="absolute inset-0 bg-pattern opacity-60"></div>
        <div class="absolute top-1/4 left-1/4 w-64 h-64 rounded-full bg-white/10 blur-3xl"></div>
        <div class="absolute bottom-1/3 right-1/3 w-80 h-80 rounded-full bg-white/5 blur-3xl"></div>

        <!-- 左侧内容 -->
        <div class="relative z-10 h-full flex flex-col justify-center p-16 text-white">
            <div class="max-w-md">
                <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-8 backdrop-blur-sm">
                    <i class="fa fa-medkit text-2xl"></i>
                </div>
                <h2 class="text-[clamp(1.8rem,5vw,2.8rem)] font-bold leading-tight mb-6">
                    智慧药房<br>专业管理系统
                </h2>
                <p class="text-white/80 text-lg mb-8 max-w-md">
                    高效、安全、智能的医药零售解决方案，为药房管理提供全方位支持
                </p>
                <div class="flex gap-4">
                    <div class="flex items-center gap-2">
                        <i class="fa fa-check-circle text-white/90"></i>
                        <span class="text-white/90">高效收银流程</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fa fa-check-circle text-white/90"></i>
                        <span class="text-white/90">药品管理系统</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧登录区域 -->
    <div class="lg:w-2/5 flex items-center justify-center p-6 lg:p-16 bg-neutral-50">
        <div class="w-full max-w-md">
            <!-- 移动端品牌标识 -->
            <div class="text-center mb-10 lg:hidden">
                <div class="w-16 h-16 bg-primary/10 rounded-xl flex items-center justify-center text-primary mx-auto mb-6">
                    <i class="fa fa-medkit text-2xl"></i>
                </div>
                <h1 class="text-[clamp(1.6rem,4vw,2rem)] font-bold text-neutral-900">智慧药房系统</h1>
                <p class="text-neutral-500 mt-2.5">专业收银管理平台</p>
            </div>

            <!-- 登录卡片 -->
            <div class="card-luxury p-8 md:p-10">
                <!-- 桌面端标题（左侧已有品牌信息，这里简化） -->
                <div class="text-center mb-10 hidden lg:block">
                    <h1 class="text-[clamp(1.6rem,4vw,2rem)] font-bold text-neutral-900">账户登录</h1>
                    <p class="text-neutral-500 mt-2.5">请输入您的账号信息</p>
                </div>

                <!-- 消息容器 - 放在标题下方 -->
                <div id="message-container" class="mb-6"></div>

                <!-- 登录表单 -->
                <form id="login-form" class="space-y-6">
                    <div class="space-y-2.5">
                        <label class="block text-sm font-medium text-neutral-700">店铺 / 租户</label>
                        <div class="relative">
                            <select id="tenant-select" class="input-lux" required>
                                <option value="" disabled selected>请选择店铺</option>
                            </select>
                        </div>
                        <p id="tenant-hint" class="text-xs text-neutral-500 mt-1">登录前必须选择对应店铺数据库 (bht / wx / rzt)</p>
                    </div>

                    <div class="space-y-2.5">
                        <label class="block text-sm font-medium text-neutral-700">用户名</label>
                        <div class="relative">
                            <input id="login-username" name="username" type="text" class="input-lux" placeholder="请输入用户名" required>
                        </div>
                    </div>

                    <div class="space-y-2.5">
                        <label class="block text-sm font-medium text-neutral-700">密码</label>
                        <div class="relative">
                            <input id="login-password" name="password" type="password" class="input-lux" placeholder="请输入密码" required>
                            <button id="password-toggle" type="button" class="absolute right-5 top-1/2 -translate-y-1/2 text-neutral-400 hover:text-primary transition-colors duration-300 p-1" aria-label="显示或隐藏密码">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-1">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="w-4.5 h-4.5 rounded border-neutral-300 text-primary focus:ring-primary/30 transition-all">
                            <span class="text-sm text-neutral-600">记住登录状态</span>
                        </label>
                        <a href="#" class="text-sm link-elegant">忘记密码?</a>
                    </div>

                    <button type="submit" class="btn-lux mt-3">
                        登录系统
                    </button>
                </form>

                <!-- 分隔线 -->
                <div class="divider-fine relative">
                    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-4 text-xs text-neutral-400">
                        其他登录方式
                    </div>
                </div>

                <!-- 快捷登录 -->
                <div class="flex justify-center gap-6">
                    <button class="w-12 h-12 rounded-full bg-neutral-50 flex items-center justify-center text-neutral-600 hover:bg-primary hover:text-white transition-all duration-300">
                        <i class="fa fa-qrcode"></i>
                    </button>
                    <button class="w-12 h-12 rounded-full bg-neutral-50 flex items-center justify-center text-neutral-600 hover:bg-primary hover:text-white transition-all duration-300">
                        <i class="fa fa-id-card-o"></i>
                    </button>
                </div>
            </div>

            <!-- 页脚 -->
            <footer class="mt-8 text-center">
                <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-xs text-neutral-500">
                    <p>© 2023 智慧药房收银系统</p>
                    <span class="h-3 w-[1px] bg-neutral-300"></span>
                    <a href="#" class="hover:text-primary transition-colors">隐私政策</a>
                    <span class="h-3 w-[1px] bg-neutral-300"></span>
                    <a href="#" class="hover:text-primary transition-colors">服务条款</a>
                    <span class="h-3 w-[1px] bg-neutral-300 hidden sm:inline-block"></span>
                    <a href="#" class="hover:text-primary transition-colors hidden sm:inline-block">
                        <i class="fa fa-question-circle-o mr-1"></i>帮助中心
                    </a>
                </div>
            </footer>
        </div>
    </div>
</div>

<script>
    // 载入租户列表
    async function loadTenants() {
        const sel = document.getElementById('tenant-select');
        try {
            const resp = await fetch('/api/admin/tenants');
            if (!resp.ok) throw new Error('租户列表获取失败');
            const data = await resp.json();
            const tenants = data.tenants || [];
            sel.innerHTML = '<option value="" disabled>请选择店铺</option>' + tenants
                .filter(t => t !== 'default')
                .map(t => `<option value="${t}">${t}</option>`).join('');
            const saved = localStorage.getItem('selectedTenant');
            if (saved && tenants.includes(saved)) { sel.value = saved; }
        } catch (e) {
            console.warn('[Tenant] 列表获取失败, 使用静态回退', e);
            sel.innerHTML = '<option value="" disabled>请选择店铺</option>'+
              ['bht','wx','rzt'].map(t=>`<option value="${t}">${t}</option>`).join('');
        }
    }

    loadTenants();

    // 登录函数
    async function login(username, password, tenantId) {
        if(!tenantId){
            return { success:false, message:'未选择店铺租户'};
        }
        try {
            const response = await fetch('http://localhost:8080/api/auth/login', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-Shop-Id': tenantId
                },
                body: JSON.stringify({ username, password }),
                credentials: 'include'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '登录失败');
            }
            if (result.token) {
                localStorage.setItem('authToken', result.token);
            }
            return { success: true, data: result };
        } catch (error) {
            return { success: false, message: error.message };
        }
    }

    // 显示消息函数 - 修改为在消息容器中显示
    function showMessage(message, type = 'success') {
        const messageContainer = document.getElementById('message-container');
        messageContainer.innerHTML = ''; // 清空之前的内容

        const messageDiv = document.createElement('div');
        messageDiv.className = `p-3 rounded-lg text-center ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
        }`;
        messageDiv.textContent = message;
        messageContainer.appendChild(messageDiv);

        // 3秒后自动移除
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    }

    // 登录表单处理（使用稳定的ID避免 type 切换后选择不到元素）
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('login-username');
    const passwordInput = document.getElementById('login-password');

    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const tenantSel = document.getElementById('tenant-select');
        const tenantId = tenantSel.value;
        if(!tenantId){
            showMessage('请选择店铺后再登录', 'error');
            tenantSel.focus();
            return;
        }
        localStorage.setItem('selectedTenant', tenantId);
        if(!usernameInput || !passwordInput){
            showMessage('页面元素缺失，无法登录', 'error');
            return;
        }
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        if (!username || !password) {
            showMessage('请填写用户名和密码', 'error');
            return;
        }
        const submitBtn = loginForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-2"></i> 登录中...';
        const res = await login(username, password, tenantId);
        if (res.success) {
            // 新增: 缓存登录用户名称供导航显示
            try {
                const userInfo = res.data && res.data.user ? res.data.user : {};
                localStorage.setItem('loginUsername', userInfo.name || username);
                localStorage.setItem('currentUser', userInfo.username || username);
                localStorage.setItem('userRoleId', (userInfo.roleId||'')+ '');
            } catch(err){ console.warn('缓存用户信息失败', err); }
            showMessage('登录成功，即将跳转', 'success');
            setTimeout(() => window.location.href = '/medicine-management.html', 1000);
        } else {
            showMessage('登录失败：' + res.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '登录系统';
        }
    });

    // 密码显示/隐藏切换（使用固定ID）
    const passwordToggleBtn = document.getElementById('password-toggle');
    if(passwordToggleBtn && passwordInput){
        passwordToggleBtn.addEventListener('click', function() {
            const currentType = passwordInput.getAttribute('type');
            const newType = currentType === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', newType);
            const icon = this.querySelector('i');
            if(icon){
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        });
    }
</script>
</body>
</html>