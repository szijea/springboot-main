<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>智慧药房收银系统 - 库存管理</title>
  <link rel="stylesheet" href="css/tailwind.css" />
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/theme-enhanced.css" />
  <link rel="stylesheet" href="css/theme-premium.css" />
  <link rel="stylesheet" href="css/theme-lightwide.css" />
  <link rel="stylesheet" href="css/ui-enhanced.css" />
  <link rel="stylesheet" href="css/layout.css" />
  <link rel="stylesheet" href="css/ui-modern.css" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <style>
    /* 覆盖旧样式为现代布局 */
    .inventory-grid { display:grid; gap:1.25rem; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .search-section-modern { display:flex; flex-direction:column; gap:.75rem; }
    .main-content{flex:1;padding:1.5rem;} .badge{display:inline-block;padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem} .btn{display:inline-flex;align-items:center;gap:.25rem}
    .spinner{border:2px solid #eee;border-top-color:#3b82f6;border-radius:50%;width:18px;height:18px;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="js/common-nav.js" defer></script>
</head>
<body class="font-inter text-gray-800 min-h-screen flex enhanced-ui theme-modern theme-lightwide page-enter modern-ui density-comfortable console-spacing">
  <div id="common-nav" data-active="inventory"></div>
  <main class="flex-1 flex flex-col pt-16">
    <div class="main-content" id="main-content">
      <div class="container-fluid">
        <h2 class="page-title font-bold page-title-decor mb-4">库存管理</h2>
        <p class="text-gray-500 mb-6">查询药品当前库存，按租户环境隔离</p>

        <!-- 租户选择与取消 -->
        <div class="card-modern p-4 mb-4 fade-enter">
          <div class="action-row-modern">
            <div>
              <label for="tenant" class="text-dim text-xs mb-1 block">租户 (可取消)</label>
              <div class="flex items-center gap-2">
                <select id="tenant" class="input-modern w-40">
                  <option value="">(未选择)</option>
                  <option value="bht">bht</option>
                  <option value="wx">wx</option>
                  <option value="rzt">rzt</option>
                </select>
                <button id="btnResetTenant" type="button" class="btn-modern" style="background:#64748b" title="取消租户并使用默认">取消租户</button>
              </div>
              <small class="inline-hint">若取消租户，将使用默认数据源。</small>
            </div>
            <div class="flex-1 min-w-[220px]">
              <label for="medicineId" class="text-dim text-xs mb-1 block">药品ID</label>
              <input id="medicineId" class="input-modern" placeholder="例如 MED001" />
            </div>
            <button id="btnQuery" class="btn-modern mt-6 h-[42px]">查询当前库存</button>
          </div>
          <div class="search-section-modern mt-4">
            <label for="keyword" class="text-dim text-xs">按名称搜索药品</label>
            <div class="flex gap-2">
              <input id="keyword" class="input-modern flex-1" placeholder="输入通用名/商品名关键词" />
              <button id="btnSearchName" class="btn-modern" style="background:#475569">搜索</button>
            </div>
            <div id="searchResults" class="card-modern p-2 hidden"></div>
          </div>
          <div class="mt-4">
            <label for="batchIds" class="text-dim text-xs mb-1 block">批量查询药品ID (逗号分隔)</label>
            <div class="flex gap-2">
              <input id="batchIds" class="input-modern flex-1" placeholder="MED001,MED002,M1763466568444" />
              <button id="btnBatchQuery" class="btn-modern" style="background:#2563eb">批量查询</button>
            </div>
          </div>
        </div>

        <!-- 结果展示 -->
        <div class="card-modern p-4 fade-enter">
          <div id="alert" class="hidden mb-3 p-3 rounded text-sm"></div>
          <h3 class="section-title-modern mb-3">单次查询结果</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left table-modern-compact">
              <thead>
                <tr>
                  <th>租户</th>
                  <th>药品ID</th>
                  <th>当前库存</th>
                  <th>查询时间</th>
                </tr>
              </thead>
              <tbody id="resultBody">
                <!-- 动态填充 -->
              </tbody>
            </table>
          </div>
          <h3 class="section-title-modern mt-8 mb-3">所有药品当前库存 (分页)</h3>
          <div class="flex items-center gap-2 mb-2 text-sm">
            <label>页码 <input id="pageNo" type="number" min="0" value="0" class="input-modern w-20 ml-1" /></label>
            <label>每页 <input id="pageSize" type="number" min="1" value="10" class="input-modern w-20 ml-1" /></label>
            <button id="btnLoadPage" class="btn-modern" style="background:#0d9488">加载</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left table-modern-compact">
              <thead>
                <tr>
                  <th>租户</th>
                  <th>药品ID</th>
                  <th>通用名</th>
                  <th>商品名</th>
                  <th>当前库存</th>
                </tr>
              </thead>
              <tbody id="pageBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- 页面右下角租户ID显示区域（用于检测） -->
    <div id="tenantBadge" class="fixed bottom-3 right-3 bg-gray-900 text-white text-xs px-2 py-1 rounded shadow">租户：<span id="tenantIdDisplay">bht</span></div>
  </main>

  <!-- 全局加载器 -->
  <div id="globalLoading" class="global-loader"><div class="box"><div class="spinner-modern"></div><p>处理中...</p></div></div>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const tenantEl=$('tenant');const medEl=$('medicineId');const btn=$('btnQuery');const alertEl=$('alert');const tbody=$('resultBody');
    const globalLoading=$('globalLoading');
    function setLoading(v){ if(v) globalLoading.classList.add('active'); else globalLoading.classList.remove('active'); }
    function showAlert(type,msg){ alertEl.className='mb-3 p-3 rounded text-sm '+(type==='error'?'bg-red-50 text-red-600 border border-red-200':'bg-green-50 text-green-600 border border-green-200'); alertEl.textContent=msg; alertEl.classList.remove('hidden'); setTimeout(()=>alertEl.classList.add('hidden'),3500); }
    function currentTenant(){ return tenantEl.value || ''; }
    $('btnResetTenant').addEventListener('click',()=>{ tenantEl.value=''; showAlert('success','已取消租户选择，使用默认数据源'); });

    async function fetchCurrentStock(shopId, medicineId){
      const url=`/api/inventory/current-stock?medicineId=${encodeURIComponent(medicineId)}`;
      const headers={ 'Accept':'application/json' }; if(shopId) headers['X-Shop-Id']=shopId;
      const res=await fetch(url,{ headers }); if(!res.ok){ throw new Error('HTTP '+res.status); }
      const data=await res.json().catch(()=>({})); return data.currentStock ?? data.stock ?? 0;
    }
    function appendRow(shopId, medicineId, stock){ const tr=document.createElement('tr'); tr.innerHTML=`<td><span class='badge-soft'>${shopId||'default'}</span></td><td class='font-mono text-xs'>${medicineId}</td><td>${stock}</td><td class='text-dim text-xs'>${new Date().toLocaleString()}</td>`; tbody.prepend(tr); }
    async function fetchJson(url, shopId){ const headers={ 'Accept':'application/json'}; if(shopId) headers['X-Shop-Id']=shopId; const r=await fetch(url,{ headers }); if(!r.ok) throw new Error('HTTP '+r.status); return r.json().catch(()=>({})); }

    function withLock(button, fn){ return async function(){ if(button.disabled) return; button.disabled=true; setLoading(true); try{ await fn(); } catch(e){ showAlert('error', e.message); } finally { button.disabled=false; setLoading(false); } }; }

    btn.addEventListener('click', withLock(btn, async()=>{ const shopId=currentTenant(); const medicineId=medEl.value.trim(); if(!medicineId) { showAlert('error','请输入药品ID'); return; } const stock=await fetchCurrentStock(shopId, medicineId); appendRow(shopId, medicineId, stock); showAlert('success', `查询成功：${medicineId} 库存 ${stock}`); }));

    // 名称搜索
    const keywordEl=$('keyword'); const btnSearchName=$('btnSearchName'); const searchResults=$('searchResults');
    async function searchMedicineByName(shopId, keyword){ const url=`/api/medicine/search?keyword=${encodeURIComponent(keyword)}`; return fetchJson(url, shopId); }
    function renderSearchResults(items){ if(!items || items.length===0){ searchResults.classList.remove('hidden'); searchResults.innerHTML="<div class='empty-state-modern'><i class='fa fa-search'></i><p>未找到匹配药品</p></div>"; return; } const html=items.map(it=>`<div class='flex justify-between items-center p-2 border-b'> <div><div class='font-mono text-xs'>${it.medicineId||''}</div><div class='text-xs text-dim'>${it.genericName||''} ${it.tradeName?'/ '+it.tradeName:''}</div></div><button class='btn-modern select-med' data-med='${it.medicineId||''}' style='background:#2563eb'>选择</button></div>`).join(''); searchResults.classList.remove('hidden'); searchResults.innerHTML=html; searchResults.querySelectorAll('.select-med').forEach(b=> b.addEventListener('click', async(e)=>{ const id=e.currentTarget.dataset.med; medEl.value=id; const shopId=currentTenant(); try{ const stock=await fetchCurrentStock(shopId,id); appendRow(shopId,id,stock); showAlert('success',`查询成功：${id} 库存 ${stock}`); }catch(err){ showAlert('error',err.message); } })); }
    btnSearchName.addEventListener('click', withLock(btnSearchName, async()=>{ const kw=keywordEl.value.trim(); if(!kw){ showAlert('error','请输入关键词'); return; } const items=await searchMedicineByName(currentTenant(), kw); renderSearchResults(items); }));

    // 批量查询
    const batchIdsEl=$('batchIds'); const btnBatchQuery=$('btnBatchQuery');
    btnBatchQuery.addEventListener('click', withLock(btnBatchQuery, async()=>{ const raw=batchIdsEl.value.trim(); if(!raw){ showAlert('error','请输入多个药品ID'); return; } const ids=[...new Set(raw.split(',').map(s=>s.trim()).filter(Boolean))]; if(!ids.length){ showAlert('error','未解析到有效ID'); return; } const data=await fetchJson(`/api/inventory/current-stocks?ids=${encodeURIComponent(ids.join(','))}`, currentTenant()); const list=Array.isArray(data)?data:(data.results||[]); list.forEach(item=>{ const mid=item.medicineId||item.id; const stock=item.currentStock??item.stock??0; appendRow(currentTenant(), mid, stock); }); showAlert('success', `批量查询完成：${ids.length} 个ID`); }));

    // 分页加载
    const pageNoEl=$('pageNo'); const pageSizeEl=$('pageSize'); const btnLoadPage=$('btnLoadPage'); const pageBody=$('pageBody');
    async function loadPage(shopId, pageNo, pageSize){ const data=await fetchJson(`/api/inventory/page-current-stocks?page=${pageNo}&size=${pageSize}`, shopId); const list=Array.isArray(data)?data:(data.content||[]); pageBody.innerHTML=list.map(item=>`<tr><td><span class='badge-soft'>${shopId||'default'}</span></td><td class='font-mono text-xs'>${item.medicineId||''}</td><td class='text-xs'>${item.genericName||''}</td><td class='text-xs'>${item.tradeName||''}</td><td>${item.currentStock??item.stock??0}</td></tr>`).join(''); }
    btnLoadPage.addEventListener('click', withLock(btnLoadPage, async()=>{ const pn=Number(pageNoEl.value)||0; const ps=Number(pageSizeEl.value)||10; await loadPage(currentTenant(), pn, ps); showAlert('success','分页列表加载完成'); }));
  })();
  </script>
</body>
</html>
