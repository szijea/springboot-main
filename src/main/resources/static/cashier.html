<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 收银管理</title>
    <link rel="stylesheet" href="/css/tailwind.css" />
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#165DFF',
                secondary: '#36B37E',
                accent: '#FF5630',
              },
              fontFamily: {
                inter: ['Inter', 'system-ui', 'sans-serif'],
              },
            },
          }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
          .sidebar-item {
            @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
          }
          .sidebar-item.active {
            @apply bg-primary text-white;
          }
          .sidebar-item:not(.active):hover {
            @apply bg-gray-100;
          }
          .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md;
          }
          .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
          }
          .btn-primary {
            @apply bg-primary text-white hover:bg-primary/90;
          }
          .btn-outline {
            @apply border border-gray-300 hover:bg-gray-50;
          }
          .btn-danger {
            @apply bg-accent text-white hover:bg-accent/90;
          }
          .input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all;
          }
          .badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
          }

          /* 核心滚动条修复 */
          .main-content {
            @apply flex-1 p-6 bg-gray-50;
            height: calc(100vh - 64px);
            overflow-y: scroll;
            scrollbar-width: thin;
          }

          .main-content::-webkit-scrollbar {
            width: 8px;
          }
          .main-content::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
          }
          .main-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
          }
          .main-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
          }

          .scroll-container::-webkit-scrollbar {
            width: 6px;
          }
          .scroll-container::-webkit-scrollbar-track {
            background: #f9fafb;
          }
          .scroll-container::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 3px;
          }
        }
    </style>

    <!-- 如果未加载 tailwind (生产不建议 CDN，仅兜底防止 tailwind 未定义报错) -->
    <script>
      if(typeof tailwind==='undefined'){ window.tailwind={ config:{}, }; }
    </script>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex">
<!-- 注入统一导航（侧边栏 + 顶部） -->
<div id="common-nav" data-active="cashier"></div>

<main class="flex-1 flex flex-col pt-16">
    <!-- 可滚动内容区 -->
    <div class="main-content">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h2 class="text-[clamp(1.25rem,2vw,1.75rem)] font-bold">收银管理</h2>
                <p class="text-gray-500">药品销售与结算</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline" id="hang-order-btn">
                    <i class="fa fa-pause"></i> 挂单
                </button>
                <button class="btn btn-outline" id="load-order-btn">
                    <i class="fa fa-play"></i> 取单
                </button>
                <button class="btn btn-danger" id="clear-cart-btn">
                    <i class="fa fa-trash"></i> 清空
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 药品搜索与选择 -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h3 class="font-bold mb-4">药品搜索</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品名称</label>
                            <div class="flex gap-2">
                                <input type="text" class="input flex-1" id="medicine-search-input" placeholder="请输入药品名称或条形码">
                                <button class="btn btn-primary whitespace-nowrap" id="search-medicine-btn">
                                    <i class="fa fa-search"></i> 搜索
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品分类</label>
                            <select class="input" id="category-filter">
                                <option value="">全部分类</option>
                                <option value="感冒药">感冒药</option>
                                <option value="消炎药">消炎药</option>
                                <option value="慢性病药">慢性病药</option>
                                <option value="维生素类">维生素类</option>
                            </select>
                        </div>
                    </div>

                    <div class="relative">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">药品名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">规格</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">批号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单价</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">库存</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="medicine-list-body">
                            <!-- 药品列表将通过JavaScript动态加载 -->
                            </tbody>
                        </table>

                        <!-- 加载状态 -->
                        <div id="loading-indicator" class="hidden text-center py-8">
                            <i class="fa fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                            <p class="text-gray-500">搜索中...</p>
                        </div>

                        <!-- 空状态 -->
                        <div id="empty-state" class="hidden text-center py-12">
                            <i class="fa fa-search text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">未找到相关药品</p>
                            <p class="text-sm text-gray-400 mt-1">请尝试其他搜索关键词</p>
                        </div>

                        <div class="flex justify-between items-center mt-4 text-sm">
                            <div class="text-gray-500" id="search-result-info">请输入关键词搜索</div>
                            <div class="flex gap-1" id="pagination-controls">
                                <!-- 分页控件将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 购物车与结算 -->
            <div class="space-y-6">
                <!-- 会员信息部分 -->
                <div class="card p-6">
                    <h3 class="font-bold mb-4">客户信息</h3>

                    <!-- 添加客户姓名输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">客户姓名 *</label>
                        <input type="text" class="input" id="customerName" placeholder="请输入客户姓名">
                        <p class="text-xs text-gray-500 mt-1">如不填写将自动生成匿名客户</p>
                    </div>

                    <div class="flex gap-3 mb-4">
                        <input type="text" class="input" id="member-search-input" placeholder="请输入会员姓名、手机号或卡号">
                        <button class="btn btn-primary whitespace-nowrap" id="search-member-btn">
                            <i class="fa fa-search"></i> 查找
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 hidden" id="member-info">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <p class="font-medium" id="member-name"></p>
                                <p class="text-sm text-gray-500" id="member-level"></p>
                            </div>
                            <button class="btn btn-outline text-sm" id="clear-member-btn">
                                <i class="fa fa-times"></i> 清除
                            </button>
                        </div>
                        <div class="text-sm">
                            <p>积分: <span id="member-points">0</span></p>
                            <p class="text-secondary">可享受会员价</p>
                        </div>
                    </div>
                </div>

                <!-- 购物车 -->
                <div class="card">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold">购物车</h3>
                            <span class="text-sm text-gray-500" id="cart-count">0种药品</span>
                        </div>
                    </div>
                    <div class="max-h-80 overflow-y-auto scroll-container" id="cart-items">
                        <!-- 购物车为空时显示 -->
                        <div class="flex flex-col items-center justify-center p-8 text-gray-500">
                            <i class="fa fa-shopping-cart text-4xl mb-3 opacity-30"></i>
                            <p>购物车为空，请添加药品</p>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-100">
                        <!-- 结算信息 -->
                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">商品总价:</span>
                                <span id="total-price">¥0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">会员折扣:</span>
                                <span id="discount">-¥0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">积分抵扣:</span>
                                <span id="points-discount">-¥0.00</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-200">
                                <span class="font-medium">实付金额:</span>
                                <span class="font-bold text-xl text-primary" id="payable-amount">¥0.00</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-medium text-sm mb-2">支付方式</h4>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="cash">
                                    <i class="fa fa-money text-lg text-green-600 mb-1"></i>
                                    <span class="text-xs">现金</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="wechat">
                                    <i class="fa fa-weixin text-lg text-green-500 mb-1"></i>
                                    <span class="text-xs">微信</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="alipay">
                                    <i class="fa fa-alipay text-lg text-blue-500 mb-1"></i>
                                    <span class="text-xs">支付宝</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="insurance">
                                    <i class="fa fa-hospital-o text-lg text-purple-500 mb-1"></i>
                                    <span class="text-xs">医保</span>
                                </button>
                            </div>

                            <button class="btn btn-primary w-full justify-center" id="pay-btn" disabled>
                                <i class="fa fa-credit-card"></i> 确认支付
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 注入统一导航脚本 -->
<script src="js/common-nav.js"></script>
<script src="js/common.js"></script>

<!-- 支付确认模态框 -->
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h3 class="font-bold text-lg mb-4">确认支付</h3>
        <div class="mb-4">
            <p class="text-gray-600">订单总金额: <span class="font-bold text-xl text-primary" id="modal-total">¥0.00</span></p>
            <p class="text-sm text-gray-500 mt-1">支付方式: <span id="modal-payment-method">现金</span></p>
        </div>
        <div class="flex gap-3">
            <button class="btn btn-outline flex-1" id="cancel-payment">取消</button>
            <button class="btn btn-primary flex-1" id="confirm-payment">确认支付</button>
        </div>
    </div>
</div>

<script>
    // 修改租户列表 rzt_db -> rzt
function ensureTenant() {
    const existing = localStorage.getItem('selectedTenant');
    if (existing) {
        console.log('[Tenant] 已选择租户:', existing);
        return existing;
    }
    const tenants = [ {id:'bht', name:'博海堂'}, {id:'wx', name:'文轩店'}, {id:'rzt', name:'仁泽堂'} ];
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg w-96 shadow-lg p-6">
        <h3 class="text-lg font-bold mb-4">请选择当前门店</h3>
        <div class="space-y-2 mb-4">
          ${tenants.map(t=>`<button data-id="${t.id}" class="tenant-btn w-full px-3 py-2 rounded border hover:bg-primary/10 flex justify-between items-center">
              <span>${t.name}</span><span class='text-xs text-gray-500'>${t.id}</span>
          </button>`).join('')}
        </div>
        <p class="text-xs text-gray-500">选择后会记住在本地，可随时通过开发者工具修改 selectedTenant。</p>
      </div>`;
    document.body.appendChild(modal);
    modal.querySelectorAll('.tenant-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const id = btn.getAttribute('data-id');
            localStorage.setItem('selectedTenant', id);
            console.log('[Tenant] 已设置租户为', id);
            modal.remove();
            // 可在选择后自动刷新会员或库存数据
        });
    });
    return null;
}

// 修改：会员搜索函数使用 quick-search + fallback
async function searchMember() {
    const searchInput = document.getElementById('member-search-input');
    if (!searchInput) return;
    const keyword = searchInput.value.trim();
    if (!keyword) {
        showMessage('请输入会员姓名、手机号或卡号', 'error');
        return;
    }
    const tenant = localStorage.getItem('selectedTenant');
    console.log('=== 开始搜索会员 ===');
    console.log('租户:', tenant, '关键词:', keyword);
    try {
        let response = null;
        // 优先 quick-search
        const quickUrl = `/api/members/quick-search?keyword=${encodeURIComponent(keyword)}`;
        console.log('[MemberSearch] 请求 quick-search:', quickUrl);
        response = await fetch(quickUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                ...(tenant? {'X-Shop-Id': tenant}: {})
            }
        }).then(r=>r.json()).catch(e=>{ console.warn('quick-search 请求异常, fallback:', e); return null; });

        let usedEndpoint = 'quick-search';
        if (!response || response.code !== 200) {
            const searchUrl = `/api/members/search?keyword=${encodeURIComponent(keyword)}&page=1&size=10`;
            console.log('[MemberSearch] 使用 fallback /search:', searchUrl);
            response = await fetch(searchUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    ...(tenant? {'X-Shop-Id': tenant}: {})
                }
            }).then(r=>r.json());
            usedEndpoint = 'search';
        }
        console.log(`[MemberSearch] 使用接口: ${usedEndpoint} 响应:`, response);
        if (response && response.code === 200 && Array.isArray(response.data) && response.data.length > 0) {
            currentMember = response.data[0];
            if (!currentMember.id && currentMember.memberId) currentMember.id = currentMember.memberId;
            const customerNameInput = document.getElementById('customerName');
            if (customerNameInput) customerNameInput.value = currentMember.name;
            displayMemberInfo(currentMember);
            updateCart();
            showMessage(`找到会员: ${currentMember.name}`);
        } else {
            console.warn('[MemberSearch] 无匹配会员 数据对象:', response);
            if (tenant) {
                showMessage(`该门店(${tenant})下未找到匹配会员`, 'error');
            } else {
                showMessage('未找到匹配的会员 (尚未选择门店)', 'error');
            }
            clearMemberInfo();
        }
    } catch (error) {
        console.error('搜索会员失败:', error);
        let msg = '搜索会员失败: ' + error.message;
        if (error.message.includes('Failed to fetch')) msg += ' (可能后端未启动)';
        showMessage(msg, 'error');
        clearMemberInfo();
    }
}

// 全局变量
    let cart = [];
    let currentMember = null;
    let selectedPaymentMethod = null;
    let currentPage = 1;
    const pageSize = 10;
    let totalMedicines = 0;

    // ========== 工具函数 ==========
    function showLoadingState() {
        const body = document.getElementById('medicine-list-body');
        const indicator = document.getElementById('loading-indicator');
        const empty = document.getElementById('empty-state');

        if (body) body.classList.add('hidden');
        if (indicator) indicator.classList.remove('hidden');
        if (empty) empty.classList.add('hidden');
    }

    function showErrorState(message) {
        const body = document.getElementById('medicine-list-body');
        const indicator = document.getElementById('loading-indicator');
        const empty = document.getElementById('empty-state');

        if (body) body.classList.add('hidden');
        if (indicator) indicator.classList.add('hidden');
        if (empty) {
            empty.classList.remove('hidden');
            empty.innerHTML = `
                <i class="fa fa-exclamation-triangle text-2xl text-yellow-500 mb-2"></i>
                <p class="text-gray-500">${message}</p>
            `;
        }
    }

    function getStockStatusClass(stock) {
        if (!stock || stock <= 0) return 'text-red-600';
        if (stock <= 10) return 'text-yellow-600';
        return 'text-green-600';
    }

    // ��示消息提示
    function showMessage(message, type = 'success') {
        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        messageDiv.innerHTML = `
            <i class="fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
            ${message}
        `;

        document.body.appendChild(messageDiv);

        // 3秒后自动移除
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }

    // ========== 购物车相关函数 ==========
    function updateCart() {
        const cartItems = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const totalPrice = document.getElementById('total-price');
        const discount = document.getElementById('discount');
        const pointsDiscount = document.getElementById('points-discount');
        const payableAmount = document.getElementById('payable-amount');
        const payBtn = document.getElementById('pay-btn');

        if (!cartItems) return;

        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 text-gray-500">
                    <i class="fa fa-shopping-cart text-4xl mb-3 opacity-30"></i>
                    <p>购物车为空，请添加药品</p>
                </div>
            `;
            if (cartCount) cartCount.textContent = '0种药品';
            if (totalPrice) totalPrice.textContent = '¥0.00';
            if (discount) discount.textContent = '-¥0.00';
            if (pointsDiscount) pointsDiscount.textContent = '-¥0.00';
            if (payableAmount) payableAmount.textContent = '¥0.00';
            if (payBtn) payBtn.disabled = true;
            return;
        }

        let html = '';
        let total = 0;
        let originalTotal = 0;
        let discountAmount = 0;

        cart.forEach(item => {
            const actualPrice = currentMember && item.memberPrice ? item.memberPrice : item.price;
            const itemTotal = actualPrice * item.quantity;
            const itemOriginalTotal = item.price * item.quantity;

            total += itemTotal;
            originalTotal += itemOriginalTotal;
            discountAmount += (itemOriginalTotal - itemTotal);

            // 检查库存状态
            const stockStatus = item.quantity > item.stock ? 'text-red-600' : 'text-gray-500';
            const stockWarning = item.quantity > item.stock ?
                `<div class="text-xs text-red-600 mt-1">超出库存! 库存: ${item.stock}</div>` : '';

            html += `
                <div class="p-4 border-b border-gray-100">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium">${item.name}</h4>
                            <p class="text-sm text-gray-500">${item.spec}</p>
                            ${item.isRx ? '<span class="inline-block mt-1 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">处方药</span>' : ''}
                            <div class="flex items-center mt-2">
                                <button class="w-6 h-6 flex items-center justify-center rounded border border-gray-300 decrease-qty" data-id="${item.id}">-</button>
                                <span class="mx-2">${item.quantity}</span>
                                <button class="w-6 h-6 flex items-center justify-center rounded border border-gray-300 increase-qty" data-id="${item.id}">+</button>
                            </div>
                            ${stockWarning}
                        </div>
                        <div class="text-right">
                            <p class="font-medium">${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(itemTotal) : '¥' + itemTotal.toFixed(2)}</p>
                            ${currentMember && item.memberPrice ?
                                `<p class="text-xs text-gray-500 line-through">${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(itemOriginalTotal) : '¥' + itemOriginalTotal.toFixed(2)}</p>` : ''}
                            <button class="text-red-500 text-sm mt-1 remove-item" data-id="${item.id}">删除</button>
                        </div>
                    </div>
                </div>
            `;
        });

        cartItems.innerHTML = html;
        if (cartCount) cartCount.textContent = `${cart.length}种药品`;
        if (totalPrice) totalPrice.textContent = window.api?.utils?.formatPrice ? window.api.utils.formatPrice(originalTotal) : '¥' + originalTotal.toFixed(2);
        if (discount) discount.textContent = `-${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(discountAmount) : '¥' + discountAmount.toFixed(2)}`;
        if (payableAmount) payableAmount.textContent = window.api?.utils?.formatPrice ? window.api.utils.formatPrice(total) : '¥' + total.toFixed(2);

        // 检查是否有商品超出库存
        const hasOverstock = cart.some(item => item.quantity > item.stock);
        if (payBtn) {
            payBtn.disabled = hasOverstock || !selectedPaymentMethod;
            if (hasOverstock) {
                payBtn.title = '有商品数量超出库存，请调整数量';
            }
        }

        // 重新绑定事件
        document.querySelectorAll('.decrease-qty').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const item = cart.find(item => item.id === id);
                if (item && item.quantity > 1) {
                    item.quantity -= 1;
                    updateCart();
                }
            });
        });

        document.querySelectorAll('.increase-qty').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const item = cart.find(item => item.id === id);
                if (item) {
                    // 检查库存
                    if (item.quantity >= item.stock) {
                        showMessage(`${item.name} 库存不足，当前库存: ${item.stock}`, 'error');
                        return;
                    }
                    item.quantity += 1;
                    updateCart();
                }
            });
        });

        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                cart = cart.filter(item => item.id !== id);
                updateCart();
            });
        });
    }

    function clearCart() {
        if (cart.length > 0 && confirm('确定要清空购物车吗？')) {
            cart = [];
            updateCart();
            showMessage('购物车已清空');
        }
    }

    function updateCheckoutButton() {
        const checkoutBtn = document.getElementById('pay-btn');
        if (checkoutBtn) {
            checkoutBtn.disabled = cart.length === 0 || !selectedPaymentMethod;
        }
    }

    function showAddToCartFeedback(medicineName) {
        const feedback = document.createElement('div');
        feedback.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
        feedback.innerHTML = `
            <i class="fa fa-check-circle mr-2"></i>
            已添加 ${medicineName} 到购物车
        `;
        document.body.appendChild(feedback);

        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.remove();
            }
        }, 2000);
    }

    // ========== 搜索和分页相关函数 ==========
    async function performMedicineSearch() {
        try {
            const searchInput = document.getElementById('medicine-search-input');
            const categoryFilter = document.getElementById('category-filter');
            const keyword = searchInput ? searchInput.value.trim() : '';
            const category = categoryFilter ? categoryFilter.value : '';
            // 先药品搜索
            let primaryResp = await window.api.medicineAPI.searchWithStock(keyword, category, 1, 100);
            if(primaryResp.code===200 && Array.isArray(primaryResp.data) && primaryResp.data.length>0){
                handleSearchResponse(primaryResp);
            } else if(keyword){
                // 回退批号搜索
                console.log('药品搜索为空，尝试批号搜索:', keyword);
                let batchResp = await window.api.inventoryAPI.searchByBatch(keyword);
                // 将库存DTO适配为药品列表结构
                if(batchResp.code===200){
                    const adapted = (batchResp.data||[]).map(dto=>({
                        medicineId: dto.medicineId,
                        genericName: dto.genericName || dto.tradeName,
                        tradeName: dto.tradeName,
                        spec: dto.spec,
                        retailPrice: dto.retailPrice,
                        stockQuantity: dto.stockQuantity,
                        batch: dto.batchNo,
                        isRx: false
                    }));
                    handleSearchResponse({code:200,message:'success',data:adapted});
                } else {
                    handleSearchResponse(batchResp);
                }
            } else {
                handleSearchResponse(primaryResp);
            }
        } catch(e){
            console.error('搜索异常:', e);
            handleSearchResponse({code:500,message:e.message,data:[]});
        }
    }

    // 添加响应处理函数
    function handleSearchResponse(response) {
        console.log('完整的搜索响应:', response);
        console.log('响应数据:', response.data);
        console.log('数据长度:', response.data ? response.data.length : 0);
        console.log('响应消息:', response.message);

        if (response.code === 200) {
            updateMedicineList(response.data);

            if (!response.data || response.data.length === 0) {
                console.log('没有搜索结果');
            }
        } else {
            throw new Error(response.message || '搜索失败');
        }
    }

    function updateMedicineList(medicines) {
        const tbody = document.getElementById('medicine-list-body');
        const indicator = document.getElementById('loading-indicator');
        const empty = document.getElementById('empty-state');
        const resultInfo = document.getElementById('search-result-info');

        // 隐藏加载状态
        if (indicator) indicator.classList.add('hidden');

        console.log('更新药品列表，数据:', medicines);

        if (!medicines || medicines.length === 0) {
            console.log('没有找到药品，显示空状态');
            if (empty) empty.classList.remove('hidden');
            if (tbody) tbody.classList.add('hidden');
            if (resultInfo) resultInfo.textContent = '未找到相关药品';
            return;
        }

        if (empty) empty.classList.add('hidden');
        if (tbody) tbody.classList.remove('hidden');

        console.log('找到药品数量:', medicines.length);

        // 合并同名同规格药品（按 name + spec 聚合），累加库存并收集批号
        const grouped = {};
        medicines.forEach(m => {
            const name = m.genericName || m.name || '未知药品';
            const spec = m.spec || m.specification || '';
            const key = name + '||' + spec;
            if (!grouped[key]) {
                grouped[key] = {
                    name: name,
                    spec: spec,
                    price: m.retailPrice || m.price || 0,
                    memberPrice: m.memberPrice || null,
                    unit: m.unit || '盒',
                    isRx: m.isRx,
                    medicineId: m.medicineId || m.id || (key.replace(/\s+/g,'_')),
                    stockQuantity: 0,
                    batches: []
                };
            }
            const qty = Number(m.stockQuantity || m.totalStock || 0) || 0;
            grouped[key].stockQuantity += qty;
            // 收集批号（如果有）并去重
            if (m.batch) {
                if (!grouped[key].batches.includes(m.batch)) grouped[key].batches.push(m.batch);
            }
        });

        const deduped = Object.keys(grouped).map(k => grouped[k]);

        // 生成药品列表HTML
        const html = deduped.map(medicine => {
            const batches = (medicine.batches && medicine.batches.length) ? medicine.batches : [];
            const batchPreview = batches.length ? batches.slice(0,3).join(', ') : '';
            return `<tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center mr-3"><i class="fa fa-pills text-primary"></i></div>
                        <div><div class="text-sm font-medium">${medicine.name}</div>${medicine.isRx?'<div class="text-xs text-red-700">处方药</div>':''}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${medicine.spec || '暂无规格'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-xs">${batchPreview || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium">¥${(medicine.price||0).toFixed(2)}</div>
                    ${medicine.memberPrice?`<div class="text-xs text-secondary">会员 ¥${medicine.memberPrice.toFixed(2)}</div>`:''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="${getStockStatusClass(medicine.stockQuantity)} font-medium">${medicine.stockQuantity} ${medicine.unit||'件'}</span>${medicine.stockQuantity<=10&&medicine.stockQuantity>0?'<span class="ml-1 text-xs text-yellow-600">(低库存)</span>':''}${medicine.stockQuantity===0?'<span class="ml-1 text-xs text-red-600">(缺货)</span>':''}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="btn btn-primary text-sm px-3 py-1 add-to-cart" data-id="${medicine.medicineId}" data-name="${medicine.name}" data-price="${medicine.price}" data-member-price="${medicine.memberPrice}" data-spec="${medicine.spec}" data-batches="${batches.join('|')}" data-batch="${batches[0]||''}" data-is-rx="${medicine.isRx}" data-stock="${medicine.stockQuantity}" ${medicine.stockQuantity<=0?'disabled':''}>
                        <i class="fa fa-plus-circle"></i>${medicine.stockQuantity<=0?' 缺货':' 加入购物车'}
                    </button>
                </td>
            </tr>`;
        }).join('');

        if (tbody) tbody.innerHTML = html;
        if (resultInfo) resultInfo.textContent = `找到 ${medicines.length} 个药品`;

        // 重新绑定加入购物车事件
        rebindAddToCartEvents();
    }

    function rebindAddToCartEvents() {
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                if (this.disabled) return;

                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const price = parseFloat(this.getAttribute('data-price'));
                const memberPrice = this.getAttribute('data-member-price') ? parseFloat(this.getAttribute('data-member-price')) : null;
                const spec = this.getAttribute('data-spec');
                const batches = (this.getAttribute('data-batches') || '').split('|').filter(Boolean);
                const selectedBatch = this.getAttribute('data-batch') || (batches[0] || '');
                const isRx = this.getAttribute('data-is-rx') === 'true';
                const stock = parseInt(this.getAttribute('data-stock'));

                // 检查库存
                if (stock <= 0) {
                    showMessage(`${name} 已缺货，无法添加`, 'error');
                    return;
                }

                // 检查是否已在购物车中（按 id + batch 合并）
                const existingItem = cart.find(item => item.id === id && item.batch === selectedBatch);
                if (existingItem) {
                    // 检查库��是否足够
                    if (existingItem.quantity >= stock) {
                        showMessage(`${name} 库存不足，当前库存: ${stock}`, 'error');
                        return;
                    }
                    existingItem.quantity += 1;
                } else {
                    // 检查库存是否足够
                    if (1 > stock) {
                        showMessage(`${name} 库存不足，当前库存: ${stock}`, 'error');
                        return;
                    }
                    cart.push({
                        id,
                        name,
                        price,
                        memberPrice,
                        spec,
                        batch: selectedBatch,
                        batches,
                        isRx,
                        stock, // 保存库存信息用于后续检查
                        quantity: 1
                    });
                }

                updateCart();
                showAddToCartFeedback(name);
            });
        });
    }

    // ========== 会员相关函数 ==========
    async function searchMember() {
        const searchInput = document.getElementById('member-search-input');
        if (!searchInput) return;

        const keyword = searchInput.value.trim();
        if (!keyword) {
            showMessage('请输入会员姓名、手机号或卡号', 'error');
            return;
        }

        console.log('=== 开始搜索会员 ===');
        console.log('搜索关键词:', keyword);

        try {
            let response;

            // 检查 API 对象
            console.log('API对象状态:', {
                api: typeof window.api,
                memberAPI: typeof window.api?.memberAPI,
                search: typeof window.api?.memberAPI?.search
            });

            // 方法1: 使用 memberAPI.search
            if (window.api?.memberAPI?.search && typeof window.api.memberAPI.search === 'function') {
                console.log('使用方法1: memberAPI.search');
                response = await window.api.memberAPI.search(keyword);
            }
            // 方法2: 直接调用 API
            else {
                console.log('使用方法2: 直接 API 调用');
                const url = `http://localhost:8080/api/members/search?keyword=${encodeURIComponent(keyword)}&page=1&size=10`;
                console.log('请求URL:', url);

                const apiResponse = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!apiResponse.ok) {
                    throw new Error(`HTTP error! status: ${apiResponse.status}`);
                }

                response = await apiResponse.json();
            }

            console.log('会员搜索响应:', response);

            if (response.code === 200 && response.data && response.data.length > 0) {
                currentMember = response.data[0];
                // 确保会员对象有ID字段
                if (!currentMember.id && currentMember.memberId) {
                    currentMember.id = currentMember.memberId;
                }
                // 同步更新客户姓名
                const customerNameInput = document.getElementById('customerName');
                if (customerNameInput) {
                    customerNameInput.value = currentMember.name;
                }

                displayMemberInfo(currentMember);
                updateCart();
                showMessage(`找到会员: ${currentMember.name}`);
            } else {
                showMessage('未找到匹配的会员', 'error');
                clearMemberInfo();
            }
        } catch (error) {
            console.error('搜索会员失败:', error);
            console.error('错误详情:', error.message);

            let errorMessage = '搜索会员失败: ' + error.message;
            if (error.message.includes('Failed to fetch')) {
                errorMessage += ' (网络连接失败，请检查后端服务是否启动)';
            }

            showMessage(errorMessage, 'error');
            clearMemberInfo();
        }
    }

    function displayMemberInfo(member) {
        console.log('=== 显示会员信息 ===');
        console.log('会员数据:', member);

        const container = document.getElementById('member-info');
        const nameEl = document.getElementById('member-name');
        const levelEl = document.getElementById('member-level');
        const pointsEl = document.getElementById('member-points');

        if (!container || !nameEl || !levelEl || !pointsEl) {
            console.error('会员信息显示元素未找到');
            return;
        }

        if (nameEl) nameEl.textContent = member.name || '未知';
        if (levelEl) levelEl.textContent = getMemberLevelText(member.level || 0);
        if (pointsEl) pointsEl.textContent = member.points || 0;
        if (container) container.classList.remove('hidden');

        console.log('会员信息显示完成');
    }

    function getMemberLevelText(level) {
        switch(level) {
            case 0: return '普通会员';
            case 1: return '银卡会员';
            case 2: return '金卡会员';
            case 3: return '白金会员';
            default: return '普通会员';
        }
    }

    function clearMemberInfo() {
        currentMember = null;
        const container = document.getElementById('member-info');
        const searchInput = document.getElementById('member-search-input');

        if (container) container.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        updateCart();
    }

    // ========== 订单创建函数 ==========
    async function createOrder(orderData) {
        console.log('=== 创建订单 ===');
        console.log('订单数据:', orderData);
        try {
            // 统一通过 window.api.orderAPI 确保携带租户头
            const result = await window.api.orderAPI.create(orderData);
            return result;
        } catch (err){
            console.error('orderAPI.create 调用失败, 详细: ', err);
            throw err;
        }
    }

    // ========== 支付相关函数 ==========
    function processPayment() {
        console.log('=== 开始处理支付 ===');

        try {
            // 获取客户姓名
            const customerNameInput = document.getElementById('customerName');
            let customerName = customerNameInput ? customerNameInput.value.trim() : '';

            if (!customerName) {
                customerName = "匿名客户_" + Date.now();
            }

            // 检查购物车
            if (!cart || cart.length === 0) {
                alert('购物车为空，请添加商品！');
                return;
            }

            // 计算折扣金额
            let originalTotal = 0;
            let discountAmount = 0;
            let finalTotal = 0;

            cart.forEach(item => {
                const itemOriginalTotal = item.price * item.quantity;
                const itemFinalTotal = currentMember && item.memberPrice ?
                    item.memberPrice * item.quantity : itemOriginalTotal;

                originalTotal += itemOriginalTotal;
                finalTotal += itemFinalTotal;
                discountAmount += (itemOriginalTotal - itemFinalTotal);
            });

            // 构建订单数据 - 修复会员ID问题并添加折扣信息
            const orderData = {
                customerName: customerName,
                items: cart.map(item => {
                    console.log(`商品ID: "${item.id}" (类型: ${typeof item.id})`);

                    return {
                        productId: item.id,  // 使用字符串ID
                        productName: item.name,
                        quantity: Number(item.quantity),
                        unitPrice: Number(item.price),
                        // 添加会员价，让后端知道折扣
                        memberPrice: currentMember && item.memberPrice ?
                            Number(item.memberPrice) : null,
                        // 添加其他必要字段
                        specification: item.spec || '',
                        isRx: item.isRx || false
                    };
                }),
                // 关键修复：确保会员ID正确传递
                memberId: currentMember ? (currentMember.memberId || currentMember.id) : null,
                // 添加支付方式
                paymentMethod: selectedPaymentMethod || 'cash',
                // 计算总金额 - 使用前端计算的折扣后金额
                totalAmount: finalTotal,
                // 添加折扣金额，让后端知道折扣
                discountAmount: discountAmount,
                // 原始总金额
                originalAmount: originalTotal
            };

            console.log('发送的订单数据:', orderData);
            console.log('当前会员信息:', currentMember);
            console.log('会员ID:', currentMember ? (currentMember.memberId || currentMember.id) : '无会员');
            console.log('折扣金额:', discountAmount);

            // 验证数据完整性
            const validationError = validateOrderData(orderData);
            if (validationError) {
                alert(validationError);
                return;
            }

            // 显示加载状态
            const payBtn = document.getElementById('pay-btn');
            const originalText = payBtn ? payBtn.innerHTML : '';
            if (payBtn) {
                payBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 支付中...';
                payBtn.disabled = true;
            }

            // 创建订单
            createOrder(orderData)
                .then(response => {
                    console.log('订单创建成功:', response);

                    // 清空购物车
                    cart = [];
                    updateCart();

                    // 清空客户姓名
                    if (customerNameInput) {
                        customerNameInput.value = '';
                    }

                    // 清空会员信息
                    clearMemberInfo();

                    // 重置支付方式
                    selectedPaymentMethod = null;
                    document.querySelectorAll('.payment-method').forEach(btn => {
                        btn.classList.remove('bg-primary/10', 'border-primary');
                        btn.classList.add('btn-outline');
                    });

                    showMessage(`下单成功！订单号: ${response.orderId || response.data?.orderNumber || response.data?.orderId || response.id || '未知'}`);
                })
                .catch(error => {
                    console.error('下单失败:', error);
                    // 显示更详细的错误信息
                    const errorMsg = error.message.includes('详情:') ?
                        error.message :
                        `下单失败: ${error.message}`;
                    alert(errorMsg);
                })
                .finally(() => {
                    // 恢复按钮状态
                    if (payBtn) {
                        payBtn.innerHTML = originalText;
                        payBtn.disabled = false;
                    }
                });

        } catch (error) {
            console.error('processPayment 函数执行出错:', error);
            alert('支付处理出错: ' + error.message);

            const payBtn = document.getElementById('pay-btn');
            if (payBtn) {
                payBtn.innerHTML = '<i class="fa fa-credit-card"></i> 确认支付';
                payBtn.disabled = false;
            }
        }
    }

    // 添加订单数据验证函数
    function validateOrderData(order){ if(!order.items || !Array.isArray(order.items) || order.items.length===0) return '订单没有商品'; if(order.totalAmount<0) return '金额非法'; return null; }

    // ========== 挂单相关函数 ==========
    async function hangOrder() {
        try {
            if (cart.length === 0) {
                showMessage('购物车为空，无法挂单', 'error');
                return;
            }

            // 获取客户姓名
            const customerNameInput = document.getElementById('customerName');
            let customerName = customerNameInput ? customerNameInput.value.trim() : '';

            if (!customerName) {
                customerName = "匿名客户_" + Date.now();
            }

            // 构建挂单数据
            const hangOrderData = {
                customerName: customerName,
                items: cart.map(item => ({
                    productId: item.id,
                    medicineName: item.name,
                    quantity: item.quantity,
                    unitPrice: item.price,
                    specification: item.spec
                })),
                totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                createTime: new Date().toISOString()
            };

            console.log('挂单数据:', hangOrderData);

            // 显示加载状态
            const hangBtn = document.getElementById('hang-order-btn');
            const originalText = hangBtn ? hangBtn.innerHTML : '';
            if (hangBtn) {
                hangBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 挂单中...';
                hangBtn.disabled = true;
            }

            // 保存到本地存储（模拟挂单功能）
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');
            const hangOrderId = 'HANG_' + Date.now();

            hangOrders.push({
                id: hangOrderId,
                ...hangOrderData
            });

            localStorage.setItem('hangOrders', JSON.stringify(hangOrders));

            // 清空购物车
            cart = [];
            updateCart();

            if (hangBtn) {
                hangBtn.innerHTML = originalText;
                hangBtn.disabled = false;
            }

            showMessage(`订单已挂起，挂单号: ${hangOrderId}`);

        } catch (error) {
            console.error('挂单失败:', error);
            showMessage('挂单失败，请重试', 'error');

            const hangBtn = document.getElementById('hang-order-btn');
            if (hangBtn) {
                hangBtn.innerHTML = '<i class="fa fa-pause"></i> 挂单';
                hangBtn.disabled = false;
            }
        }
    }

    async function loadHangOrders() {
        try {
            // 从本地存储获取挂单列表
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');

            if (hangOrders.length === 0) {
                showMessage('暂无挂单', 'info');
                return;
            }

            // 显示挂单选择对话框
            const hangOrderList = hangOrders.map(order =>
                `<div class="p-3 border-b cursor-pointer hover:bg-gray-50" onclick="selectHangOrder('${order.id}')">
                    <div class="font-medium">${order.customerName}</div>
                    <div class="text-sm text-gray-500">${order.items.length}种药品 | 总金额: ¥${order.totalAmount.toFixed(2)}</div>
                    <div class="text-xs text-gray-400">${new Date(order.createTime).toLocaleString()}</div>
                </div>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg w-96 max-h-96 overflow-hidden">
                    <div class="p-4 border-b">
                        <h3 class="font-bold">选择挂单</h3>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        ${hangOrderList}
                    </div>
                    <div class="p-4 border-t text-right">
                        <button class="btn btn-outline" onclick="this.closest('.fixed').remove()">取消</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

        } catch (error) {
            console.error('加载挂单失败:', error);
            showMessage('加载挂单失败，请重试', 'error');
        }
    }

    function selectHangOrder(hangOrderId) {
        try {
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');
            const selectedOrder = hangOrders.find(order => order.id === hangOrderId);

            if (selectedOrder) {
                // 加载到购物车
                cart = selectedOrder.items.map(item => ({
                    id: item.productId,
                    name: item.medicineName,
                    price: item.unitPrice,
                    spec: item.specification,
                    quantity: item.quantity
                }));

                updateCart();

                // 设置客户姓名
                const customerNameInput = document.getElementById('customerName');
                if (customerNameInput) {
                    customerNameInput.value = selectedOrder.customerName;
                }

                // 关闭模态框
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();

                showMessage('挂单已加载到购物车');
            }
        } catch (error) {
            console.error('选择挂单失败:', error);
            showMessage('加载挂单失败', 'error');
        }
    }

    // ========== 初始化函数 ==========
    function initDateTime() {
        const update = () => {
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');

            if (dateElement && timeElement) {
                const now = new Date();
                dateElement.textContent = now.toLocaleDateString('zh-CN', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                timeElement.textContent = now.toLocaleTimeString('zh-CN');
            }
        };
        update();
        setInterval(update, 1000);
    }

    function initSidebar() {
        const toggleBtn = document.getElementById('sidebar-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const sidebar = document.querySelector('aside');
                if (sidebar) {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-0');
                    sidebar.classList.toggle('hidden');
                }
            });
        }
    }

    function initCategoryFilter() {
        const categoryFilter = document.getElementById('category-filter');
        if (!categoryFilter) return;

        // 确保只有基本选项
        categoryFilter.innerHTML = '<option value="">全部分类</option>';

        // 使用不同的变量名避免冲突
        const categoryList = [
            '感冒药', '消炎药', '慢性病药', '维生素类', '中药饮片', '保健品'
        ];

        categoryList.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        });

        console.log('分类下拉框初始化完成');
    }

    function initEvents() {
        // 药品搜索
        const searchBtn = document.getElementById('search-medicine-btn');
        const searchInput = document.getElementById('medicine-search-input');
        const categoryFilter = document.getElementById('category-filter');

        if (searchBtn) searchBtn.addEventListener('click', performMedicineSearch);
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performMedicineSearch();
            });
        }
        if (categoryFilter) categoryFilter.addEventListener('change', performMedicineSearch);

        // 会员搜索
        const memberSearchBtn = document.getElementById('search-member-btn');
        const memberSearchInput = document.getElementById('member-search-input');
        const clearMemberBtn = document.getElementById('clear-member-btn');

        if (memberSearchBtn) memberSearchBtn.addEventListener('click', searchMember);
        if (memberSearchInput) {
            memberSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchMember();
            });
        }
        if (clearMemberBtn) clearMemberBtn.addEventListener('click', clearMemberInfo);

        // 清空购物车
        const clearCartBtn = document.getElementById('clear-cart-btn');
        if (clearCartBtn) clearCartBtn.addEventListener('click', clearCart);

        // 支付方式选择
        document.querySelectorAll('.payment-method').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(b => {
                    b.classList.remove('bg-primary/10', 'border-primary');
                    b.classList.add('btn-outline');
                });
                this.classList.remove('btn-outline');
                this.classList.add('bg-primary/10', 'border-primary');
                selectedPaymentMethod = this.getAttribute('data-method');
                updateCheckoutButton();
            });
        });

        // 支付按钮
        const payBtn = document.getElementById('pay-btn');
        if (payBtn) {
            payBtn.addEventListener('click', function() {
                console.log('支付按钮被点击');
                processPayment();
            });
        }

        // 挂单功能 - 使用修复后的函数
        const hangOrderBtn = document.getElementById('hang-order-btn');
        const loadOrderBtn = document.getElementById('load-order-btn');

        if (hangOrderBtn) hangOrderBtn.addEventListener('click', hangOrder);
        if (loadOrderBtn) loadOrderBtn.addEventListener('click', loadHangOrders);
    }

    // ========== 初始化 ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== 页面开始初始化 ===');
        const tenant = ensureTenant();
        console.log('[Init] 当前租户:', tenant || '(待选择)');

        // 基础初始化
        initDateTime();
        initSidebar();
        initEvents();

        // 使用本地分���数据，避免 API 调用失败
        initCategoryFilter();

        // 初始化购物车
        updateCart();

        console.log('=== 页面初始化完成 ===');
        console.log('现在可以测试搜索功能:');
        console.log('1. 在搜索框输入药品名称');
        console.log('2. 点击搜索按钮或按回车键');
        console.log('3. 检查控制台 Network 标签查看请求');
    });
</script>

<script>
// 移除 patchThenSyntax 相关遗留（已在主流程修复 then 语法）
</script>
</body>
</html>
