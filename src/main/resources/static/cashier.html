<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 收银管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="js/common.js"></script>

    <!-- 配置Tailwind -->
    <script>

        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#165DFF',
                secondary: '#36B37E',
                accent: '#FF5630',
              },
              fontFamily: {
                inter: ['Inter', 'system-ui', 'sans-serif'],
              },
            },
          }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
          .sidebar-item {
            @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
          }
          .sidebar-item.active {
            @apply bg-primary text-white;
          }
          .sidebar-item:not(.active):hover {
            @apply bg-gray-100;
          }
          .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md;
          }
          .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
          }
          .btn-primary {
            @apply bg-primary text-white hover:bg-primary/90;
          }
          .btn-outline {
            @apply border border-gray-300 hover:bg-gray-50;
          }
          .btn-danger {
            @apply bg-accent text-white hover:bg-accent/90;
          }
          .input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all;
          }
          .badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
          }

          /* 核心滚动条修复 */
          .main-content {
            @apply flex-1 p-6 bg-gray-50;
            height: calc(100vh - 64px);
            overflow-y: scroll;
            scrollbar-width: thin;
          }

          .main-content::-webkit-scrollbar {
            width: 8px;
          }
          .main-content::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
          }
          .main-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
          }
          .main-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
          }

          .scroll-container::-webkit-scrollbar {
            width: 6px;
          }
          .scroll-container::-webkit-scrollbar-track {
            background: #f9fafb;
          }
          .scroll-container::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 3px;
          }
        }
    </style>
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex">
<!-- 侧边栏 -->
<aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-screen z-10">
    <div class="p-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                <i class="fa fa-medkit text-primary"></i>
            </div>
            <h1 class="font-bold text-lg">智慧药房系统</h1>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto py-4 px-3">
        <nav class="space-y-1">
            <p class="text-xs font-medium text-gray-500 px-4 mb-2">主功能</p>
            <a href="medicine-management.html" class="sidebar-item block">
                <i class="fa fa-dashboard w-5 text-center"></i>
                <span>控制台</span>
            </a>
            <a href="cashier.html" class="sidebar-item active block">
                <i class="fa fa-shopping-cart w-5 text-center"></i>
                <span>收银管理</span>
            </a>
            <a href="stock-in.html" class="sidebar-item block">
                <i class="fa fa-box w-5 text-center"></i>
                <span>药品入库</span>
            </a>
            <a href="inventory.html" class="sidebar-item block">
                <i class="fa fa-warehouse w-5 text-center"></i>
                <span>库存管理</span>
            </a>
            <a href="members.html" class="sidebar-item block">
                <i class="fa fa-users w-5 text-center"></i>
                <span>会员管理</span>

            <a href="order-history.html" class="sidebar-item block">
                    <i class="fa fa-history w-5 text-center"></i>
                    <span>历史订单</span>
            </a>


            </a>
        </nav>
    </div>

    <div class="p-4 border-t border-gray-200">
        <div class="flex items-center gap-3">
            <img src="https://picsum.photos/200/200?random=1" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
            <div>
                <p class="font-medium text-sm">张药师</p>
                <p class="text-xs text-gray-500">管理员</p>
            </div>
            <a href="login.html" class="ml-auto text-gray-400 hover:text-accent transition-colors">
                <i class="fa fa-sign-out"></i>
            </a>
        </div>
    </div>
</aside>

<!-- 主内容区 -->
<main class="flex-1 flex flex-col">
    <!-- 顶部导航 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
            <button id="sidebar-toggle" class="lg:hidden text-gray-500 hover:text-primary">
                <i class="fa fa-bars text-xl"></i>
            </button>
            <div class="relative">
                <input type="text" placeholder="搜索药品、会员、订单..." class="w-64 px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button class="relative p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-full transition-colors">
                <i class="fa fa-bell text-xl"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-accent rounded-full"></span>
            </button>

            <div class="text-right hidden md:block">
                <p class="text-sm font-medium">今天 <span id="current-date"></span></p>
                <p class="text-xs text-gray-500" id="current-time"></p>
            </div>
        </div>
    </header>

    <!-- 可滚动内容区 -->
    <div class="main-content">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h2 class="text-[clamp(1.25rem,2vw,1.75rem)] font-bold">收银管理</h2>
                <p class="text-gray-500">药品销售与结算</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline" id="hang-order-btn">
                    <i class="fa fa-pause"></i> 挂单
                </button>
                <button class="btn btn-outline" id="load-order-btn">
                    <i class="fa fa-play"></i> 取单
                </button>
                <button class="btn btn-danger" id="clear-cart-btn">
                    <i class="fa fa-trash"></i> 清空
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 药品搜索与选择 -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h3 class="font-bold mb-4">药品搜索</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品名称</label>
                            <div class="flex gap-2">
                                <input type="text" class="input flex-1" id="medicine-search-input" placeholder="请输入药品名称或条形码">
                                <button class="btn btn-primary whitespace-nowrap" id="search-medicine-btn">
                                    <i class="fa fa-search"></i> 搜索
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">药品分类</label>
                            <select class="input" id="category-filter">
                                <option value="">全部分类</option>
                                <option value="感冒药">感冒药</option>
                                <option value="消炎药">消炎药</option>
                                <option value="慢性病药">慢性病药</option>
                                <option value="维生素类">维生素类</option>
                            </select>
                        </div>
                    </div>

                    <div class="relative">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">药品名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">规格</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生产厂家</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单价</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">库存</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="medicine-list-body">
                            <!-- 药品列表将通过JavaScript动态加载 -->
                            </tbody>
                        </table>

                        <!-- 加载状态 -->
                        <div id="loading-indicator" class="hidden text-center py-8">
                            <i class="fa fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                            <p class="text-gray-500">搜索中...</p>
                        </div>

                        <!-- 空状态 -->
                        <div id="empty-state" class="hidden text-center py-12">
                            <i class="fa fa-search text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">未找到相关药品</p>
                            <p class="text-sm text-gray-400 mt-1">请尝试其他搜索关键词</p>
                        </div>

                        <div class="flex justify-between items-center mt-4 text-sm">
                            <div class="text-gray-500" id="search-result-info">请输入关键词搜索</div>
                            <div class="flex gap-1" id="pagination-controls">
                                <!-- 分页控件将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 购物车与结算 -->
            <div class="space-y-6">
                <!-- 会员信息 -->
                <div class="card p-6">
                    <h3 class="font-bold mb-4">客户信息</h3>

                    <!-- 添加客户姓名输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">客户姓名 *</label>
                        <input type="text" class="input" id="customerName" placeholder="请输入客户姓名" required>
                        <p class="text-xs text-gray-500 mt-1">如不填写将自动生成匿名客户</p>
                    </div>

                    <div class="flex gap-3 mb-4">
                        <input type="text" class="input" id="member-search-input" placeholder="请输入会员手机号或卡号">
                        <button class="btn btn-primary whitespace-nowrap" id="search-member-btn">
                            <i class="fa fa-search"></i> 查找
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 hidden" id="member-info">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <p class="font-medium" id="member-name"></p>
                                <p class="text-sm text-gray-500" id="member-level"></p>
                            </div>
                            <button class="btn btn-outline text-sm" id="clear-member-btn">
                                <i class="fa fa-times"></i> 清除
                            </button>
                        </div>
                        <div class="text-sm">
                            <p>积分: <span id="member-points">0</span></p>
                            <p class="text-secondary">可享受会员价</p>
                        </div>
                    </div>
                </div>

                <!-- 购物车 -->
                <div class="card">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold">购物车</h3>
                            <span class="text-sm text-gray-500" id="cart-count">0种药品</span>
                        </div>
                    </div>
                    <div class="max-h-80 overflow-y-auto scroll-container" id="cart-items">
                        <!-- 购物车为空时显示 -->
                        <div class="flex flex-col items-center justify-center p-8 text-gray-500">
                            <i class="fa fa-shopping-cart text-4xl mb-3 opacity-30"></i>
                            <p>购物车为空，请添加药品</p>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-100">
                        <!-- 结算信息 -->
                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">商品总价:</span>
                                <span id="total-price">¥0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">会员折扣:</span>
                                <span id="discount">-¥0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">积分抵扣:</span>
                                <span id="points-discount">-¥0.00</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-200">
                                <span class="font-medium">实付金额:</span>
                                <span class="font-bold text-xl text-primary" id="payable-amount">¥0.00</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-medium text-sm mb-2">支付方式</h4>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="cash">
                                    <i class="fa fa-money text-lg text-green-600 mb-1"></i>
                                    <span class="text-xs">现金</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="wechat">
                                    <i class="fa fa-weixin text-lg text-green-500 mb-1"></i>
                                    <span class="text-xs">微信</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="alipay">
                                    <i class="fa fa-alipay text-lg text-blue-500 mb-1"></i>
                                    <span class="text-xs">支付宝</span>
                                </button>
                                <button class="payment-method btn btn-outline flex flex-col items-center justify-center py-3" data-method="insurance">
                                    <i class="fa fa-hospital-o text-lg text-purple-500 mb-1"></i>
                                    <span class="text-xs">医保</span>
                                </button>
                            </div>

                            <button class="btn btn-primary w-full justify-center" id="pay-btn" disabled>
                                <i class="fa fa-credit-card"></i> 确认支付
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 支付确认模态框 -->
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h3 class="font-bold text-lg mb-4">确认支付</h3>
        <div class="mb-4">
            <p class="text-gray-600">订单总金额: <span class="font-bold text-xl text-primary" id="modal-total">¥0.00</span></p>
            <p class="text-sm text-gray-500 mt-1">支付方式: <span id="modal-payment-method">现金</span></p>
        </div>
        <div class="flex gap-3">
            <button class="btn btn-outline flex-1" id="cancel-payment">取消</button>
            <button class="btn btn-primary flex-1" id="confirm-payment">确认支付</button>
        </div>
    </div>
</div>

<script>
    // 在 cashier.html 的 script 标签开头添加
    console.log('页面加载完成，检查全局对象:');
    console.log('window.api:', window.api);
    console.log('window.api.medicineAPI:', window.api?.medicineAPI);
    console.log('window.api.orderAPI:', window.api?.orderAPI);
    console.log('window.api.orderAPI.create:', window.api?.orderAPI?.create);

    // 检查 common.js 是否加载
    if (typeof api === 'undefined') {
        console.error('common.js 未正确加载！');
        // 可以尝试重新加载
        const script = document.createElement('script');
        script.src = 'js/common.js';
        script.onload = function() {
            console.log('common.js 重新加载完成');
            console.log('window.api:', window.api);
        };
        document.head.appendChild(script);
    }

    // 全局变量
    let cart = [];
    let currentMember = null;
    let selectedPaymentMethod = null;
    let currentPage = 1;
    const pageSize = 10;
    let totalMedicines = 0;

    // ========== 工具函数 ==========
    function showLoadingState() {
        const body = document.getElementById('medicine-list-body');
        const indicator = document.getElementById('loading-indicator');
        const empty = document.getElementById('empty-state');

        if (body) body.classList.add('hidden');
        if (indicator) indicator.classList.remove('hidden');
        if (empty) empty.classList.add('hidden');
    }

    function showErrorState(message) {
        const body = document.getElementById('medicine-list-body');
        const indicator = document.getElementById('loading-indicator');
        const empty = document.getElementById('empty-state');

        if (body) body.classList.add('hidden');
        if (indicator) indicator.classList.add('hidden');
        if (empty) {
            empty.classList.remove('hidden');
            empty.innerHTML = `
                <i class="fa fa-exclamation-triangle text-2xl text-yellow-500 mb-2"></i>
                <p class="text-gray-500">${message}</p>
            `;
        }
    }

    function getStockStatusClass(stock) {
        if (!stock || stock <= 0) return 'text-red-600';
        if (stock <= 10) return 'text-yellow-600';
        return 'text-green-600';
    }

    // 显示消息提示
    function showMessage(message, type = 'success') {
        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        messageDiv.innerHTML = `
            <i class="fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
            ${message}
        `;

        document.body.appendChild(messageDiv);

        // 3秒后自动移除
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }

    // ========== 购物车相关函数 ==========
    function updateCart() {
    const cartItems = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const totalPrice = document.getElementById('total-price');
    const discount = document.getElementById('discount');
    const pointsDiscount = document.getElementById('points-discount');
    const payableAmount = document.getElementById('payable-amount');
    const payBtn = document.getElementById('pay-btn');

    if (!cartItems) return;

    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 text-gray-500">
                <i class="fa fa-shopping-cart text-4xl mb-3 opacity-30"></i>
                <p>购物车为空，请添加药品</p>
            </div>
        `;
        if (cartCount) cartCount.textContent = '0种药品';
        if (totalPrice) totalPrice.textContent = '¥0.00';
        if (discount) discount.textContent = '-¥0.00';
        if (pointsDiscount) pointsDiscount.textContent = '-¥0.00';
        if (payableAmount) payableAmount.textContent = '¥0.00';
        if (payBtn) payBtn.disabled = true;
        return;
    }

    let html = '';
    let total = 0;
    let discountAmount = 0;

    cart.forEach(item => {
        const actualPrice = currentMember && item.memberPrice ? item.memberPrice : item.price;
        const itemTotal = actualPrice * item.quantity;
        const originalTotal = item.price * item.quantity;

        total += itemTotal;
        discountAmount += (originalTotal - itemTotal);

        // 检查库存状态
        const stockStatus = item.quantity > item.stock ? 'text-red-600' : 'text-gray-500';
        const stockWarning = item.quantity > item.stock ?
            `<div class="text-xs text-red-600 mt-1">超出库存! 库存: ${item.stock}</div>` : '';

        html += `
            <div class="p-4 border-b border-gray-100">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-medium">${item.name}</h4>
                        <p class="text-sm text-gray-500">${item.spec}</p>
                        ${item.isRx ? '<span class="inline-block mt-1 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">处方药</span>' : ''}
                        <div class="flex items-center mt-2">
                            <button class="w-6 h-6 flex items-center justify-center rounded border border-gray-300 decrease-qty" data-id="${item.id}">-</button>
                            <span class="mx-2">${item.quantity}</span>
                            <button class="w-6 h-6 flex items-center justify-center rounded border border-gray-300 increase-qty" data-id="${item.id}">+</button>
                        </div>
                        ${stockWarning}
                    </div>
                    <div class="text-right">
                        <p class="font-medium">${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(itemTotal) : '¥' + itemTotal.toFixed(2)}</p>
                        ${currentMember && item.memberPrice ?
                            `<p class="text-xs text-gray-500 line-through">${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(originalTotal) : '¥' + originalTotal.toFixed(2)}</p>` : ''}
                        <button class="text-red-500 text-sm mt-1 remove-item" data-id="${item.id}">删除</button>
                    </div>
                </div>
            </div>
        `;
    });

    cartItems.innerHTML = html;
    if (cartCount) cartCount.textContent = `${cart.length}种药品`;
    if (totalPrice) totalPrice.textContent = window.api?.utils?.formatPrice ? window.api.utils.formatPrice(total + discountAmount) : '¥' + (total + discountAmount).toFixed(2);
    if (discount) discount.textContent = `-${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(discountAmount) : '¥' + discountAmount.toFixed(2)}`;
    if (payableAmount) payableAmount.textContent = window.api?.utils?.formatPrice ? window.api.utils.formatPrice(total) : '¥' + total.toFixed(2);

    // 检查是否有商品超出库存
    const hasOverstock = cart.some(item => item.quantity > item.stock);
    if (payBtn) {
        payBtn.disabled = hasOverstock || !selectedPaymentMethod;
        if (hasOverstock) {
            payBtn.title = '有商品数量超出库存，请调整数量';
        }
    }

    // 重新绑定事件
    document.querySelectorAll('.decrease-qty').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const item = cart.find(item => item.id === id);
            if (item && item.quantity > 1) {
                item.quantity -= 1;
                updateCart();
            }
        });
    });

    document.querySelectorAll('.increase-qty').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const item = cart.find(item => item.id === id);
            if (item) {
                // 检查库存
                if (item.quantity >= item.stock) {
                    showMessage(`${item.name} 库存不足，当前库存: ${item.stock}`, 'error');
                    return;
                }
                item.quantity += 1;
                updateCart();
            }
        });
    });

    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            cart = cart.filter(item => item.id !== id);
            updateCart();
        });
    });
}

    function clearCart() {
        if (cart.length > 0 && confirm('确定要清空购物车吗？')) {
            cart = [];
            updateCart();
            showMessage('购物车已清空');
        }
    }

    function updateCheckoutButton() {
        const checkoutBtn = document.getElementById('pay-btn');
        if (checkoutBtn) {
            checkoutBtn.disabled = cart.length === 0 || !selectedPaymentMethod;
        }
    }

    function showAddToCartFeedback(medicineName) {
        const feedback = document.createElement('div');
        feedback.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
        feedback.innerHTML = `
            <i class="fa fa-check-circle mr-2"></i>
            已添加 ${medicineName} 到购物车
        `;
        document.body.appendChild(feedback);

        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.remove();
            }
        }, 2000);
    }

    // ========== 搜索和分页相关函数 ==========
   async function performMedicineSearch() {
    try {
        console.log('=== 开始搜索药品（包含库存信息）===');

        const searchInput = document.getElementById('medicine-search-input');
        const categoryFilter = document.getElementById('category-filter');

        if (!searchInput || !categoryFilter) {
            throw new Error('搜索元素未找到');
        }

        const searchParams = {
            keyword: searchInput.value,
            category: categoryFilter.value,
            page: 1
        };

        console.log('搜索参数:', searchParams);
        console.log('完整的请求URL:', `http://localhost:8080/api/medicines/search-with-stock?page=1&size=100&keyword=${encodeURIComponent(searchParams.keyword)}`);

        // 检查 API 对象
        console.log('API对象状态:', {
            api: typeof window.api,
            medicineAPI: typeof window.api?.medicineAPI,
            searchWithStock: typeof window.api?.medicineAPI?.searchWithStock
        });

        if (!window.api || !window.api.medicineAPI) {
            throw new Error('API 对象未正确初始化，请检查 common.js 是否已加载');
        }

        console.log('正在调用 medicineAPI.searchWithStock...');

        // 调用新的包含库存的搜索接口
        const response = await window.api.medicineAPI.searchWithStock(
            searchParams.keyword,
            searchParams.category,
            searchParams.page,
            100
        );

        console.log('完整的搜索响应:', response);
        console.log('响应数据:', response.data);
        console.log('数据长度:', response.data ? response.data.length : 0);
        console.log('响应消息:', response.message);

        if (response.code === 200) {
            updateMedicineList(response.data);

            // 如果没有结果，显示可能的建议
            if (!response.data || response.data.length === 0) {
                console.log('没有搜索结果，建议:');
                console.log('1. 检查数据库是否有相关药品');
                console.log('2. 检查搜索关键词是否正确');
                console.log('3. 检查后端搜索逻辑');
            }
        } else {
            throw new Error(response.message || '搜索失败');
        }

    } catch (error) {
        console.error('搜索出错:', error);
        console.error('错误详情:', {
            message: error.message,
            stack: error.stack
        });

        // 显示更详细的错误信息
        let errorMessage = '搜索失败: ' + error.message;
        if (error.message.includes('Failed to fetch')) {
            errorMessage += ' (网络连接失败，请检查后端服务是否启动)';
        }

        showMessage(errorMessage, 'error');
        updateMedicineList([]);
    }
}

    function updateMedicineList(medicines) {
    const tbody = document.getElementById('medicine-list-body');
    const indicator = document.getElementById('loading-indicator');
    const empty = document.getElementById('empty-state');
    const resultInfo = document.getElementById('search-result-info');

    // 隐藏加载状态
    if (indicator) indicator.classList.add('hidden');

    console.log('更新药品列表，数据:', medicines);

    if (!medicines || medicines.length === 0) {
        console.log('没有找到药品，显示空状态');
        if (empty) empty.classList.remove('hidden');
        if (tbody) tbody.classList.add('hidden');
        if (resultInfo) resultInfo.textContent = '未找到相关药品';
        return;
    }

    if (empty) empty.classList.add('hidden');
    if (tbody) tbody.classList.remove('hidden');

    console.log('找到药品数量:', medicines.length);

    // 生成药品列表HTML - 使用新的库存字段
    const html = medicines.map((medicine, index) => {
        const price = medicine.retailPrice || medicine.price;
        const memberPrice = medicine.memberPrice;
        const stockQuantity = medicine.stockQuantity || medicine.totalStock || 0;
        const unit = medicine.unit || '盒';

        return `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center mr-3">
                        <i class="fa fa-pills text-primary"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium">${medicine.genericName || medicine.name || '未知药品'}</div>
                        <div class="text-xs text-gray-500">${medicine.tradeName || ''}</div>
                        ${medicine.isRx ? '<span class="inline-block mt-1 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">处方药</span>' : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">${medicine.spec || medicine.specification || '暂无规格'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">${medicine.manufacturer || '未知厂家'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium">${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(price) : '¥' + (price || 0).toFixed(2)}</div>
                ${memberPrice ? `<div class="text-xs text-secondary">会员 ${window.api?.utils?.formatPrice ? window.api.utils.formatPrice(memberPrice) : '¥' + memberPrice.toFixed(2)}</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="${getStockStatusClass(stockQuantity)} font-medium">
                    ${stockQuantity} ${unit}
                </span>
                ${stockQuantity <= 10 && stockQuantity > 0 ?
                    '<span class="ml-1 text-xs text-yellow-600">(低库存)</span>' : ''}
                ${stockQuantity === 0 ?
                    '<span class="ml-1 text-xs text-red-600">(缺货)</span>' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="btn btn-primary text-sm px-3 py-1 add-to-cart"
                        data-id="${medicine.medicineId || medicine.id}"
                        data-name="${medicine.genericName || medicine.name}"
                        data-price="${medicine.retailPrice || medicine.price}"
                        data-member-price="${medicine.memberPrice}"
                        data-spec="${medicine.spec || medicine.specification}"
                        data-is-rx="${medicine.isRx}"
                        data-stock="${stockQuantity}"
                        ${stockQuantity <= 0 ? 'disabled' : ''}>
                    <i class="fa fa-plus-circle"></i>
                    ${stockQuantity <= 0 ? '缺货' : '加入购物车'}
                </button>
            </td>
        </tr>
    `}).join('');

        if (tbody) tbody.innerHTML = html;
        if (resultInfo) resultInfo.textContent = `找到 ${medicines.length} 个药品`;

        // 重新绑定加入购物车事件
        rebindAddToCartEvents();
    }

    function rebindAddToCartEvents() {
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            if (this.disabled) return;

            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const price = parseFloat(this.getAttribute('data-price'));
            const memberPrice = this.getAttribute('data-member-price') ? parseFloat(this.getAttribute('data-member-price')) : null;
            const spec = this.getAttribute('data-spec');
            const isRx = this.getAttribute('data-is-rx') === 'true';
            const stock = parseInt(this.getAttribute('data-stock'));

            // 检查库存
            if (stock <= 0) {
                showMessage(`${name} 已缺货，无法添加`, 'error');
                return;
            }

            // 检查是否已在购物车中
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                // 检查库存是否足够
                if (existingItem.quantity >= stock) {
                    showMessage(`${name} 库存不足，当前库存: ${stock}`, 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                // 检查库存是否足够
                if (1 > stock) {
                    showMessage(`${name} 库存不足，当前库存: ${stock}`, 'error');
                    return;
                }
                cart.push({
                    id,
                    name,
                    price,
                    memberPrice,
                    spec,
                    isRx,
                    stock, // 保存库存信息用于后续检查
                    quantity: 1
                });
            }

            updateCart();
            showAddToCartFeedback(name);
        });
    });
}

// 在 cashier.html 的 performMedicineSearch 函数中添加备用方案
async function performMedicineSearch() {
    try {
        console.log('=== 开始搜索药品（包含库存信息）===');

        const searchInput = document.getElementById('medicine-search-input');
        const categoryFilter = document.getElementById('category-filter');

        if (!searchInput || !categoryFilter) {
            throw new Error('搜索元素未找到');
        }

        const searchParams = {
            keyword: searchInput.value,
            category: categoryFilter.value,
            page: 1
        };

        console.log('搜索参数:', searchParams);
        console.log('完整的请求URL:', `http://localhost:8080/api/medicines/search-with-stock?page=1&size=100&keyword=${encodeURIComponent(searchParams.keyword)}`);

        // 检查 API 对象
        console.log('API对象状态:', {
            api: typeof window.api,
            medicineAPI: typeof window.api?.medicineAPI,
            searchWithStock: typeof window.api?.medicineAPI?.searchWithStock
        });

        // 方法1: 直接使用 searchWithStock
        if (window.api?.medicineAPI?.searchWithStock && typeof window.api.medicineAPI.searchWithStock === 'function') {
            console.log('使用方法1: medicineAPI.searchWithStock');
            const response = await window.api.medicineAPI.searchWithStock(
                searchParams.keyword,
                searchParams.category,
                searchParams.page,
                100
            );
            handleSearchResponse(response);
        }
        // 方法2: 使用普通的 search 方法
        else if (window.api?.medicineAPI?.search && typeof window.api.medicineAPI.search === 'function') {
            console.log('使用方法2: medicineAPI.search (备用方案)');
            const response = await window.api.medicineAPI.search(
                searchParams.keyword,
                searchParams.category,
                searchParams.page,
                100
            );
            handleSearchResponse(response);
        }
        // 方法3: 直接调用 API
        else {
            console.log('使用方法3: 直接 API 调用');
            let url = `http://localhost:8080/api/medicines/search-with-stock?page=1&size=100`;
            if (searchParams.keyword) {
                url += `&keyword=${encodeURIComponent(searchParams.keyword)}`;
            }
            if (searchParams.category) {
                url += `&category=${encodeURIComponent(searchParams.category)}`;
            }

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            handleSearchResponse(result);
        }

    } catch (error) {
        console.error('搜索出错:', error);
        console.error('错误详情:', {
            message: error.message,
            stack: error.stack
        });

        let errorMessage = '搜索失败: ' + error.message;
        if (error.message.includes('Failed to fetch')) {
            errorMessage += ' (网络连接失败，请检查后端服务是否启动)';
        }

        showMessage(errorMessage, 'error');
        updateMedicineList([]);
    }
}

// 添加响应处理函数
function handleSearchResponse(response) {
    console.log('完整的搜索响应:', response);
    console.log('响应数据:', response.data);
    console.log('数据长度:', response.data ? response.data.length : 0);
    console.log('响应消息:', response.message);

    if (response.code === 200) {
        updateMedicineList(response.data);

        if (!response.data || response.data.length === 0) {
            console.log('没有搜索结果');
        }
    } else {
        throw new Error(response.message || '搜索失败');
    }
}
    // ========== 会员相关函数 ==========
    async function searchMember() {
        const searchInput = document.getElementById('member-search-input');
        if (!searchInput) return;

        const keyword = searchInput.value.trim();
        if (!keyword) {
            showMessage('请输入会员卡号或手机号', 'error');
            return;
        }

        try {
            const response = await window.api.memberAPI.search(keyword);
            if (response.data && response.data.length > 0) {
                currentMember = response.data[0];
                displayMemberInfo(currentMember);
                updateCart();
                showMessage('会员信息已加载');
            } else {
                showMessage('未找到该会员', 'error');
                clearMemberInfo();
            }
        } catch (error) {
            console.error('搜索会员失败:', error);
            showMessage('搜索会员失败，请重试', 'error');
        }
    }

    function displayMemberInfo(member) {
        const container = document.getElementById('member-info');
        const nameEl = document.getElementById('member-name');
        const levelEl = document.getElementById('member-level');
        const pointsEl = document.getElementById('member-points');

        if (nameEl) nameEl.textContent = member.name;
        if (levelEl) levelEl.textContent = getMemberLevelText(member.level);
        if (pointsEl) pointsEl.textContent = member.points || 0;
        if (container) container.classList.remove('hidden');
    }

    function getMemberLevelText(level) {
        switch(level) {
            case 0: return '普通会员';
            case 1: return '银卡会员';
            case 2: return '金卡会员';
            default: return '普通会员';
        }
    }

    function clearMemberInfo() {
        currentMember = null;
        const container = document.getElementById('member-info');
        const searchInput = document.getElementById('member-search-input');

        if (container) container.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        updateCart();
    }

// ========== 订单创建函数 ==========
async function createOrder(orderData) {
    console.log('=== 创建订单 ===');
    console.log('订单数据:', orderData);

    // 首先尝试使用 window.api.orderAPI
    if (window.api && window.api.orderAPI && typeof window.api.orderAPI.create === 'function') {
        console.log('使用 window.api.orderAPI.create');
        try {
            return await window.api.orderAPI.create(orderData);
        } catch (error) {
            console.error('window.api.orderAPI.create 调用失败:', error);
            // 继续尝试直接调用
        }
    }

    // 如果 orderAPI 不可用，尝试直接调用 API
    console.log('使用直接 API 调用');

    try {
        const response = await fetch('http://localhost:8080/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });

        console.log('API响应状态:', response.status);

        if (!response.ok) {
            // 尝试获取详细的错误信息
            let errorDetail = '';
            try {
                const errorResponse = await response.json();
                errorDetail = JSON.stringify(errorResponse);
                console.error('API错误响应:', errorResponse);

                // 提取具体的错误消息
                if (errorResponse.message) {
                    errorDetail = errorResponse.message;
                } else if (errorResponse.errors) {
                    errorDetail = Object.values(errorResponse.errors).join(', ');
                }
            } catch (e) {
                errorDetail = await response.text();
                console.error('API错误文本:', errorDetail);
            }

            throw new Error(`HTTP error! status: ${response.status}, 详情: ${errorDetail}`);
        }

        const result = await response.json();
        console.log('API成功响应:', result);
        return result;
    } catch (error) {
        console.error('创建订单请求失败:', error);
        throw error;
    }
}


    // ========== 支付相关函数 ==========
function processPayment() {
    console.log('=== 开始处理支付 ===');

    try {
        // 获取客户姓名
        const customerNameInput = document.getElementById('customerName');
        let customerName = customerNameInput ? customerNameInput.value.trim() : '';

        if (!customerName) {
            customerName = "匿名客户_" + Date.now();
        }

        // 检查购物车
        if (!cart || cart.length === 0) {
            alert('购物车为空，请添加商品！');
            return;
        }

      // 在 processPayment 函数中修改
// 构建订单数据 - 使用原始字符串ID
const orderData = {
    customerName: customerName,
    items: cart.map(item => {
        // 使用原始的字符串药品ID，不要转换为数字
        const medicineId = item.id; // 直接使用原始ID，如 "M00010"

        console.log(`商品ID: "${medicineId}" (类型: ${typeof medicineId})`);

        return {
            productId: medicineId,  // 使用字符串ID
            productName: item.name,
            quantity: Number(item.quantity),
            unitPrice: Number(item.price)
        };
    })
};
        console.log('发送的订单数据:', orderData);
        console.log('JSON 字符串:', JSON.stringify(orderData));

        // 显示加载状态
        const payBtn = document.getElementById('pay-btn');
        const originalText = payBtn ? payBtn.innerHTML : '';
        if (payBtn) {
            payBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 支付中...';
            payBtn.disabled = true;
        }

        // 创建订单
        createOrder(orderData)
            .then(response => {
                console.log('订单创建成功:', response);

                // 清空购物车
                cart = [];
                updateCart();

                // 清空客户姓名
                if (customerNameInput) {
                    customerNameInput.value = '';
                }

                // 重置支付方式
                selectedPaymentMethod = null;
                document.querySelectorAll('.payment-method').forEach(btn => {
                    btn.classList.remove('bg-primary/10', 'border-primary');
                    btn.classList.add('btn-outline');
                });

                showMessage(`下单成功！订单号: ${response.orderId || response.id || '未知'}`);
            })
            .catch(error => {
                console.error('下单失败:', error);
                // 显示更详细的错误信息
                const errorMsg = error.message.includes('详情:') ?
                    error.message :
                    `下单失败: ${error.message}`;
                alert(errorMsg);
            })
            .finally(() => {
                // 恢复按钮状态
                if (payBtn) {
                    payBtn.innerHTML = originalText;
                    payBtn.disabled = false;
                }
            });

    } catch (error) {
        console.error('processPayment 函数执行出错:', error);
        alert('支付处理出错: ' + error.message);

        const payBtn = document.getElementById('pay-btn');
        if (payBtn) {
            payBtn.innerHTML = '<i class="fa fa-credit-card"></i> 确认支付';
            payBtn.disabled = false;
        }
    }
}
    // ========== 挂单相关函数 ==========
    async function hangOrder() {
        try {
            if (cart.length === 0) {
                showMessage('购物车为空，无法挂单', 'error');
                return;
            }

            // 获取客户姓名
            const customerNameInput = document.getElementById('customerName');
            let customerName = customerNameInput ? customerNameInput.value.trim() : '';

            if (!customerName) {
                customerName = "匿名客户_" + Date.now();
            }

            // 构建挂单数据
            const hangOrderData = {
                customerName: customerName,
                items: cart.map(item => ({
                    productId: item.id,
                    medicineName: item.name,
                    quantity: item.quantity,
                    unitPrice: item.price,
                    specification: item.spec
                })),
                totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                createTime: new Date().toISOString()
            };

            console.log('挂单数据:', hangOrderData);

            // 显示加载状态
            const hangBtn = document.getElementById('hang-order-btn');
            const originalText = hangBtn ? hangBtn.innerHTML : '';
            if (hangBtn) {
                hangBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 挂单中...';
                hangBtn.disabled = true;
            }

            // 保存到本地存储（模拟挂单功能）
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');
            const hangOrderId = 'HANG_' + Date.now();

            hangOrders.push({
                id: hangOrderId,
                ...hangOrderData
            });

            localStorage.setItem('hangOrders', JSON.stringify(hangOrders));

            // 清空购物车
            cart = [];
            updateCart();

            if (hangBtn) {
                hangBtn.innerHTML = originalText;
                hangBtn.disabled = false;
            }

            showMessage(`订单已挂起，挂单号: ${hangOrderId}`);

        } catch (error) {
            console.error('挂单失败:', error);
            showMessage('挂单失败，请重试', 'error');

            const hangBtn = document.getElementById('hang-order-btn');
            if (hangBtn) {
                hangBtn.innerHTML = '<i class="fa fa-pause"></i> 挂单';
                hangBtn.disabled = false;
            }
        }
    }

    async function loadHangOrders() {
        try {
            // 从本地存储获取挂单列表
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');

            if (hangOrders.length === 0) {
                showMessage('暂无挂单', 'info');
                return;
            }

            // 显示挂单选择对话框
            const hangOrderList = hangOrders.map(order =>
                `<div class="p-3 border-b cursor-pointer hover:bg-gray-50" onclick="selectHangOrder('${order.id}')">
                    <div class="font-medium">${order.customerName}</div>
                    <div class="text-sm text-gray-500">${order.items.length}种药品 | 总金额: ¥${order.totalAmount.toFixed(2)}</div>
                    <div class="text-xs text-gray-400">${new Date(order.createTime).toLocaleString()}</div>
                </div>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg w-96 max-h-96 overflow-hidden">
                    <div class="p-4 border-b">
                        <h3 class="font-bold">选择挂单</h3>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        ${hangOrderList}
                    </div>
                    <div class="p-4 border-t text-right">
                        <button class="btn btn-outline" onclick="this.closest('.fixed').remove()">取消</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

        } catch (error) {
            console.error('加载挂单失败:', error);
            showMessage('加载挂单失败，请重试', 'error');
        }
    }

    function selectHangOrder(hangOrderId) {
        try {
            const hangOrders = JSON.parse(localStorage.getItem('hangOrders') || '[]');
            const selectedOrder = hangOrders.find(order => order.id === hangOrderId);

            if (selectedOrder) {
                // 加载到购物车
                cart = selectedOrder.items.map(item => ({
                    id: item.productId,
                    name: item.medicineName,
                    price: item.unitPrice,
                    spec: item.specification,
                    quantity: item.quantity
                }));

                updateCart();

                // 设置客户姓名
                const customerNameInput = document.getElementById('customerName');
                if (customerNameInput) {
                    customerNameInput.value = selectedOrder.customerName;
                }

                // 关闭模态框
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();

                showMessage('挂单已加载到购物车');
            }
        } catch (error) {
            console.error('选择挂单失败:', error);
            showMessage('加载挂单失败', 'error');
        }
    }

    // ========== 初始化函数 ==========
    function initDateTime() {
        const update = () => {
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');

            if (dateElement && timeElement) {
                const now = new Date();
                dateElement.textContent = now.toLocaleDateString('zh-CN', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                timeElement.textContent = now.toLocaleTimeString('zh-CN');
            }
        };
        update();
        setInterval(update, 1000);
    }

    function initSidebar() {
        const toggleBtn = document.getElementById('sidebar-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const sidebar = document.querySelector('aside');
                if (sidebar) {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-0');
                    sidebar.classList.toggle('hidden');
                }
            });
        }
    }

    function initCategoryFilter() {
        const categoryFilter = document.getElementById('category-filter');
        if (!categoryFilter) return;

        // 确保只有基本选项
        categoryFilter.innerHTML = '<option value="">全部分类</option>';

        // 使用不同的变量名避免冲突
        const categoryList = [
            '感冒药', '消炎药', '慢性病药', '维生素类', '中药饮片', '保健品'
        ];

        categoryList.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        });

        console.log('分类下拉框初始化完成');
    }

    function initEvents() {
        // 药品搜索
        const searchBtn = document.getElementById('search-medicine-btn');
        const searchInput = document.getElementById('medicine-search-input');
        const categoryFilter = document.getElementById('category-filter');

        if (searchBtn) searchBtn.addEventListener('click', performMedicineSearch);
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performMedicineSearch();
            });
        }
        if (categoryFilter) categoryFilter.addEventListener('change', performMedicineSearch);

        // 会员搜索
        const memberSearchBtn = document.getElementById('search-member-btn');
        const memberSearchInput = document.getElementById('member-search-input');
        const clearMemberBtn = document.getElementById('clear-member-btn');

        if (memberSearchBtn) memberSearchBtn.addEventListener('click', searchMember);
        if (memberSearchInput) {
            memberSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchMember();
            });
        }
        if (clearMemberBtn) clearMemberBtn.addEventListener('click', clearMemberInfo);

        // 清空购物车
        const clearCartBtn = document.getElementById('clear-cart-btn');
        if (clearCartBtn) clearCartBtn.addEventListener('click', clearCart);

        // 支付方式选择
        document.querySelectorAll('.payment-method').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(b => {
                    b.classList.remove('bg-primary/10', 'border-primary');
                    b.classList.add('btn-outline');
                });
                this.classList.remove('btn-outline');
                this.classList.add('bg-primary/10', 'border-primary');
                selectedPaymentMethod = this.getAttribute('data-method');
                updateCheckoutButton();
            });
        });

        // 支付按钮
        const payBtn = document.getElementById('pay-btn');
        if (payBtn) {
            payBtn.addEventListener('click', function() {
                console.log('支付按钮被点击');
                processPayment();
            });
        }

        // 挂单功能 - 使用修复后的函数
        const hangOrderBtn = document.getElementById('hang-order-btn');
        const loadOrderBtn = document.getElementById('load-order-btn');

        if (hangOrderBtn) hangOrderBtn.addEventListener('click', hangOrder);
        if (loadOrderBtn) loadOrderBtn.addEventListener('click', loadHangOrders);
    }

    // ========== 初始化 ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== 页面开始初始化 ===');

        // 基础初始化
        initDateTime();
        initSidebar();
        initEvents();

        // 使用本地分类数据，避免 API 调用失败
        initCategoryFilter();

        // 初始化购物车
        updateCart();

        console.log('=== 页面初始化完成 ===');
        console.log('现在可以测试搜索功能:');
        console.log('1. 在搜索框输入药品名称');
        console.log('2. 点击搜索按钮或按回车键');
        console.log('3. 检查控制台 Network 标签查看请求');
    });
</script>
</body>
</html>