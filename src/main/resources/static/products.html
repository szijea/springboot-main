<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 药品档案管理</title>
    <link rel="stylesheet" href="/css/tailwind.css" />
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <!-- 配置Tailwind（与其他页面一致） -->
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#165DFF',
                secondary: '#36B37E',
                accent: '#FF5630',
              },
              fontFamily: {
                inter: ['Inter', 'system-ui', 'sans-serif'],
              },
            },
          }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
          .sidebar-item {
            @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
          }
          .sidebar-item.active {
            @apply bg-primary text-white;
          }
          .sidebar-item:not(.active):hover {
            @apply bg-gray-100;
          }
          .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md;
          }
          .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
          }
          .btn-primary {
            @apply bg-primary text-white hover:bg-primary/90;
          }
          .btn-outline {
            @apply border border-gray-300 hover:bg-gray-50;
          }
          .input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all;
          }
          .badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
          }

          /* 药品状态指示器 */
          .medicine-indicator {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
          }
          .medicine-active {
            @apply bg-green-100 text-green-800;
          }
          .medicine-inactive {
            @apply bg-gray-100 text-gray-800;
          }
          .medicine-prescription {
            @apply bg-blue-100 text-blue-800;
          }
          .medicine-otc {
            @apply bg-yellow-100 text-yellow-800;
          }
          .medicine-near-expiry { @apply bg-orange-100 text-orange-800; }
          .medicine-expired { @apply bg-red-100 text-red-800; }
          .medicine-out { @apply bg-gray-300 text-gray-700; }

          /* 修复滚动问题 */
          .main-content-container {
            flex: 1 1 auto; /* 新增：允许容器扩展 */
            min-height: calc(100vh - 64px); /* 改为 min-height 便于超出滚动 */
            overflow-y: auto; /* 保持纵向滚动 */
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
          }
          .main-content-container::-webkit-scrollbar {
            width: 8px;
          }
          .main-content-container::-webkit-scrollbar-track {
            background:#f5f5f5;
          }
          .main-content-container::-webkit-scrollbar-thumb {
            background:#d1d5db;
            border-radius:4px;
          }
          .main-content-container::-webkit-scrollbar-thumb:hover {
            background:#9ca3af;
          }

          /* 分页样式 */
          .pagination-btn {
            @apply w-8 h-8 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-50 transition-colors;
          }
          .pagination-btn.active {
            @apply border-primary bg-primary text-white;
          }
          .pagination-btn.disabled {
            @apply text-gray-400 cursor-not-allowed;
          }

          /* 模态框样式 */
          .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
          }
          .modal-content {
            @apply bg-white rounded-xl shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto;
          }

          /* 确保隐藏类正常工作 */
          .hidden {
            display: none !important;
          }
        }
    </style>
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex overflow-y-auto"> <!-- 移除 overflow-hidden 修复滚动 -->
<!-- 添加滚动条样式 -->
<style>
  .main-content-container { height: calc(100vh - 64px); overflow-y: auto; scrollbar-width: thin; }
  .main-content-container::-webkit-scrollbar { width: 8px; }
  .main-content-container::-webkit-scrollbar-track { background:#f5f5f5; }
  .main-content-container::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:4px; }
  .main-content-container::-webkit-scrollbar-thumb:hover { background:#9ca3af; }
</style>
<!-- 注入统一导航（侧边栏 + 顶部） -->
<div id="common-nav" data-active="medicine-archive"></div>

<main class="flex-1 flex flex-col pt-16">
    <!-- 内容区域 - 修复滚动 -->
    <div class="main-content-container p-6 bg-gray-50">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h2 class="text-[clamp(1.25rem,2vw,1.75rem)] font-bold">药品档案管理</h2>
                <p class="text-gray-500">管理药品基本信息与档案</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline" id="export-medicines"><i class="fa fa-download"></i> 导出药品</button>
                <button class="btn btn-outline" id="import-medicines"><i class="fa fa-upload"></i> 导入药品</button>
                <button id="batch-operate-btn" class="btn btn-outline">
                    <i class="fa fa-cogs"></i> 批量操作
                </button>
            </div>
        </div>

        <!-- 药品统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">总药品数</p>
                        <h3 id="total-medicines" class="text-2xl font-bold mt-1">0 种</h3>
                        <p id="in-stock-medicines" class="text-sm text-gray-500 mt-1">在库药品数：0 种</p>
                    </div>
                    <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center text-primary">
                        <i class="fa fa-cubes"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="text-secondary flex items-center" id="total-medicines-change">
                        <i class="fa fa-arrow-up mr-1"></i> 0 种
                    </span>
                    <span class="text-gray-500 ml-2">较上月</span>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">处方药</p>
                        <h3 id="prescription-count" class="text-2xl font-bold mt-1">0 种</h3>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                        <i class="fa fa-file-text"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="text-secondary flex items-center" id="prescription-change">
                        <i class="fa fa-arrow-up mr-1"></i> 0 种
                    </span>
                    <span class="text-gray-500 ml-2">较上月</span>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">非处方药</p>
                        <h3 id="otc-count" class="text-2xl font-bold mt-1">0 种</h3>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600">
                        <i class="fa fa-shopping-cart"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="text-secondary flex items-center" id="otc-change">
                        <i class="fa fa-arrow-up mr-1"></i> 0 种
                    </span>
                    <span class="text-gray-500 ml-2">较上月</span>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">中药</p>
                        <h3 id="chinese-count" class="text-2xl font-bold mt-1">0 种</h3>
                    </div>
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center text-yellow-600">
                        <i class="fa fa-leaf"></i>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <span class="text-secondary flex items-center" id="chinese-change">
                        <i class="fa fa-arrow-up mr-1"></i> 0 种
                    </span>
                    <span class="text-gray-500 ml-2">较上月</span>
                </div>
            </div>
        </div>

        <!-- 药品筛选 -->
        <div class="card p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品名称</label>
                    <input type="text" class="input" id="medicine-name-filter" placeholder="请输入药品名称">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品分类</label>
                    <select class="input" id="category-filter">
                        <option value="">全部分类</option>
                        <option value="otc">非处方药(OTC)</option>
                        <option value="prescription">处方药</option>
                        <option value="chinese">中药</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品状态</label>
                    <select class="input" id="status-filter">
                        <option value="">全部状态</option>
                        <option value="active">在售</option>
                        <option value="inactive">停售</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                    <input type="text" class="input" id="manufacturer-filter" placeholder="请输入生产厂家">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button class="btn btn-outline" id="reset-filters">重置</button>
                <button class="btn btn-primary" id="apply-filters">查询</button>
            </div>
        </div>

        <!-- 药品档案列表 -->
        <div class="card">
            <div class="p-6 border-b border-gray-100">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h3 class="font-bold">药品档案列表</h3>
                    <div class="flex items-center gap-4">
                        <div id="medicines-total-text" class="text-sm text-gray-500">共 0 种药品</div>
                        <!-- 每页显示数量选择器 -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">每页显示</span>
                            <select id="page-size-select" class="input py-1 text-sm w-20">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 加载状态 -->
            <div id="loading-medicines" class="p-8 text-center">
                <i class="fa fa-spinner fa-spin text-primary text-xl mb-2"></i>
                <p class="text-gray-500">��在加载药品数据...</p>
            </div>

            <!-- 空状态 -->
            <div id="empty-medicines" class="p-8 text-center hidden">
                <i class="fa fa-pills text-gray-300 text-3xl mb-2"></i>
                <p class="text-gray-500">暂无药品数据</p>
                <button class="btn btn-primary mt-4" id="add-first-medicine">
                    <i class="fa fa-plus"></i> 添加第一个药品
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all" class="rounded border-gray-300">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">药品信息</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">批准文号</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">零售价</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">会员价</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="medicines-list-body">
                    <!-- 动态内容 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页控件 -->
            <div class="p-4 border-t border-gray-100">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div id="medicines-range-text" class="text-sm text-gray-500">显示 0-0 条���共 0 ���</div>

                    <div class="flex items-center gap-2">
                        <!-- 快速跳转 -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">跳至</span>
                            <input type="number" id="page-jump-input" class="input py-1 text-sm w-16" min="1" placeholder="页">
                            <button id="page-jump-btn" class="btn btn-outline py-1 text-sm">跳转</button>
                        </div>

                        <!-- 分页按钮 -->
                        <div class="flex gap-1" id="medicines-pagination-controls">
                            <!-- 分页控件将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 药品详情/编辑模态框 -->
<div id="medicine-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-100">
            <h3 class="font-bold text-lg" id="medicine-modal-title">新增药品</h3>
        </div>
        <div class="p-6">
            <form id="medicine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="medicine-id">

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品图片</label>
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 border border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="medicine-preview" src="" alt="药品图片" class="hidden w-full h-full object-cover">
                            <i id="medicine-placeholder" class="fa fa-picture-o text-gray-400 text-2xl"></i>
                        </div>
                        <div>
                            <input type="file" id="medicine-image" class="hidden" accept="image/*">
                            <button type="button" id="upload-image-btn" class="btn btn-outline">上传图片</button>
                            <p class="text-xs text-gray-500 mt-1">支持 JPG, PNG 格式，大小不超过 2MB</p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品名称 *</label>
                    <input type="text" class="input" id="medicine-name" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">通用名</label>
                    <input type="text" class="input" id="medicine-generic-name">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">规格 *</label>
                    <input type="text" class="input" id="medicine-spec" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">单位 *</label>
                    <input type="text" class="input" id="medicine-unit" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">批准文号 *</label>
                    <input type="text" class="input" id="medicine-approval-no" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家 *</label>
                    <input type="text" class="input" id="medicine-manufacturer" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品分类 *</label>
                    <select class="input" id="medicine-category" required>
                        <option value="">请选择分类</option>
                        <option value="otc">非处方药(OTC)</option>
                        <option value="prescription">处方药</option>
                        <option value="chinese">中药</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">零售价 *</label>
                    <input type="number" class="input" id="medicine-retail-price" step="0.01" min="0" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">会员价</label>
                    <input type="number" class="input" id="medicine-member-price" step="0.01" min="0">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">是否处方药</label>
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="medicine-is-rx" class="rounded border-gray-300">
                            <span class="ml-2">是处方药</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品状态</label>
                    <select class="input" id="medicine-status">
                        <option value="active">在售</option>
                        <option value="inactive">停售</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">条形码</label>
                    <input type="text" class="input" id="medicine-barcode">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">生产日期</label>
                    <input type="date" class="input" id="medicine-production-date">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">到期日期</label>
                    <input type="date" class="input" id="medicine-expiry-date">
                    <p id="medicine-expiry-remaining" class="text-xs mt-1 text-gray-500"></p>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">药品说明</label>
                    <textarea class="input" id="medicine-description" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
            <button type="button" class="btn btn-outline" id="cancel-medicine">取消</button>
            <button type="button" class="btn btn-primary" id="save-medicine">保存</button>
        </div>
    </div>
</div>

<!-- 引入通用前端脚本以提供 window.api 等工具 -->
<script src="js/common.js"></script>
<!-- 注入统一导航脚本 -->
<script src="js/common-nav.js"></script>

<script>
    // === 新增: 简单消息提示容器 ===
    (function initToast(){
        if(!document.getElementById('global-toast')){
            const div=document.createElement('div');
            div.id='global-toast';
            div.style.position='fixed';
            div.style.top='20px';
            div.style.right='20px';
            div.style.zIndex='9999';
            div.style.display='flex';
            div.style.flexDirection='column';
            div.style.gap='8px';
            document.body.appendChild(div);
        }
    })();

    // === 缺失函数补充 ===
    function showMessage(msg,type='info',timeout=3000){
        console.log('[Toast]',type, msg);
        const container=document.getElementById('global-toast');
        if(!container){ alert(msg); return; }
        const colorMap={success:'#36B37E',error:'#FF5630',warning:'#FFAB00',info:'#165DFF'};
        const item=document.createElement('div');
        item.style.minWidth='220px';
        item.style.maxWidth='360px';
        item.style.padding='10px 14px';
        item.style.borderRadius='8px';
        item.style.fontSize='14px';
        item.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';
        item.style.color='#fff';
        item.style.background=colorMap[type]||colorMap.info;
        item.textContent=msg;
        item.style.opacity='0';
        item.style.transition='opacity .25s, transform .25s';
        item.style.transform='translateY(-6px)';
        container.appendChild(item);
        requestAnimationFrame(()=>{ item.style.opacity='1'; item.style.transform='translateY(0)'; });
        setTimeout(()=>{ item.style.opacity='0'; item.style.transform='translateY(-6px)'; setTimeout(()=>container.removeChild(item),300); }, timeout);
    }

    function hideMedicineModal(){
        const modal=document.getElementById('medicine-modal');
        if(modal){ modal.classList.add('hidden'); }
        const form=document.getElementById('medicine-form');
        if(form){ form.reset(); document.getElementById('medicine-id').value=''; }
        const preview=document.getElementById('medicine-preview');
        const placeholder=document.getElementById('medicine-placeholder');
        if(preview&&placeholder){ preview.classList.add('hidden'); preview.src=''; placeholder.classList.remove('hidden'); }
    }

    function showAddMedicineModal(){
        const modal=document.getElementById('medicine-modal');
        if(modal){ modal.classList.remove('hidden'); }
        const title=document.getElementById('medicine-modal-title');
        if(title){ title.textContent='新增药品'; }
        const form=document.getElementById('medicine-form');
        if(form){ form.reset(); document.getElementById('medicine-id').value=''; }
        updateExpiryRemaining();
    }

    function mapMedicineStatus(code){
        switch((code||'').toUpperCase()){
            case 'ACTIVE': return 'active';
            case 'INACTIVE': return 'inactive';
            case 'NEAR_EXPIRY': return 'NEAR_EXPIRY';
            case 'EXPIRED': return 'EXPIRED';
            case 'OUT':
            case 'OUT_OF_STOCK': return 'OUT';
            default: return 'active';
        }
    }

    function resetMedicinesFilters(){
        ['medicine-name-filter','category-filter','status-filter','manufacturer-filter'].forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }});
        currentMedicinesPage=1;
        applyMedicinesFilters();
        showMessage('筛选条件已重置','info');
    }

    function updateExpiryRemaining(){
        const expiryInput=document.getElementById('medicine-expiry-date');
        const productionInput=document.getElementById('medicine-production-date');
        const info=document.getElementById('medicine-expiry-remaining');
        if(!expiryInput||!info){ return; }
        const expiryVal=expiryInput.value; if(!expiryVal){ info.textContent=''; return; }
        const today=new Date(); today.setHours(0,0,0,0);
        const expiryDate=new Date(expiryVal);
        const diffDays=Math.floor((expiryDate - today)/(1000*60*60*24));
        if(diffDays<0){ info.textContent='已过期 '+Math.abs(diffDays)+' 天'; info.classList.remove('text-gray-500'); info.classList.add('text-red-600'); }
        else if(diffDays<=30){ info.textContent='近效期，剩余 '+diffDays+' 天'; info.classList.remove('text-gray-500'); info.classList.add('text-orange-600'); }
        else { info.textContent='剩余 '+diffDays+' 天'; info.classList.remove('text-red-600','text-orange-600'); info.classList.add('text-gray-500'); }
        if(productionInput && productionInput.value){
            const prodDate=new Date(productionInput.value);
            if(prodDate>expiryDate){ info.textContent+=' (生产日期晚于到期日期，请��查)'; info.classList.add('text-red-600'); }
        }
    }

    async function loadInStockMedicineSet(){
        try{
            if(!window.api){ console.warn('window.api 未初始化，跳过在库集合加载'); return; }
            if(window.api.inventoryAPI?.getAll){
                console.log('加载库存集合: 使用 inventoryAPI.getAll');
                const resp=await window.api.inventoryAPI.getAll();
                const items=resp?.data || resp?.content || [];
                items.forEach(inv=>{ if(inv.medicineId||inv.medicine_id){ inStockMedicineIds.add(inv.medicineId||inv.medicine_id); } });
            }else{
                console.log('加载库存集合: 备用 fetch /api/inventory');
                const r=await fetch('/api/inventory');
                if(r.ok){ const j=await r.json(); const items=j?.data||j||[]; items.forEach(inv=>{ if(inv.medicineId||inv.medicine_id){ inStockMedicineIds.add(inv.medicineId||inv.medicine_id); } }); }
            }
            updateMedicinesSummary();
        }catch(e){ console.warn('加载在库药品集合失败', e); }
    }

    function viewMedicineDetail(id){
        const item=allMedicinesItems.find(m=>m.id===id);
        if(!item){ showMessage('未找到药品: '+id,'error'); return; }
        const modal=document.getElementById('medicine-modal'); if(modal) modal.classList.remove('hidden');
        const title=document.getElementById('medicine-modal-title'); if(title) title.textContent='药品详情';
        fillMedicineForm(item,false);
        toggleMedicineFormReadonly(true);
    }

    function editMedicine(id){
        const item=allMedicinesItems.find(m=>m.id===id);
        if(!item){ showMessage('未找到药品: '+id,'error'); return; }
        const modal=document.getElementById('medicine-modal'); if(modal) modal.classList.remove('hidden');
        const title=document.getElementById('medicine-modal-title'); if(title) title.textContent='编辑药品';
        fillMedicineForm(item,true);
        toggleMedicineFormReadonly(false);
    }

    async function deleteMedicine(id){
        if(!confirm('确定删除该药品?')) return;
        try{
            const resp=await fetch('/api/medicines/'+encodeURIComponent(id),{method:'DELETE'});
            const payload = await resp.json().catch(()=>({}));
            if(!resp.ok){
                const msg = (payload && payload.message) ? payload.message : ('删除失败: '+resp.status);
                showMessage(msg,'error');
                return;
            }
            if(payload.code===409){
                showMessage(payload.message,'warning');
                return;
            }
            allMedicinesItems=allMedicinesItems.filter(m=>m.id!==id);
            const row = document.querySelector(`#medicines-list-body tr[data-id='${id}']`);
            if(row){ row.remove(); }
            updateMedicinesSummary();
            applyMedicinesFilters();
            showMessage('删除成功','success');
        }catch(e){ console.error(e); showMessage('删除失败: '+e.message,'error'); }
    }

    function computeDynamicStatus(item){
        const stock = item.stockQuantity != null ? item.stockQuantity : (item.currentStock != null ? item.currentStock : null);
        const expiry = item.expiryDate ? new Date(item.expiryDate) : null;
        const today = new Date(); today.setHours(0,0,0,0);
        if (stock === 0) return 'OUT_OF_STOCK';
        if (expiry){
            const diffDays = Math.floor((expiry - today)/(1000*60*60*24));
            if (diffDays < 0) return 'EXPIRED';
            if (diffDays <= 60) return 'NEAR_EXPIRY';
        }
        return 'NORMAL';
    }
    function formatStatusBadges(persisted, dynamic){
        const map = {
            ACTIVE:{text:'在售',cls:'medicine-active'}, INACTIVE:{text:'停售',cls:'medicine-inactive'},
            OUT_OF_STOCK:{text:'缺货',cls:'medicine-out'}, OUT:{text:'缺货',cls:'medicine-out'},
            EXPIRED:{text:'过期',cls:'medicine-expired'}, NEAR_EXPIRY:{text:'近效期',cls:'medicine-near-expiry'},
            NORMAL:{text:'正常',cls:'medicine-active'}
        };
        const p = map[(persisted||'').toUpperCase()] || {text:'未知',cls:'medicine-inactive'};
        const d = map[(dynamic||'').toUpperCase()] || null;
        if(!d || p.text === d.text) {
            return `<span class="medicine-indicator ${p.cls}">${p.text}</span>`;
        }
        return `<span class="medicine-indicator ${p.cls} mr-1">${p.text}</span><span class="medicine-indicator ${d.cls}">${d.text}</span>`;
    }

    function fillMedicineForm(item, editable){
        const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.value=val??''; };
        set('medicine-id', item.id);
        set('medicine-name', item.name);
        set('medicine-generic-name', item.genericName);
        set('medicine-spec', item.spec);
        set('medicine-unit', item.unit);
        set('medicine-approval-no', item.approvalNo);
        set('medicine-manufacturer', item.manufacturer);
        const catEl=document.getElementById('medicine-category'); if(catEl){ catEl.value=item.category || 'otc'; }
        set('medicine-retail-price', item.retailPrice);
        set('medicine-member-price', item.memberPrice);
        const rx=document.getElementById('medicine-is-rx'); if(rx){ rx.checked=!!item.isRx; }
        set('medicine-description', item.description);
        set('medicine-barcode', item.barcode);
        set('medicine-production-date', item.productionDate);
        set('medicine-expiry-date', item.expiryDate);
        updateExpiryRemaining();
        const preview=document.getElementById('medicine-preview'); const placeholder=document.getElementById('medicine-placeholder');
        if(preview&&placeholder){ if(item.imageUrl){ preview.src=item.imageUrl; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } else { preview.classList.add('hidden'); preview.src=''; placeholder.classList.remove('hidden'); } }
        const statusSelect=document.getElementById('medicine-status');
        if(statusSelect){ statusSelect.value = (item.status||'active').toLowerCase(); }
    }

    function toggleMedicineFormReadonly(readonly){
        const form=document.getElementById('medicine-form'); if(!form) return;
        const ids=[...form.querySelectorAll('input,textarea,select')].filter(el=>el.id!=='medicine-id');
        ids.forEach(el=>{ if(readonly){ el.setAttribute('disabled','disabled'); } else { el.removeAttribute('disabled'); } });
        const saveBtn=document.getElementById('save-medicine'); if(saveBtn){ saveBtn.classList.toggle('hidden', readonly); }
    }

    // 全局变量
    let currentMedicinesPage = 1;
    let medicinesPageSize = 10;
    let totalMedicinesItems = 0;
    let allMedicinesItems = [];
    let filteredMedicinesItems = [];
    let totalPages = 0;
    let selectedMedicines = new Set();
    let inStockMedicineIds = new Set();

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== 药品档案页面初始化开始 ===');

        // 立即隐藏模态框
        hideMedicineModal();

        initMedicinesEvents();
        loadMedicinesData();
        // 并行加载在库集合
        loadInStockMedicineSet();

        console.log('=== 药品档案页面初始化完成 ===');
    });

    // 药品相关事件初始化
    function initMedicinesEvents() {
        console.log('初始化药品事件...');

        // 首先确保模态框是隐藏状态
        hideMedicineModal();

        // 新增药品 - 修复事件绑定
        const addBtn = document.getElementById('add-medicine');
        if (addBtn) {
            addBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('点击新增药品按钮');
                showAddMedicineModal();
            });
        }

        // 导出档案
        const exportBtn = document.getElementById('export-medicines');
        if (exportBtn) {
            exportBtn.addEventListener('click', exportMedicinesData);
        }

        // 导入药品（占位功能待实现）
        const importBtn=document.getElementById('import-medicines');
        if(importBtn){ importBtn.addEventListener('click',()=>{ showMessage('导入功能待实现','info'); }); }

        // 筛选
        const applyFiltersBtn = document.getElementById('apply-filters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', applyMedicinesFilters);
        }

        // 重置筛选
        const resetFiltersBtn = document.getElementById('reset-filters');
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', resetMedicinesFilters);
        }

        // 批量操作
        const batchBtn = document.getElementById('batch-operate-btn');
        if (batchBtn) {
            batchBtn.addEventListener('click', showBatchOperations);
        }

        // 每页显示数量变化
        const pageSizeSelect = document.getElementById('page-size-select');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                medicinesPageSize = parseInt(this.value);
                currentMedicinesPage = 1; // 重置到第一页
                applyMedicinesFilters();
            });
        }

        // 页面跳转
        const pageJumpBtn = document.getElementById('page-jump-btn');
        const pageJumpInput = document.getElementById('page-jump-input');
        if (pageJumpBtn && pageJumpInput) {
            pageJumpBtn.addEventListener('click', function() {
                const targetPage = parseInt(pageJumpInput.value);
                if (targetPage && targetPage >= 1 && targetPage <= totalPages) {
                    changeMedicinesPage(targetPage);
                    pageJumpInput.value = ''; // 清空输入框
                } else {
                    showMessage('请输入有效的页码（1-' + totalPages + '）', 'error');
                }
            });

            // 支持回车键跳转
            pageJumpInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    pageJumpBtn.click();
                }
            });
        }

        // 全选/取消全选
        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.medicine-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const medicineId = checkbox.getAttribute('data-id');
                    if (this.checked) {
                        selectedMedicines.add(medicineId);
                    } else {
                        selectedMedicines.delete(medicineId);
                    }
                });
                updateSelectedCount();
            });
        }

        // 模态框事件 - 修复取消和关闭逻辑
        const cancelBtn = document.getElementById('cancel-medicine');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('点击取消按钮');
                hideMedicineModal();
            });
        }

        const saveBtn = document.getElementById('save-medicine');
        if (saveBtn) {
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                saveMedicine();
            });
        }

        // 图片上传
        const uploadBtn = document.getElementById('upload-image-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('medicine-image').click();
            });
        }

        const imageInput = document.getElementById('medicine-image');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 检查文件大小
                    if (file.size > 2 * 1024 * 1024) {
                        showMessage('图片大小不能超过2MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('medicine-preview').src = e.target.result;
                        document.getElementById('medicine-preview').classList.remove('hidden');
                        document.getElementById('medicine-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 添加第一个药品按钮
        const addFirstBtn = document.getElementById('add-first-medicine');
        if (addFirstBtn) {
            addFirstBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showAddMedicineModal();
            });
        }

        // 添加模态框外部点击关闭功能
        const modal = document.getElementById('medicine-modal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    console.log('点击模态框外部');
                    hideMedicineModal();
                }
            });
        }

        // 防止模态框内部点击事件冒泡
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // 阻止表单默认提交行为
        const medicineForm = document.getElementById('medicine-form');
        if (medicineForm) {
            medicineForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }

        // 添加ESC键关闭功能
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideMedicineModal();
            }
        });

        // 监听到期日期变化动态更新剩余天数
        const expiryInput = document.getElementById('medicine-expiry-date');
        if (expiryInput) {
            expiryInput.addEventListener('change', updateExpiryRemaining);
        }
    }

    // 加载药品数据 - 使用API调用
    async function loadMedicinesData() {
        console.log('开始加载药品数据...');
        showMedicinesLoading();

        try {
            let medicines = [];

            // 优先使用包含库存的接口，避免分页导致的数据不全
            if (window.api?.medicineAPI?.searchWithStock) {
                console.log('使用 searchWithStock 拉取所有页');
                const pageSize = 500; // 大页
                const first = await window.api.medicineAPI.searchWithStock('', '', 1, pageSize);
                let list = first?.data || first?.content || (Array.isArray(first) ? first : []);
                const totalPages = first?.totalPages || first?.total_pages || 1;
                for (let p = 2; p <= totalPages; p++) {
                    try {
                        const resp = await window.api.medicineAPI.searchWithStock('', '', p, pageSize);
                        const pageItems = resp?.data || resp?.content || (Array.isArray(resp) ? resp : []);
                        if (pageItems?.length) list = list.concat(pageItems);
                    } catch (e) { console.warn('拉取第', p, '页失败:', e); }
                }
                medicines = list;
            } else if (window.api?.medicineAPI?.getAll) {
                console.log('后备：使用 getAll');
                const response = await window.api.medicineAPI.getAll();
                medicines = response?.data || response?.content || (Array.isArray(response) ? response : []);
            } else {
                console.log('后备：使用 fetch /api/medicines');
                const response = await fetch('/api/medicines');
                if (response.ok) {
                    const result = await response.json();
                    medicines = result?.data || result;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            }

            if (medicines && medicines.length > 0) {
                console.log(`成功获取 ${medicines.length} 个药品`);
                processMedicinesData(medicines);
            } else {
                console.log('API返回空数组，没有药品数据');
                showMedicinesEmpty();
            }

        } catch (error) {
            console.error('加载药品数据失败:', error);
            showMessage('加载药品数据失败: ' + error.message, 'error');
            showMedicinesEmpty();
        }
    }

    // 处理药品数据
    function processMedicinesData(medicines) {
        console.log('开始处理药品数据，数量:', medicines.length);

        allMedicinesItems = medicines.map(medicine => {
            const statusPersisted = medicine.status || medicine.medicineStatus || (medicine.isRx? 'ACTIVE':'ACTIVE');
            const itm = {
                id: medicine.medicine_id || medicine.medicineId || medicine.id || medicine.approval_no || medicine.approvalNo || 'TMP_' + Math.random().toString(36).slice(2,8),
                name: medicine.trade_name || medicine.tradeName || medicine.generic_name || medicine.genericName || medicine.name || '未知药品',
                genericName: medicine.generic_name || medicine.genericName || '',
                manufacturer: medicine.manufacturer || '未知厂商',
                spec: medicine.spec || medicine.specification || '未知规格',
                approvalNo: medicine.approval_no || medicine.approvalNo || '待录入',
                categoryId: medicine.category_id || medicine.categoryId || null,
                category: getCategoryFromId(medicine.category_id) || medicine.category || 'otc',
                retailPrice: parseFloat(medicine.retail_price || medicine.retailPrice || medicine.price || 0),
                memberPrice: medicine.member_price || medicine.memberPrice ? parseFloat(medicine.member_price || medicine.memberPrice) : null,
                unit: medicine.unit || '盒',
                isRx: Boolean(medicine.is_rx || medicine.isRx || false),
                status: statusPersisted,
                description: medicine.description || '',
                imageUrl: medicine.image_url || medicine.imageUrl || medicine.image || null,
                barcode: medicine.barcode || null,
                productionDate: medicine.production_date || medicine.productionDate || null,
                expiryDate: medicine.expiry_date || medicine.expiryDate || null,
                earliestExpiryDate: medicine.earliestExpiryDate || medicine.earliest_expiry_date || null,
                batchNos: medicine.batchNos || medicine.batches || [],
                stockQuantity: medicine.stockQuantity || medicine.currentStock || null,
                stockStatus: medicine.stockStatus || medicine.stock_status || null,
                expiryStatus: medicine.expiryStatus || medicine.expiry_status || null,
                minStock: (function(){
                    // 如果后端返回批次列表已有 minStock 最小值则前端计算；否则为 null
                    if (Array.isArray(medicine.inventoryList)) {
                        const mins = medicine.inventoryList.map(i=>i.minStock||i.safetyStock).filter(v=>v!=null && v>0);
                        return mins.length? Math.min(...mins): null;
                    }
                    return medicine.minStock || medicine.safetyStock || null;
                })()
            };
            itm.computedStatus = computeDynamicStatus(itm);
            return itm;
        });

        console.log('所有药品数据(扩展字段后):', allMedicinesItems);

        updateMedicinesSummary();
        currentMedicinesPage = 1;
        applyMedicinesFilters();
    }

    // 根据分类ID获取分类名称
    function getCategoryFromId(categoryId) {
        const categoryMap = {
            1: 'otc',      // 非处方药
            2: 'prescription', // 处方药
            3: 'prescription',
            4: 'otc',
            5: 'chinese',
            6: 'otc'
        };
        return categoryMap[Number(categoryId)] || 'otc';
    }

    // 更新药品统计
    function updateMedicinesSummary() {
        console.log('更新药品统计，总药品数:', allMedicinesItems.length);

        if (!allMedicinesItems || allMedicinesItems.length === 0) {
            updateMedicinesSummaryCards({
                totalMedicines: 0,
                totalMedicinesChange: 0,
                prescriptionCount: 0,
                prescriptionChange: 0,
                otcCount: 0,
                otcChange: 0,
                chineseCount: 0,
                chineseChange: 0
            });
            return;
        }

        const totalMedicines = allMedicinesItems.length;

        // 计算各类药品数量
        const prescriptionCount = allMedicinesItems.filter(item => item.category === 'prescription').length;
        const otcCount = allMedicinesItems.filter(item => item.category === 'otc').length;
        const chineseCount = allMedicinesItems.filter(item => item.category === 'chinese').length;

        console.log('分类统计 - 处方药:', prescriptionCount, '非处方药:', otcCount, '中药:', chineseCount);

        // 模拟变化数据
        const mockStatsData = {
            totalMedicines: totalMedicines,
            totalMedicinesChange: Math.floor(Math.random() * 10),
            prescriptionCount: prescriptionCount,
            prescriptionChange: Math.floor(Math.random() * 5),
            otcCount: otcCount,
            otcChange: Math.floor(Math.random() * 5),
            chineseCount: chineseCount,
            chineseChange: Math.floor(Math.random() * 5)
        };

        updateMedicinesSummaryCards(mockStatsData);
    }

    // 更新药品统计卡片数据
    function updateMedicinesSummaryCards(data) {
        if (!data) return;

        console.log('更新药品统计卡片数据:', data);

        // 总药品数
        const totalMedicinesEl = document.getElementById('total-medicines');
        if (totalMedicinesEl) totalMedicinesEl.textContent = `${data.totalMedicines || 0} 种`;

        // 总药品数变化
        const totalMedicinesChangeEl = document.getElementById('total-medicines-change');
        if (totalMedicinesChangeEl) {
            const isPositive = (data.totalMedicinesChange || 0) >= 0;
            totalMedicinesChangeEl.innerHTML = `
                <i class="fa fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                ${Math.abs(data.totalMedicinesChange || 0)} 种
            `;
            totalMedicinesChangeEl.className = isPositive ?
                'text-secondary flex items-center' :
                'text-accent flex items-center';
        }

        // 处方药数量
        const prescriptionCountEl = document.getElementById('prescription-count');
        if (prescriptionCountEl) prescriptionCountEl.textContent = `${data.prescriptionCount || 0} 种`;

        // 处方药变化
        const prescriptionChangeEl = document.getElementById('prescription-change');
        if (prescriptionChangeEl) {
            const isPositive = (data.prescriptionChange || 0) >= 0;
            prescriptionChangeEl.innerHTML = `
                <i class="fa fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                ${Math.abs(data.prescriptionChange || 0)} 种
            `;
            prescriptionChangeEl.className = isPositive ?
                'text-secondary flex items-center' :
                'text-accent flex items-center';
        }

        // 非处方药数量
        const otcCountEl = document.getElementById('otc-count');
        if (otcCountEl) otcCountEl.textContent = `${data.otcCount || 0} 种`;

        // 非处方药变化
        const otcChangeEl = document.getElementById('otc-change');
        if (otcChangeEl) {
            const isPositive = (data.otcChange || 0) >= 0;
            otcChangeEl.innerHTML = `
                <i class="fa fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                ${Math.abs(data.otcChange || 0)} 种
            `;
            otcChangeEl.className = isPositive ?
                'text-secondary flex items-center' :
                'text-accent flex items-center';
        }

        // 中药数量
        const chineseCountEl = document.getElementById('chinese-count');
        if (chineseCountEl) chineseCountEl.textContent = `${data.chineseCount || 0} 种`;

        // 中药变化
        const chineseChangeEl = document.getElementById('chinese-change');
        if (chineseChangeEl) {
            const isPositive = (data.chineseChange || 0) >= 0;
            chineseChangeEl.innerHTML = `
                <i class="fa fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                ${Math.abs(data.chineseChange || 0)} 种
            `;
            chineseChangeEl.className = isPositive ?
                'text-secondary flex items-center' :
                'text-accent flex items-center';
        }

        const inStockEl = document.getElementById('in-stock-medicines');
        if (inStockEl) {
            inStockEl.textContent = `在库药品数：${inStockMedicineIds.size} 种`;
        }
    }

    // 导出药品数据函数缺失补充
    async function exportMedicinesData() {
        try {
            const button = document.getElementById('export-medicines');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 导出中...';
            }
            // 选择当前筛选后的数据进行导出
            const data = filteredMedicinesItems.length ? filteredMedicinesItems : allMedicinesItems;
            let csv = '\uFEFF药品名称,通用名,规格,单位,批准文号,生产厂家,分类,零售价,会员价,是否处方药,状态,条形码,生产日期,到期日期\n';
            const esc = v => {
                if (v === null || v === undefined) return '';
                const s = String(v);
                return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
            };
            data.forEach(item => {
                csv += [
                    esc(item.name),
                    esc(item.genericName),
                    esc(item.spec),
                    esc(item.unit),
                    esc(item.approvalNo),
                    esc(item.manufacturer),
                    esc(item.category),
                    item.retailPrice ?? '',
                    item.memberPrice ?? '',
                    item.isRx ? '是' : '否',
                    getStatusDisplayInfo(item.status).text,
                    esc(item.barcode || ''),
                    esc(item.productionDate || ''),
                    esc(item.expiryDate || '')
                ].join(',') + '\n';
            });
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
            a.download = '药品档案导出_'+ts+'.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            setTimeout(()=>URL.revokeObjectURL(url),200);
            showMessage('导出成功，共 '+data.length+' 条','success');
        } catch (e) {
            console.error('导出失败', e);
            showMessage('导出失败: '+e.message,'error');
        } finally {
            const button = document.getElementById('export-medicines');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fa fa-download"></i> 导出药品';
            }
        }
    }

    // 应用药品筛选
    function applyMedicinesFilters() {
        console.log('=== 应用药品筛选条件 ===');
        console.log('总药品数:', allMedicinesItems.length);

        if (allMedicinesItems.length === 0) {
            console.log('没有药品数据可筛选');
            showMedicinesEmpty();
            return;
        }

        const filters = getMedicinesFilters();
        console.log('药品筛选条件:', filters);

        filteredMedicinesItems = [...allMedicinesItems];

        // 药品名称筛选
        if (filters.medicineName) {
            const searchTerm = filters.medicineName.toLowerCase();
            filteredMedicinesItems = filteredMedicinesItems.filter(item => {
                const name = item.name || '';
                const genericName = item.genericName || '';
                return name.toLowerCase().includes(searchTerm) || genericName.toLowerCase().includes(searchTerm);
            });
        }

        // 分类筛选
        if (filters.category) {
            filteredMedicinesItems = filteredMedicinesItems.filter(item => {
                const category = item.category || '';
                return category === filters.category;
            });
        }

        // 状态筛选
        if (filters.status) {
            filteredMedicinesItems = filteredMedicinesItems.filter(item => {
                const status = item.status || '';
                return status === filters.status;
            });
        }

        // 生产厂家筛选
        if (filters.manufacturer) {
            const searchTerm = filters.manufacturer.toLowerCase();
            filteredMedicinesItems = filteredMedicinesItems.filter(item => {
                const manufacturer = item.manufacturer || '';
                return manufacturer.toLowerCase().includes(searchTerm);
            });
        }

        console.log('筛选后药品数量:', filteredMedicinesItems.length);
        displayFilteredMedicinesItems();
    }

    // 获取药品筛选条件
    function getMedicinesFilters() {
        return {
            medicineName: document.getElementById('medicine-name-filter').value,
            category: document.getElementById('category-filter').value,
            status: document.getElementById('status-filter').value,
            manufacturer: document.getElementById('manufacturer-filter').value
        };
    }

    // 显示筛选后的药品项目
    function displayFilteredMedicinesItems() {
        const startIndex = (currentMedicinesPage - 1) * medicinesPageSize;
        const endIndex = startIndex + medicinesPageSize;
        const pagedItems = filteredMedicinesItems.slice(startIndex, endIndex);

        console.log('分页后药品项目:', pagedItems);
        displayMedicinesItems(pagedItems);
        updateMedicinesPagination(filteredMedicinesItems.length);
    }

    // 显示药品加载状态
    function showMedicinesLoading() {
        document.getElementById('medicines-list-body').classList.add('hidden');
        document.getElementById('loading-medicines').classList.remove('hidden');
        document.getElementById('empty-medicines').classList.add('hidden');
    }

    // 显示药品空状态
    function showMedicinesEmpty() {
        document.getElementById('medicines-list-body').classList.add('hidden');
        document.getElementById('loading-medicines').classList.add('hidden');
        document.getElementById('empty-medicines').classList.remove('hidden');
        document.getElementById('medicines-total-text').textContent = '共 0 种药品';
        document.getElementById('medicines-range-text').textContent = '显示 0-0 条，共 0 条';
        document.getElementById('medicines-pagination-controls').innerHTML = '';
    }

    // 显示药品数据
    function displayMedicinesItems(items) {
        const tbody = document.getElementById('medicines-list-body');

        console.log('要显示的药品数据:', items);

        if (!items || items.length === 0) {
            console.log('没有药品数据，显示空状态');
            showMedicinesEmpty();
            return;
        }

        document.getElementById('loading-medicines').classList.add('hidden');
        document.getElementById('empty-medicines').classList.add('hidden');
        tbody.classList.remove('hidden');

        const html = items.map(item => {
            const batchesLine = item.batchNos && item.batchNos.length ? `<div class=\"text-xs text-gray-500\">批号: ${item.batchNos.slice(0,3).join(', ')}${item.batchNos.length>3?'…':''}</div>` : '';
            const statusHtml = formatStatusBadges(item.status, item.computedStatus);
            return `
                <tr class=\"hover:bg-gray-50 transition-colors\" data-id="${item.id}">
                    <td class=\"px-6 py-4 whitespace-nowrap\">
                        <input type=\"checkbox\" aria-label=\"选择药品\" class=\"medicine-checkbox rounded border-gray-300\" data-id=\"${item.id}\">
                    </td>
                    <td class=\"px-6 py-4 whitespace-nowrap\">
                        <div class=\"flex items-center\">
                            <img src=\"${item.imageUrl || 'https://picsum.photos/40/40?random=' + Math.floor(Math.random() * 100)}\" alt=\"药品图片\" class=\"w-10 h-10 mr-3 rounded\">
                            <div>
                                <div class=\"text-sm font-medium\">${item.name}</div>
                                <div class=\"text-xs text-gray-500\">${item.genericName || ''}</div>
                                <div class=\"text-xs text-gray-500\">${item.manufacturer}</div>
                                <div class=\"text-xs text-gray-500\">${item.spec} ${item.unit}</div>
                                ${batchesLine}
                            </div>
                        </div>
                    </td>
                    <td class=\"px-6 py-4 whitespace-nowrap text-sm\">${item.approvalNo}</td>
                    <td class=\"px-6 py-4 whitespace-nowrap\">
                        <span class=\"medicine-indicator ${item.isRx ? 'medicine-prescription' : 'medicine-otc'}\">${item.isRx ? '处方药' : '非处方药'}</span>
                    </td>
                    <td class=\"px-6 py-4 whitespace-nowrap text-sm\">¥${item.retailPrice.toFixed(2)}</td>
                    <td class=\"px-6 py-4 whitespace-nowrap text-sm\">${item.memberPrice ? '¥' + item.memberPrice.toFixed(2) : '-'}</td>
                    <td class=\"px-6 py-4 whitespace-nowrap\">${statusHtml}</td>
                    <td class=\"px-6 py-4 whitespace-nowrap text-sm\">
                        <button class=\"text-primary hover:underline mr-3\" onclick=\"viewMedicineDetail('${item.id}')\">详情</button>
                        <button class=\"text-secondary hover:underline mr-3\" onclick=\"editMedicine('${item.id}')\">编辑</button>
                        <button class=\"text-accent hover:underline\" onclick=\"deleteMedicine('${item.id}')\">删除</button>
                    </td>
                </tr>`;
        }).join('');

        tbody.innerHTML = html;

        // 绑定复选框事件
        const checkboxes = document.querySelectorAll('.medicine-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const medicineId = this.getAttribute('data-id');
                if (this.checked) {
                    selectedMedicines.add(medicineId);
                } else {
                    selectedMedicines.delete(medicineId);
                    // 取消全选
                    document.getElementById('select-all').checked = false;
                }
                updateSelectedCount();
            });
        });
    }

    // 获取分类显示信息
    function getCategoryDisplayInfo(category) {
        switch(category) {
            case 'prescription':
                return { text: '处方药', class: 'medicine-prescription' };
            case 'otc':
                return { text: '非处方药', class: 'medicine-otc' };
            case 'chinese':
                return { text: '中药', class: 'medicine-active' };
            default:
                return { text: '未知', class: 'medicine-inactive' };
        }
    }

    // 获取状态显示信息
    function getStatusDisplayInfo(status) {
        switch(status) {
            case 'ACTIVE':
            case 'active':
                return { text: '在售', class: 'medicine-active' };
            case 'INACTIVE':
            case 'inactive':
                return { text: '停售', class: 'medicine-inactive' };
            case 'NEAR_EXPIRY':
                return { text: '近效期', class: 'medicine-near-expiry' };
            case 'EXPIRED':
                return { text: '过期', class: 'medicine-expired' };
            case 'OUT_OF_STOCK':
            case 'OUT':
                return { text: '缺货', class: 'medicine-out' };
            default:
                return { text: '未知', class: 'medicine-inactive' };
        }
    }

    // 更新药品分页信息
    function updateMedicinesPagination(total) {
        totalMedicinesItems = total;
        totalPages = Math.ceil(total / medicinesPageSize);

        const startItem = ((currentMedicinesPage - 1) * medicinesPageSize) + 1;
        const endItem = Math.min(currentMedicinesPage * medicinesPageSize, total);

        document.getElementById('medicines-total-text').textContent = `共 ${total} 种药品`;
        document.getElementById('medicines-range-text').textContent =
            `显示 ${startItem}-${endItem} 条，共 ${total} 条`;

        updateMedicinesPaginationControls();
    }

    // 更新药品分页控件
    function updateMedicinesPaginationControls() {
        const container = document.getElementById('medicines-pagination-controls');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        // 上一页按钮
        if (currentMedicinesPage > 1) {
            html += `
                <button class="pagination-btn" onclick="changeMedicinesPage(${currentMedicinesPage - 1})">
                    <i class="fa fa-chevron-left text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="pagination-btn disabled" disabled>
                    <i class="fa fa-chevron-left text-xs"></i>
                </button>
            `;
        }

        // 页码按钮 - 显示最多7个页码
        const startPage = Math.max(1, currentMedicinesPage - 3);
        const endPage = Math.min(totalPages, startPage + 6);

        // 显示第一页和省略号（如果需要）
        if (startPage > 1) {
            html += `
                <button class="pagination-btn" onclick="changeMedicinesPage(1)">1</button>
            `;
            if (startPage > 2) {
                html += `<span class="px-2">...</span>`;
            }
        }

        // 显示页码范围
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentMedicinesPage) {
                html += `
                    <button class="pagination-btn active">${i}</button>
                `;
            } else {
                html += `
                    <button class="pagination-btn" onclick="changeMedicinesPage(${i})">${i}</button>
                `;
            }
        }

        // 显示最后一页和省略号（如果需要）
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<span class="px-2">...</span>`;
            }
            html += `
                <button class="pagination-btn" onclick="changeMedicinesPage(${totalPages})">${totalPages}</button>
            `;
        }

        // 下一页按钮
        if (currentMedicinesPage < totalPages) {
            html += `
                <button class="pagination-btn" onclick="changeMedicinesPage(${currentMedicinesPage + 1})">
                    <i class="fa fa-chevron-right text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="pagination-btn disabled" disabled>
                    <i class="fa fa-chevron-right text-xs"></i>
                </button>
            `;
        }

        container.innerHTML = html;
    }

    // 切换药品页面
    function changeMedicinesPage(page) {
        console.log('切换药品页面到:', page);

        if (page < 1 || page > totalPages) {
            console.log('无效的页码:', page);
            return;
        }

        currentMedicinesPage = page;
        displayFilteredMedicinesItems();

        // 滚动到表格顶部
        const table = document.querySelector('.card table');
        if (table) {
            table.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // 批量操作：显示操作菜单并执行
    function showBatchOperations() {
        if (selectedMedicines.size === 0) {
            showMessage('请先选择要操作的药品', 'warning');
            return;
        }
        const action = prompt(`已选择 ${selectedMedicines.size} 个药品，请选择操作：\n1. 批量在售\n2. 批量停售\n3. 批量删除`, '1');
        switch(action) {
            case '1':
                batchUpdateStatus('active');
                break;
            case '2':
                batchUpdateStatus('inactive');
                break;
            case '3':
                if (confirm(`确定要删除选中的 ${selectedMedicines.size} 个药品吗？此操作不可恢复。`)) {
                    batchDelete();
                }
                break;
            default:
                // 用户取消或输入无效
                return;
        }
    }

    // 批量更新状态
    function batchUpdateStatus(status) {
        let count = 0;
        allMedicinesItems = allMedicinesItems.map(item => {
            if (selectedMedicines.has(item.id)) {
                count++;
                return { ...item, status };
            }
            return item;
        });
        updateMedicinesSummary();
        applyMedicinesFilters();
        showMessage(`已成功更新 ${count} 个药品的状态`, 'success');
        selectedMedicines.clear();
        updateSelectedCount();
    }

    // 批量删除
    function batchDelete() {
        const count = selectedMedicines.size;
        allMedicinesItems = allMedicinesItems.filter(item => !selectedMedicines.has(item.id));
        updateMedicinesSummary();
        applyMedicinesFilters();
        showMessage(`已成功删除 ${count} 个药品`, 'success');
        selectedMedicines.clear();
        updateSelectedCount();
    }

    // 更新批量按钮的选中数量显示
    function updateSelectedCount() {
        const batchBtn = document.getElementById('batch-operate-btn');
        if (!batchBtn) return;
        if (selectedMedicines.size > 0) {
            batchBtn.innerHTML = `<i class="fa fa-cogs"></i> 批量操作 (${selectedMedicines.size})`;
        } else {
            batchBtn.innerHTML = `<i class="fa fa-cogs"></i> 批量操作`;
        }
    }

    // 保存药品
    async function saveMedicine() {
        const form = document.getElementById('medicine-form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        const id = document.getElementById('medicine-id').value;
        const name = document.getElementById('medicine-name').value;
        // 前端校验批准文号非空
        const rawApproval = document.getElementById('medicine-approval-no').value || '';
        const trimmedApproval = rawApproval.trim();
        if (!trimmedApproval) {
            showMessage('批准文号不能为空，请填写后再保存', 'error');
            return;
        }
        const payload = {
            medicineId: id || undefined,
            tradeName: name,
            genericName: document.getElementById('medicine-generic-name').value || name,
            spec: document.getElementById('medicine-spec').value,
            unit: document.getElementById('medicine-unit').value,
            approvalNo: trimmedApproval,
            manufacturer: document.getElementById('medicine-manufacturer').value,
            categoryId: (function() {
                const v = document.getElementById('medicine-category').value;
                if (v === 'otc') return 1;
                if (v === 'prescription') return 2;
                if (v === 'chinese') return 5;
                return 1;
            })(),
            retailPrice: parseFloat(document.getElementById('medicine-retail-price').value),
            memberPrice: document.getElementById('medicine-member-price').value ? parseFloat(document.getElementById('medicine-member-price').value) : null,
            isRx: document.getElementById('medicine-is-rx').checked,
            description: document.getElementById('medicine-description').value,
            barcode: document.getElementById('medicine-barcode').value || null,
            productionDate: (function(){ const v=document.getElementById('medicine-production-date').value; return v? v: null; })(),
            expiryDate: (function(){ const v=document.getElementById('medicine-expiry-date').value; return v? v: null; })(),
            status: document.getElementById('medicine-status').value?.toUpperCase()==='INACTIVE'?'INACTIVE':'ACTIVE'
        };

        console.log('准备提交药品实体:', payload);

        try {
            if (id) {
                const resp = await fetch(`/api/medicines/${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                if(!resp.ok){
                    let raw='';
                    try { raw = await resp.text(); } catch(_){}
                    let errMsg = `更新失败: ${resp.status}`;
                    if(raw){
                        // 尝试解析 JSON
                        try { const j = JSON.parse(raw); if(j && j.message) errMsg = j.message; else if(j.error) errMsg = j.error; }
                        catch{ errMsg = raw.length>300? raw.slice(0,300)+'...' : raw; }
                    }
                    highlightError(errMsg);
                    throw new Error(errMsg);
                }
                const respJson = await resp.json();
                const updatedEntity = respJson.data ? respJson.data : respJson;
                const statusRaw = respJson.medicineStatus || updatedEntity.status;
                const computed = respJson.computedStatus || respJson.expiryStatus;
                const idx = allMedicinesItems.findIndex(x=>x.id===id);
                if(idx!==-1){
                    const prev = allMedicinesItems[idx];
                    allMedicinesItems[idx] = { ...prev,
                        id: updatedEntity.medicineId,
                        name: updatedEntity.tradeName || updatedEntity.genericName,
                        genericName: updatedEntity.genericName,
                        manufacturer: updatedEntity.manufacturer,
                        spec: updatedEntity.spec,
                        approvalNo: updatedEntity.approvalNo,
                        categoryId: updatedEntity.categoryId,
                        category: getCategoryFromId(updatedEntity.categoryId),
                        retailPrice: parseFloat(updatedEntity.retailPrice ?? 0),
                        memberPrice: updatedEntity.memberPrice ? parseFloat(updatedEntity.memberPrice) : null,
                        unit: updatedEntity.unit,
                        isRx: !!updatedEntity.isRx,
                        description: updatedEntity.description || '',
                        barcode: updatedEntity.barcode || null,
                        productionDate: updatedEntity.productionDate || null,
                        expiryDate: updatedEntity.expiryDate || null,
                        status: mapMedicineStatus(statusRaw),
                        computedStatus: computed // 保存动态状态
                    };
                }
            } else {
                const resp = await fetch('/api/medicines', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!resp.ok){
                    let raw='';
                    try { raw = await resp.text(); } catch(_){}
                    let errMsg = `新增失败: ${resp.status}`;
                    if(raw){
                        try { const j = JSON.parse(raw); if(j && j.message) errMsg = j.message; else if(j.error) errMsg = j.error; }
                        catch{ errMsg = raw.length>300? raw.slice(0,300)+'...' : raw; }
                    }
                    highlightError(errMsg);
                    throw new Error(errMsg);
                }
                const created = await resp.json();
                allMedicinesItems.unshift({
                    id: created.medicineId,
                    name: created.tradeName || created.genericName,
                    genericName: created.genericName,
                    manufacturer: created.manufacturer,
                    spec: created.spec,
                    approvalNo: created.approvalNo,
                    categoryId: created.categoryId,
                    category: getCategoryFromId(created.categoryId),
                    retailPrice: parseFloat(created.retailPrice ?? 0),
                    memberPrice: created.memberPrice ? parseFloat(created.memberPrice) : null,
                    unit: created.unit,
                    isRx: !!created.isRx,
                    description: created.description || '',
                    barcode: created.barcode || null,
                    productionDate: created.productionDate || null,
                    expiryDate: created.expiryDate || null,
                });
            }
            updateMedicinesSummary();
            applyMedicinesFilters();
            hideMedicineModal();
            showMessage('药品保存成功', 'success');
        } catch (err) {
            console.error('保存药品失败:', err);
            showMessage('保存药品失败: ' + err.message, 'error');
        }
    }

    function highlightError(errMsg){
        // 移除旧的高亮
        ['medicine-approval-no','medicine-retail-price','medicine-name','medicine-spec'].forEach(id=>{
            const el=document.getElementById(id); if(el){ el.classList.remove('border-red-500','ring-2','ring-red-300'); }
        });
        // 根据错误内容高亮对应字段
        if(/批准文号|approval/i.test(errMsg)){
            const el=document.getElementById('medicine-approval-no');
            if(el){ el.classList.add('border-red-500','ring-2','ring-red-300'); el.focus(); }
        }
        if(/价格|price/i.test(errMsg)){
            const el=document.getElementById('medicine-retail-price');
            if(el){ el.classList.add('border-red-500','ring-2','ring-red-300'); }
        }
        if(/规格|spec/i.test(errMsg)){
            const el=document.getElementById('medicine-spec');
            if(el){ el.classList.add('border-red-500','ring-2','ring-red-300'); }
        }
        if(/名称|tradeName|genericName/i.test(errMsg)){
            const el=document.getElementById('medicine-name');
            if(el){ el.classList.add('border-red-500','ring-2','ring-red-300'); }
        }
    }

    // === 为表单标签添加 for 属性（可访问性改进）===
    ;['medicine-name','medicine-generic-name','medicine-spec','medicine-unit','medicine-approval-no','medicine-manufacturer','medicine-category','medicine-retail-price','medicine-member-price','medicine-status','medicine-barcode','medicine-production-date','medicine-expiry-date','medicine-description'].forEach(id=>{
        const input=document.getElementById(id);
        if(input){
            // 找到其上方直接前一个 label
            const label = input.closest('div')?.querySelector('label');
            if(label){ label.setAttribute('for', id); }
        }
    });

    // 在批量操作按钮附近插入“显示已删除”选项（运行时兜底）
    document.addEventListener('DOMContentLoaded',()=>{const actions=document.querySelector('.flex.gap-3');if(actions&&!document.getElementById('show-deleted-toggle')){const wrap=document.createElement('label');wrap.className='inline-flex items-center text-sm text-gray-600';wrap.innerHTML='<input type="checkbox" id="show-deleted-toggle" class="rounded border-gray-300 mr-2">显示已删除';actions.appendChild(wrap);document.getElementById('show-deleted-toggle').addEventListener('change',applyMedicinesFilters);} });

    // 恢复功能按钮添加：在 displayMedicinesItems 里，若 item.status==='inactive' 或 item.deleted===true，显示恢复按钮
    const _origDisplayMedicinesItems=displayMedicinesItems;displayMedicinesItems=function(items){_origDisplayMedicinesItems(items);try{items.forEach(it=>{if(it.deleted||it.status==='inactive'){const row=document.querySelector(`tr[data-id='${it.id}'] td:last-child`);if(row&&!row.querySelector('.restore-btn')){const btn=document.createElement('button');btn.className='text-green-600 hover:underline ml-2 restore-btn';btn.textContent='恢复';btn.onclick=()=>restoreMedicine(it.id);row.appendChild(btn);} } });}catch(e){console.warn('添加恢复按钮失败',e);} };

    async function restoreMedicine(id){
        try{
            const resp=await fetch('/api/medicines/'+encodeURIComponent(id)+'/restore',{method:'POST'});
            const json=await resp.json().catch(()=>({code:resp.status,message:'解析失败'}));
            if(!resp.ok||json.code!==200){showMessage('恢复失败: '+(json.message||resp.status),'error');return;}
            const data=json.data||{};
            const idx=allMedicinesItems.findIndex(m=>m.id===id);
            if(idx!==-1){allMedicinesItems[idx].status='active';allMedicinesItems[idx].deleted=false;}
            applyMedicinesFilters();
            showMessage('恢复成功','success');
        }catch(e){showMessage('恢复异常: '+e.message,'error');}
    }

    // 在 processMedicinesData 中补充 deleted 字段处理
    const _origProcessMedicinesData=processMedicinesData;processMedicinesData=function(medicines){_origProcessMedicinesData(medicines);allMedicinesItems=allMedicinesItems.map(it=>({...it,deleted:it.deleted||false}));applyMedicinesFilters();};

    // 修改 applyMedicinesFilters 支持 show-deleted-toggle
    const _origApplyMedicinesFilters=applyMedicinesFilters;applyMedicinesFilters=function(){_origApplyMedicinesFilters();const showDeleted=document.getElementById('show-deleted-toggle');if(showDeleted&&showDeleted.checked){filteredMedicinesItems=allMedicinesItems.slice();}else{filteredMedicinesItems=filteredMedicinesItems.filter(it=>!it.deleted);}changeMedicinesPage(1);};
</script>
</body>
</html>
